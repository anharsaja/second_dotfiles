var Vs=Object.defineProperty;var Js=(t,n,e)=>n in t?Vs(t,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[n]=e;var a=(t,n,e)=>Js(t,typeof n!="symbol"?n+"":n,e);import{s as Hs,m as Y,k as cn,A as ln,b as I,g as Wi,o as Gi,a as Yi,_ as Ws,c as Gs,d as Ys,i as Zs,e as Xs,p as Qs,f as eo,h as Be,j as Dn,u as ne,l as Zi,n as Bt,q as to,r as Cn,t as no,v as io,w as ro,E as Xi,x as Mn,W as so,y as oo,P as ao,z as co}from"./chunks/_virtual_wxt-plugins-DckzYsD-.js";import{_ as lo}from"./chunks/_baseRandom-C4i3oSs_.js";import{i as uo}from"./chunks/initSentry-BeWilyCh.js";function ho(t){return t==null||typeof t=="function"?{main:t}:t}const Pn=Hs.defineItem("local:featureFlags",{version:1,fallback:{}});class un{constructor(){a(this,"logger",Y.extend("FeatureFlagManager"))}async fetch(){this.logger("Fetching feature flags");try{const n=await cn.get(`https://${ln}/v5/feature-flags`).json();await this.save(n)}catch(n){this.logger("Failed to fetch feature flags",n)}}async get(n){return this.logger("Getting feature flag",n),(await this.load())[n]||!1}async list(){return this.logger("Listing feature flags"),await this.load()}async save(n){this.logger("Saving feature flags",n),await Pn.setValue(n)}async load(){return await Pn.getValue()}startPolling(n=30*60*1e3){this.logger("Starting feature flag polling"),this.fetch(),setInterval(this.fetch.bind(this),n)}}class po{constructor(){a(this,"log",Y.extend("SessionKeepAlive"));a(this,"token");a(this,"session");a(this,"timeout");a(this,"featureFlags",new un);a(this,"shouldRun",!1);a(this,"version",I.runtime.getManifest().version);a(this,"scienceId","")}async init(n=!1){if(!await this.featureFlags.get("SessionKeepAlive")||(this.scienceId=await Wi(),this.timeout&&clearTimeout(this.timeout),!n&&this.shouldRun))return;this.shouldRun||this.log("Initialized"),this.shouldRun=!0;const e=await Gi.getValue();e&&"token"in e&&this.setToken(e.token);const i=await Yi.getValue();i?this.setSession(i.token):this.send()}close(){this.timeout&&clearTimeout(this.timeout),this.shouldRun=!1,this.log("Closed")}setToken(n){this.token=n}setSession(n){this.session=n,this.send()}async send(){if(!(!this.token||!this.session||!this.shouldRun||!await this.featureFlags.get("SessionKeepAlive"))){this.timeout&&clearTimeout(this.timeout);try{const n=await cn.post(`https://${ln}/v5/session-keep-alive`,{headers:{"x-token":this.token,"x-session":this.session,"x-science-id":this.scienceId,"x-version":this.version}}).json();if(this.log(n.message),!n.nextUpdate)return;this.timeout=setTimeout(()=>this.send(),n.nextUpdate)}catch{}}}}var fo=lo;function mo(t){var n=t.length;return n?t[fo(0,n-1)]:void 0}var Qi=mo,go=Ws;function yo(t,n){return go(n,function(e){return t[e]})}var bo=yo,vo=bo,wo=Gs;function $o(t){return t==null?[]:vo(t,wo(t))}var ko=$o,xo=Qi,Ao=ko;function So(t){return xo(Ao(t))}var Io=So,To=Qi,Eo=Io,No=Zs;function Oo(t){var n=No(t)?To:Eo;return n(t)}var Ro=Oo;const Do=Ys(Ro),Bn=new Map,er=/^data:image\/(png|jpeg|jpg|gif|webp);base64,/,Co=256,Ln="https://pd.premid.app/create";async function Nt(t){const n=Y.extend("URLShortener");if(!t||t.length<=Co&&!er.test(t))return t;const e=Bn.get(t);if(e)return e;try{const i=await Mo(t);return n(`Shortened ${t} to ${i}`),Bn.set(t,i),i}catch(i){return n(`Error shortening URL: ${i}`),t}}async function Mo(t){const n=er.test(t),e=n?`${Ln}/base64`:`${Ln}/${t}`;return await cn(e,{method:n?"POST":"GET",body:n?t:void 0}).text()}const yt=t=>Array.isArray(t)?t:[t],Po=(t,n)=>{const e=[[],[]];for(const i of t)n(i)?e[0].push(i):e[1].push(i);return e},Bo=Array,oe=(t,n)=>t.includes(n),B=(t,n,e)=>t===void 0?n===void 0?[]:Array.isArray(n)?n:[n]:(Array.isArray(n)?t.push(...n):t.push(n),t),Lt=(t,n)=>n==null?t??[]:t==null?yt(n):t.concat(n),me=(t,n,e)=>{if(t===void 0)return Array.isArray(n)?n:[n];const i=(e==null?void 0:e.isEqual)??((r,s)=>r===s);return yt(n).forEach(r=>{t.some(s=>i(s,r))||t.push(r)}),t},tr=(t,n)=>t.reduce((e,i)=>{const r=i[n];return e[r]=B(e[r],i),e},{}),et=(t,n,e)=>t.length===n.length&&t.every(e!=null&&e.isEqual?(i,r)=>e.isEqual(i,n[r]):(i,r)=>i===n[r]),Ee=(t,n)=>Z(t)===n,Z=t=>{const n=typeof t;return n==="object"?t===null?"null":"object":n==="function"?"object":n},ie={boolean:"boolean",null:"null",undefined:"undefined",bigint:"a bigint",number:"a number",object:"an object",string:"a string",symbol:"a symbol"},Lo={...ie,function:"a function"},T=(t,n)=>{var s;const e=Array.isArray(t),i=Object.entries(t).flatMap((o,c)=>{const l=e?n(c,o[1]):n(...o,c);return Array.isArray(l[0])||l.length===0?l:[l]}),r=Object.fromEntries(i);return typeof((s=i[0])==null?void 0:s[0])=="number"?Object.values(r):r},nr=t=>Object.entries(t),X=(t,n)=>t in n;class qo{constructor(n){Object.assign(this,n)}}const Ko=class{};class ir extends Ko{}const _o=(t,n)=>{const e={},i={};let r;for(r in t)r in n?e[r]=t[r]:i[r]=t[r];return[e,i]},Uo=(t,n)=>_o(t,n)[1],Se=t=>Object.keys(t).length===0,qt=t=>[...Object.entries(t),...Object.getOwnPropertySymbols(t).map(n=>[n,t[n]])],Fo=(t,n)=>Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)),tt=Symbol("represents an uninitialized value"),rr={Array,Boolean,Date,Error,Function,Map,Number,Promise,RegExp,Set,String,WeakMap,WeakSet},sr=globalThis.File??Blob,or={ArrayBuffer,Blob,File:sr,FormData,Headers,Request,Response,URL},zo={Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,BigInt64Array,BigUint64Array},ge={...rr,...or,...zo,String,Number,Boolean},hn=t=>{var i;let n=Object.getPrototypeOf(t);for(;n!=null&&n.constructor&&(!X(n.constructor.name,ge)||!(t instanceof ge[n.constructor.name]));)n=Object.getPrototypeOf(n);const e=(i=n==null?void 0:n.constructor)==null?void 0:i.name;if(!(e===void 0||e==="Object"))return e},Kt=t=>typeof t=="object"&&t!==null?hn(t)??"object":Z(t),j=t=>Array.isArray(t),jo={Array:"an array",Function:"a function",Date:"a Date",RegExp:"a RegExp",Error:"an Error",Map:"a Map",Set:"a Set",String:"a String object",Number:"a Number object",Boolean:"a Boolean object",Promise:"a Promise",WeakMap:"a WeakMap",WeakSet:"a WeakSet"},Vo={ArrayBuffer:"an ArrayBuffer instance",Blob:"a Blob instance",File:"a File instance",FormData:"a FormData instance",Headers:"a Headers instance",Request:"a Request instance",Response:"a Response instance",URL:"a URL instance"},Jo={Int8Array:"an Int8Array",Uint8Array:"a Uint8Array",Uint8ClampedArray:"a Uint8ClampedArray",Int16Array:"an Int16Array",Uint16Array:"a Uint16Array",Int32Array:"an Int32Array",Uint32Array:"a Uint32Array",Float32Array:"a Float32Array",Float64Array:"a Float64Array",BigInt64Array:"a BigInt64Array",BigUint64Array:"a BigUint64Array"},Ho={...jo,...Vo,...Jo},dn=t=>{const n=Object(t).name??null;return n&&X(n,ge)&&ge[n]===t?n:null},qn=(t,n)=>{let e=t.prototype;for(;e!==null;){if(e===n.prototype)return!0;e=Object.getPrototypeOf(e)}return!1},Wo=t=>ar(t,new Map),ar=(t,n)=>{if(typeof t!="object"||t===null)return t;if(n!=null&&n.has(t))return n.get(t);const e=dn(t.constructor);if(e==="Date")return new Date(t.getTime());if(e&&e!=="Array")return t;const i=Array.isArray(t)?t.slice():Object.create(Object.getPrototypeOf(t)),r=Object.getOwnPropertyDescriptors(t);if(n){n.set(t,i);for(const s in r)r[s].value=ar(r[s].value,n)}return Object.defineProperties(i,r),i};class Go extends Error{}const L=t=>he(t,Go),he=(t,n=Error)=>{throw new n(t)};class Yo extends Error{constructor(){super(...arguments);a(this,"name","ParseError")}}const d=t=>he(t,Yo),Zo=t=>` ${t}`,Xo=t=>{let n=tt;return()=>n===tt?n=t():n},pn=t=>typeof t=="function"&&t.length===0,Qo=class extends Function{constructor(...t){const n=t.slice(0,-1),e=t.at(-1);try{super(...n,e)}catch(i){return L(`Encountered an unexpected error while compiling your definition:
                Message: ${i} 
                Source: (${t.slice(0,-1)}) => {
                    ${t.at(-1)}
                }`)}}};class bt{constructor(n,...[e]){return Object.assign(Object.setPrototypeOf(n.bind((e==null?void 0:e.bind)??this),this.constructor.prototype),e==null?void 0:e.attach)}}const ea=Xo(()=>{try{return new Function("return false")()}catch{return!0}});class W{}const _t=/^(?!^-0$)-?(?:0|[1-9]\d*)(?:\.\d*[1-9])?$/,ta=_t.test.bind(_t),na=/^-?\d*\.?\d*$/,ia=t=>t.length!==0&&na.test(t),nt=/^(?:0|(?:-?[1-9]\d*))$/,ra=nt.test.bind(nt),Ut=/^-?\d+$/,sa=Ut.test.bind(Ut),cr={number:"a number",bigint:"a bigint",integer:"an integer"},lr=(t,n)=>`'${t}' was parsed as ${cr[n]} but could not be narrowed to a literal value. Avoid unnecessary leading or trailing zeros and other abnormal notation`,oa=(t,n)=>n==="number"?ta(t):ra(t),aa=(t,n)=>n==="number"?Number(t):Number.parseInt(t),ca=(t,n)=>n==="number"?ia(t):sa(t),la=(t,n)=>fn(t,"number",n),ua=(t,n)=>fn(t,"number",{...n,strict:!0}),ha=(t,n)=>fn(t,"integer",n),fn=(t,n,e)=>{const i=aa(t,n);return!Number.isNaN(i)&&ca(t,n)?e!=null&&e.strict?oa(t,n)?i:d(lr(t,n)):i:e!=null&&e.errorOnFail?d((e==null?void 0:e.errorOnFail)===!0?`Failed to parse ${cr[n]} from '${t}'`:e==null?void 0:e.errorOnFail):void 0},da=t=>{if(t[t.length-1]!=="n")return;const n=t.slice(0,-1);let e;try{e=BigInt(n)}catch{return}if(nt.test(n))return e;if(Ut.test(n))return d(lr(t,"bigint"))},ur=t=>typeof t=="string"?JSON.stringify(t):typeof t=="bigint"?`${t}n`:`${t}`,pa="0.9.0",fa={version:pa,filename:import.meta.filename??globalThis.__filename??"unknown",FileConstructor:sr},Ne=fa,Kn=new WeakMap,Ot=Object.create(null),Ft=t=>{const n=Kn.get(t);if(n)return n;let e=ma(t);return Ot[e]?e=`${e}${Ot[e]++}`:Ot[e]=1,Ne[e]=t,Kn.set(t,e),e},it=t=>/^[a-zA-Z_$][a-zA-Z_$0-9]*$/.test(t),ma=t=>{switch(typeof t){case"object":{if(t===null)break;const n=hn(t)??"object";return n[0].toLowerCase()+n.slice(1)}case"function":return it(t.name)?t.name:"fn";case"symbol":return t.description&&it(t.description)?t.description:"symbol"}return L(`Unexpected attempt to register serializable value of type ${Z(t)}`)},ga=(t,n={onUndefined:"(undefined)"})=>st(t,n,[]),E=(t,n)=>{switch(Z(t)){case"object":const e=t,i=e.constructor.name;return i==="Object"||i==="Array"?JSON.stringify(st(e,rt,[]),null,n):e instanceof Date?Oe(e):typeof e.expression=="string"?e.expression:i;case"symbol":return rt.onSymbol(t);default:return ur(t)}},rt={onCycle:()=>"(cycle)",onSymbol:t=>`Symbol(${Ft(t)})`,onFunction:t=>`Function(${Ft(t)})`},st=(t,n,e)=>{switch(Z(t)){case"object":{if(typeof t=="function")return rt.onFunction(t);if(e.includes(t))return"(cycle)";const i=[...e,t];if(Array.isArray(t))return t.map(s=>st(s,n,i));if(t instanceof Date)return t.toDateString();const r={};for(const s in t)r[s]=st(t[s],n,i);return r}case"symbol":return rt.onSymbol(t);case"bigint":return`${t}n`;case"undefined":return n.onUndefined??"undefined";default:return t}},Oe=t=>{const n=t.getFullYear(),e=t.getMonth(),i=t.getDate(),r=t.getHours(),s=t.getMinutes(),o=t.getSeconds(),c=t.getMilliseconds();if(e===0&&i===1&&r===0&&s===0&&o===0&&c===0)return`${n}`;const l=`${ya[e]} ${i}, ${n}`;if(r===0&&s===0&&o===0&&c===0)return l;let u=t.toLocaleTimeString();const h=u.endsWith(" AM")||u.endsWith(" PM")?u.slice(-3):"";return h&&(u=u.slice(0,-h.length)),c?u+=`.${va(c,3)}`:ba.test(u)&&(u=u.slice(0,-3)),`${u+h}, ${l}`},ya=["January","February","March","April","May","June","July","August","September","October","November","December"],ba=/:\d\d:00$/,va=(t,n)=>String(t).padStart(n,"0"),wa=t=>t[0].toUpperCase()+t.slice(1),zt="\\",ot={" ":!0,"\n":!0,"	":!0};let jt="$ark",Vt=2;for(;jt in globalThis;)jt=`$ark${Vt++}`;const hr=jt;globalThis[hr]=Ne;const p=Ne;if(Vt!==2){const t=globalThis,n=[t.$ark];for(let r=2;r<Vt;r++)t[`$ark${r}`]&&n.push(t[`$ark${r}`]);console.warn("Multiple @ark registries detected. This can lead to unexpected behavior.");const e=tr(n,"filename"),i=Object.keys(e);for(const r of i)e[r].length>1&&console.warn(`File ${r} was initialized multiple times, likely due to being imported from both CJS and ESM contexts.`);i.length>1&&console.warn("Registries were initialized at the following paths:"+i.map(r=>`	${r} (@ark/util version ${e[r][0].version})`).join(`
`))}const $a=t=>`${hr}.${t}`,V=t=>$a(Ft(t));class dr extends ir{constructor(...e){super();a(this,"argNames");a(this,"body","");a(this,"indentation",0);this.argNames=e;for(const i of e){if(i in this)throw new Error(`Arg name '${i}' would overwrite an existing property on FunctionBody`);this[i]=i}}indent(){return this.indentation+=4,this}dedent(){return this.indentation-=4,this}prop(e,i=!1){return pr(e,i)}index(e,i=!1){return fr(`${e}`,i)}line(e){return this.body+=`${" ".repeat(this.indentation)}${e}
`,this}const(e,i){return this.line(`const ${e} = ${i}`),this}let(e,i){return this.line(`let ${e} = ${i}`)}set(e,i){return this.line(`${e} = ${i}`)}if(e,i){return this.block(`if (${e})`,i)}elseIf(e,i){return this.block(`else if (${e})`,i)}else(e){return this.block("else",e)}for(e,i,r=0){return this.block(`for (let i = ${r}; ${e}; i++)`,i)}forIn(e,i){return this.block(`for (const k in ${e})`,i)}block(e,i,r=""){return this.line(`${e} {`),this.indent(),i(this),this.dedent(),this.line(`}${r}`)}return(e=""){return this.line(`return ${e}`)}write(e="anonymous"){return`${e}(${this.argNames.join(", ")}) {
${this.body}}`}compile(){return new Qo(...this.argNames,this.body)}}const vt=t=>Ee(t,"object")||typeof t=="symbol"?V(t):ur(t),pr=(t,n=!1)=>typeof t=="string"&&it(t)?`${n?"?":""}.${t}`:fr(ka(t),n),ka=t=>typeof t=="symbol"?V(t):JSON.stringify(t),fr=(t,n=!1)=>`${n?"?.":""}[${t}]`;class _n extends dr{constructor(e){super("data","ctx");a(this,"path",[]);a(this,"discriminants",[]);a(this,"traversalKind");this.traversalKind=e}invoke(e,i){const r=(i==null?void 0:i.arg)??this.data,s=typeof e=="string"?!0:this.requiresContextFor(e),o=typeof e=="string"?e:e.id;return s?`${this.referenceToId(o,i)}(${r}, ${this.ctx})`:`${this.referenceToId(o,i)}(${r})`}referenceToId(e,i){const r=(i==null?void 0:i.kind)??this.traversalKind,s=`this.${e}${r}`;return i!=null&&i.bind?`${s}.bind(${i==null?void 0:i.bind})`:s}requiresContextFor(e){return this.traversalKind==="Apply"||e.allowsRequiresContext}initializeErrorCount(){return this.const("errorCount","ctx.currentErrorCount")}returnIfFail(){return this.if("ctx.currentErrorCount > errorCount",()=>this.return())}returnIfFailFast(){return this.if("ctx.failFast && ctx.currentErrorCount > errorCount",()=>this.return())}traverseKey(e,i,r){const s=this.requiresContextFor(r);return s&&this.line(`${this.ctx}.path.push(${e})`),this.check(r,{arg:i}),s&&this.line(`${this.ctx}.path.pop()`),this}check(e,i){return this.traversalKind==="Allows"?this.if(`!${this.invoke(e,i)}`,()=>this.return(!1)):this.line(this.invoke(e,i))}}const mr=t=>T(t,(n,e)=>[n,j(e)?[...e]:e]),mn=(t,...[n])=>{const e=(n==null?void 0:n.stringifySymbol)??E,i=t.reduce((r,s)=>{switch(typeof s){case"string":return it(s)?`${r}.${s}`:`${r}[${JSON.stringify(s)}]`;case"number":return`${r}[${s}]`;case"symbol":return`${r}[${e(s)}]`;default:if(n!=null&&n.stringifyNonKey)return`${r}[${n.stringifyNonKey(s)}]`;d(`${E(s)} must be a PropertyKey or stringifyNonKey must be passed to options`)}},"");return i[0]==="."?i.slice(1):i},re=Zo("arkKind"),g=(t,n)=>(t==null?void 0:t[re])===n,J=t=>g(t,"root")||g(t,"constraint"),xa=["unit","proto","domain"],wt=["required","optional","index","sequence"],gr=["pattern","divisor","exactLength","max","min","maxLength","minLength","before","after"],gn=[...gr,...wt,"structure","predicate"],Ie=["alias","union","morph","unit","intersection","proto","domain"],Aa=[...Ie,...gn],yr=T(gn,(t,n)=>[n,1]),Sa=T([...wt,"undeclared"],(t,n)=>[n,1]),br=T(Aa,(t,n)=>[n,t]),Je=t=>typeof t=="string"&&t in br,at=t=>br[t],yn=t=>Ie.slice(at(t)+1);[...yn("union")];[...yn("morph")];const ct=t=>typeof t=="string"||typeof t=="boolean"||t===null?t:typeof t=="number"?Number.isNaN(t)?"NaN":t===Number.POSITIVE_INFINITY?"Infinity":t===Number.NEGATIVE_INFINITY?"-Infinity":t:vt(t),$t=t=>{let n="{ ";for(const[e,i]of Object.entries(t))n+=`${e}: ${vt(i)}, `;return n+" }"},O=t=>{var e,i,r,s;const n=t;return n.hasAssociatedError&&((e=n.defaults).expected??(e.expected=o=>"description"in o?o.description:n.defaults.description(o)),(i=n.defaults).actual??(i.actual=o=>E(o)),(r=n.defaults).problem??(r.problem=o=>`must be ${o.expected}${o.actual?` (was ${o.actual})`:""}`),(s=n.defaults).message??(s.message=o=>{if(o.path.length===0)return o.problem;const c=`${o.propString} ${o.problem}`;return c[0]==="["?`value at ${c}`:c})),n};p.config={};const Ia=(t,n)=>{const e={...t};let i;for(i in n)e[i]=Je(i)?{...t[i],...n[i]}:n[i];return e},Un=(t,n)=>n?Ia(t,n):t,Ta=t=>Un(Un(p.defaultConfig,p.config),t);var Pi,Bi;class lt extends(Bi=ir,Pi=re,Bi){constructor(e,i){super();a(this,Pi,"error");a(this,"path");a(this,"data");a(this,"nodeConfig");a(this,"input");this.input=e,Fo(this,e);const r=i.data;e.code==="union"&&(e.errors=e.errors.flatMap(s=>s.hasCode("union")?s.errors:s)),this.nodeConfig=i.config[this.code],this.path=e.path??[...i.path],e.relativePath&&this.path.push(...e.relativePath),this.data="data"in e?e.data:r}hasCode(e){return this.code===e}get propString(){return mn(this.path)}get expected(){var e,i;return this.input.expected??((i=(e=this.nodeConfig).expected)==null?void 0:i.call(e,this.input))}get actual(){var e,i;return this.input.actual??((i=(e=this.nodeConfig).actual)==null?void 0:i.call(e,this.data))}get problem(){return this.input.problem??this.nodeConfig.problem(this)}get message(){return this.input.message??this.nodeConfig.message(this)}toString(){return this.message}throw(){throw this}}class ye extends Bo{constructor(e){super();a(this,"ctx");a(this,"byPath",{});a(this,"count",0);a(this,"mutable",this);this.ctx=e}add(e){const i=this.byPath[e.propString];if(i){const r=new lt({code:"intersection",errors:i.hasCode("intersection")?[...i.errors,e]:[i,e]},this.ctx),s=this.indexOf(i);this.mutable[s===-1?this.length:s]=r,this.byPath[e.propString]=r}else this.byPath[e.propString]=e,this.mutable.push(e);this.count++}merge(e){e.forEach(i=>this.add(new lt({...i,path:[...i.path,...this.ctx.path]},this.ctx)))}get summary(){return this.toString()}get message(){return this.toString()}toString(){return this.join(`
`)}throw(){throw new AggregateError(this,this.message)}}class Fn{constructor(n,e){a(this,"path",[]);a(this,"queuedMorphs",[]);a(this,"errors",new ye(this));a(this,"branches",[]);a(this,"seen",{});a(this,"root");a(this,"config");this.root=n,this.config=e}get currentBranch(){return this.branches.at(-1)}queueMorphs(n){const e={path:[...this.path],morphs:n};this.currentBranch?this.currentBranch.queuedMorphs.push(e):this.queuedMorphs.push(e)}finalize(){if(this.hasError())return this.errors;if(!this.queuedMorphs.length)return this.root;for(typeof this.root=="object"&&this.root!==null&&this.config.clone&&(this.root=this.config.clone(this.root));this.queuedMorphs.length;){const{path:n,morphs:e}=this.queuedMorphs.shift(),i=n.at(-1);let r;if(i!==void 0){r=this.root;for(let s=0;s<n.length-1;s++)r=r[n[s]]}this.path=n;for(const s of e){const o=s(r===void 0?this.root:r[i],this);if(o instanceof ye)return o;if(this.hasError())return this.errors;if(o instanceof lt)return this.error(o),this.errors;r===void 0?this.root=o:r[i]=o}}return this.root}get currentErrorCount(){return this.currentBranch?this.currentBranch.error?1:0:this.errors.count}hasError(){return this.currentErrorCount!==0}get failFast(){return this.branches.length!==0}error(n){const e=typeof n=="object"?n.code?n:{...n,code:"predicate"}:{code:"predicate",expected:n},i=new lt(e,this);return this.currentBranch?this.currentBranch.error=i:this.errors.add(i),i}get data(){let n=this.root;for(const e of this.path)n=n==null?void 0:n[e];return n}reject(n){return this.error(n),!1}mustBe(n){return this.error(n),!1}pushBranch(){this.branches.push({error:void 0,queuedMorphs:[]})}popBranch(){return this.branches.pop()}}class vr extends bt{constructor(e,i){super((r,s)=>{if(!this.includesMorph&&!this.allowsRequiresContext&&this.allows(r))return r;if(s)return this.traverseApply(r,s),s.data;const o=new Fn(r,this.$.resolvedConfig);return this.traverseApply(r,o),o.finalize()},{attach:e});a(this,"attachments");a(this,"$");a(this,"includesMorph",this.kind==="morph"||this.hasKind("optional")&&this.hasDefault()||this.hasKind("structure")&&this.undeclared==="delete"||this.children.some(e=>e.includesMorph));a(this,"hasContextualPredicate",this.hasKind("predicate")&&this.inner.predicate.length!==1||this.children.some(e=>e.hasContextualPredicate));a(this,"isCyclic",this.kind==="alias"||this.children.some(e=>e.isCyclic));a(this,"allowsRequiresContext",this.hasContextualPredicate||this.isCyclic);a(this,"referencesById",this.children.reduce((e,i)=>Object.assign(e,i.referencesById),{[this.id]:this}));a(this,"precedence",at(this.kind));a(this,"precompilation");a(this,"allows",e=>this.allowsRequiresContext?this.traverseAllows(e,new Fn(e,this.$.resolvedConfig)):this.traverseAllows(e));this.attachments=e,this.$=i}withMeta(e){const i=typeof e=="function"?e({...this.meta}):{...this.meta,...e};return this.$.node(this.kind,{...this.inner,meta:i})}cacheGetter(e,i){return Object.defineProperty(this,e,{value:i}),i}get description(){var i,r,s;const e=((i=this.$)==null?void 0:i.resolvedConfig[this.kind].description)??((r=p.config[this.kind])==null?void 0:r.description)??p.defaultConfig[this.kind].description;return this.cacheGetter("description",((s=this.meta)==null?void 0:s.description)??e(this))}get references(){return Object.values(this.referencesById)}get shallowReferences(){return this.cacheGetter("shallowReferences",this.hasKind("structure")?[this,...this.children]:this.children.reduce((e,i)=>Oa(e,i.shallowReferences),[this]))}get shallowMorphs(){return this.cacheGetter("shallowMorphs",this.shallowReferences.filter(e=>e.hasKind("morph")).sort((e,i)=>e.expression<i.expression?-1:1))}get flatRefs(){return this.cacheGetter("flatRefs",this.children.reduce((e,i)=>ut(e,i.flatRefs),[]).sort((e,i)=>e.path.length>i.path.length?1:e.path.length<i.path.length?-1:e.propString>i.propString?1:e.propString<i.propString||e.node.expression<i.node.expression?-1:1))}traverse(e){return this(e)}get in(){return this.cacheGetter("in",this.getIo("in"))}get out(){return this.cacheGetter("out",this.getIo("out"))}getIo(e){if(!this.includesMorph)return this;const i={};for(const[r,s]of this.innerEntries)if(this.impl.keys[r].child){const c=s;i[r]=j(c)?c.map(l=>l[e]):c[e]}else i[r]=s;return this.$.node(this.kind,i)}toJSON(){return this.json}toString(){return this.expression}equals(e){return this.innerHash===e.innerHash}hasKind(e){return this.kind===e}assertHasKind(e){return this.kind!==e&&he(`${this.kind} node was not of asserted kind ${e}`),this}hasKindIn(...e){return e.includes(this.kind)}assertHasKindIn(...e){return oe(e,this.kind)||he(`${this.kind} node was not one of asserted kinds ${e}`),this}isBasis(){return oe(xa,this.kind)}isConstraint(){return oe(gn,this.kind)}isStructural(){return oe(wt,this.kind)}isRefinement(){return oe(gr,this.kind)}isRoot(){return oe(Ie,this.kind)}isUnknown(){return this.hasKind("intersection")&&this.children.length===0}isNever(){return this.hasKind("union")&&this.children.length===0}hasUnit(e){return this.hasKind("unit")&&this.allows(e)}hasOpenIntersection(){return this.impl.intersectionIsOpen}get nestableExpression(){return this.expression}firstReference(e){return this.references.find(i=>i!==this&&e(i))}firstReferenceOrThrow(e){return this.firstReference(e)??he(`${this.id} had no references matching predicate ${e}`)}firstReferenceOfKind(e){return this.firstReference(i=>i.hasKind(e))}firstReferenceOfKindOrThrow(e){return this.firstReference(i=>i.kind===e)??he(`${this.id} had no ${e} references`)}transform(e,i){return this._transform(e,{...i,seen:{},path:[],parseOptions:{prereduced:(i==null?void 0:i.prereduced)??!1}})}_transform(e,i){var l;const r=i.bindScope??this.$;if(i.seen[this.id])return this.$.lazilyResolve(i.seen[this.id]);if(((l=i.shouldTransform)==null?void 0:l.call(i,this,i))===!1)return this;let s;i.seen[this.id]=()=>s;const o=T(this.inner,(u,h)=>{if(!this.impl.keys[u].child)return[u,h];const f=h;if(!j(f)){const w=f._transform(e,i);return w?[u,w]:[]}if(f.length===0)return[u,h];const y=f.flatMap(w=>w._transform(e,i)??[]);return y.length?[u,y]:[]});delete i.seen[this.id];const c=e(this.kind,o,i);return c===null?null:J(c)?s=c:Se(c)&&!Se(this.inner)||(this.kind==="required"||this.kind==="optional"||this.kind==="index")&&!("value"in c)?null:(this.kind==="morph"&&(c.in??(c.in=p.intrinsic.unknown)),s=r.node(this.kind,c,i.parseOptions))}configureShallowDescendants(e){return this.$.finalize(this.transform((i,r)=>({...r,meta:e}),{shouldTransform:i=>i.kind!=="structure"}))}}const Ea=t=>mn(t,{stringifyNonKey:n=>n.expression}),te=(t,n)=>({path:t,node:n,propString:Ea(t)}),Na=(t,n)=>t.propString===n.propString&&t.node.equals(n.node),ut=(t,n)=>me(t,n,{isEqual:Na}),Oa=(t,n)=>me(t,n,{isEqual:(e,i)=>e.equals(i)});class m extends Array{static init(n,e,i,r){return new m({kind:n,l:e,r:i,path:(r==null?void 0:r.path)??[],optional:(r==null?void 0:r.optional)??!1})}add(n,e,i,r){return this.push({kind:n,l:e,r:i,path:(r==null?void 0:r.path)??[],optional:(r==null?void 0:r.optional)??!1}),this}describeReasons(){if(this.length===1){const{path:n,l:e,r:i}=this[0],r=mn(n);return wr(`Intersection${r&&` at ${r}`} of ${zn(e,i)}`)}return`The following intersections result in unsatisfiable types:
• ${this.map(({path:n,l:e,r:i})=>`${n}: ${zn(e,i)}`).join(`
• `)}`}throw(){return d(this.describeReasons())}invert(){return this.map(n=>({...n,l:n.r,r:n.l}))}withPrefixKey(n,e){return this.map(i=>({...i,path:[n,...i.path],optional:i.optional||e==="optional"}))}toNeverIfDisjoint(){return p.intrinsic.never}}const zn=(t,n)=>`${Jt(t)} and ${Jt(n)}`,Jt=t=>J(t)?t.expression:j(t)?t.map(Jt).join(" | ")||"never":String(t),wr=t=>`${t} results in an unsatisfiable type`,ae={},se=(t,n,e)=>P(t,n,{$:e,invert:!1,pipe:!1}),jn=(t,n,e)=>P(t,n,{$:e,invert:!1,pipe:!0}),P=(t,n,e)=>{const i=e.pipe?"|>":"&",r=`${t.hash}${i}${n.hash}`;if(ae[r]!==void 0)return ae[r];if(!e.pipe){const o=`${n.hash}${i}${t.hash}`;if(ae[o]!==void 0){const c=ae[o],l=c instanceof m?c.invert():c;return ae[r]=l,l}}if(t.equals(n))return t;let s=e.pipe&&t.hasKindIn(...Ie)&&n.hasKindIn(...Ie)?Ra(t,n,e):bn(t,n,e);return J(s)&&(t.equals(s)?s=t:n.equals(s)&&(s=n)),ae[r]=s,s},bn=(t,n,e)=>{const i=t.precedence<n.precedence?t.kind:n.kind,r=t.impl.intersections[n.kind]??n.impl.intersections[t.kind];if(r===void 0)return null;if(i===t.kind)return r(t,n,e);{let s=r(n,t,{...e,invert:!e.invert});return s instanceof m&&(s=s.invert()),s}},Ra=(t,n,e)=>t.includesMorph||n.includesMorph?e.invert?Le(n,t,e):Le(t,n,e):bn(t,n,e),Le=(t,n,e)=>t.distribute(i=>Da(i,n,e),i=>{const r=i.filter(J);return r.length===0?m.init("union",t.branches,n.branches):e.$.parseSchema(r)}),Da=(t,n,e)=>{const i=t.hasKind("morph");if(i){const r=[...t.morphs];if(t.validatedOut){const s=P(t.validatedOut,n,e);if(s instanceof m)return s;r[r.length-1]=s}else r.push(n);return e.$.node("morph",{morphs:r,in:i?t.in:t})}return n.hasKind("morph")?e.$.node("morph",{morphs:n.morphs,in:bn(t,n.in,e)}):e.$.node("morph",{morphs:[n],in:t})};var Li,qi;class be extends(qi=vr,Li=re,qi){constructor(){super(...arguments);a(this,Li,"constraint");a(this,"impliedSiblings")}intersect(e){return se(this,e,this.$)}}class kt extends be{constructor(){super(...arguments);a(this,"traverseApply",(e,i)=>{this.traverseAllows(e,i)||i.error(this.errorContext)})}compile(e){e.traversalKind==="Allows"?e.return(this.compiledCondition):e.if(this.compiledNegation,()=>e.line(`${e.ctx}.error(${this.compiledErrorContext})`))}get errorContext(){return{code:this.kind,description:this.description,...this.inner}}get compiledErrorContext(){return $t(this.errorContext)}}const K=t=>(n,e)=>{if(j(n)){if(n.length===0)return;const r=n.map(s=>e.$.node(t,s));return t==="predicate"?r:r.sort((s,o)=>s.hash<o.hash?-1:1)}const i=e.$.node(t,n);return i.hasOpenIntersection()?[i]:i},ht=t=>{var i;const n=t.r.shift();if(!n){let r=t.l.length===0&&t.kind==="structure"?p.intrinsic.unknown.internal:t.ctx.$.node(t.kind,Object.assign(t.baseInner,Ca(t.l)),{prereduced:!0});for(const s of t.roots){if(r instanceof m)return r;r=P(s,r,t.ctx)}return r}let e=!1;for(let r=0;r<t.l.length;r++){const s=P(t.l[r],n,t.ctx);if(s!==null){if(s instanceof m)return s;if(e){if(!t.l.includes(s))return L(`Unexpectedly encountered multiple distinct intersection results for refinement ${s}`)}else{if(s.isRoot())return t.roots.push(s),t.l.splice(r),ht(t);t.l[r]=s,e=!0}}}return e||t.l.push(n),t.kind==="intersection"&&((i=n.impliedSiblings)==null||i.forEach(r=>me(t.r,r))),ht(t)},dt=t=>Object.entries(t).flatMap(([e,i])=>e in yr?i:[]).sort((e,i)=>e.precedence<i.precedence?-1:e.precedence>i.precedence?1:e.kind==="predicate"&&i.kind==="predicate"?0:e.hash<i.hash?-1:1),Ca=t=>{const n={};for(const e of t)if(e.hasOpenIntersection())n[e.kind]=B(n[e.kind],e);else{if(n[e.kind])return L(`Unexpected intersection of closed refinements of kind ${e.kind}`);n[e.kind]=e}return n},Ma=(...t)=>d(Pa(...t)),Pa=(t,n,e)=>`${wa(t)} operand must be ${n.description} (was ${e.exclude(n).description})`,Ba=(t,n,e)=>new pt(t,n,e,e);class $r extends bt{}var Ki,_i;class pt extends(_i=bt,Ki=re,_i){constructor(e,i,r,s){super((...o)=>{const c=T(this.names,(l,u)=>{const h=this.arg$.parse(o[l]);return h.extends(this.constraints[l])||d(La(u,this.constraints[l].expression,h.expression)),[u,h]});if(this.defIsLazy()){const l=this.bodyDef(c);return this.$.parse(l)}return this.$.parse(i,{args:c})});a(this,Ki,"generic");a(this,"paramDefs");a(this,"bodyDef");a(this,"$");a(this,"arg$");a(this,"baseInstantiation");this.paramDefs=e,this.bodyDef=i,this.$=r,this.arg$=s,this.baseInstantiation=this(...this.constraints)}defIsLazy(){return this.bodyDef instanceof $r}cacheGetter(e,i){return Object.defineProperty(this,e,{value:i}),i}get json(){return this.cacheGetter("json",{params:this.params.map(e=>e[1].isUnknown()?e[0]:[e[0],e[1].json]),body:ga(this.bodyDef)})}get params(){return this.cacheGetter("params",this.paramDefs.map(e=>typeof e=="string"?[e,p.intrinsic.unknown]:[e[0],this.$.parse(e[1])]))}get names(){return this.cacheGetter("names",this.params.map(e=>e[0]))}get constraints(){return this.cacheGetter("constraints",this.params.map(e=>e[1]))}get internal(){return this}get referencesById(){return this.baseInstantiation.internal.referencesById}get references(){return this.baseInstantiation.internal.references}}const La=(t,n,e)=>`${t} must be assignable to ${n} (was ${e})`,q=t=>{const n=typeof t=="string"?{description:t}:t;let e=`${n.description} is not convertible to JSON Schema`;return n.reason&&(e+=` because ${n.reason}`),e},qa=t=>q({description:`Morph ${t}`,reason:"it represents a transformation, while JSON Schema only allows validation. Consider creating a Schema from one of its endpoints using `.in` or `.out`."}),Ka=t=>q({description:t,reason:"cyclic types are not yet convertible to JSON Schema. If this feature is important to you, please add your feedback at https://github.com/arktypeio/arktype/issues/1087"}),xt=(t,n)=>L(`Unexpected JSON Schema input for ${t}: ${E(n)}`),_a=O({kind:"predicate",hasAssociatedError:!0,collapsibleKey:"predicate",keys:{predicate:{}},normalize:t=>typeof t=="function"?{predicate:t}:t,defaults:{description:t=>`valid according to ${t.predicate.name||"an anonymous predicate"}`},intersectionIsOpen:!0,intersections:{predicate:()=>null}});class Ua extends be{constructor(){super(...arguments);a(this,"serializedPredicate",V(this.predicate));a(this,"compiledCondition",`${this.serializedPredicate}(data, ctx)`);a(this,"compiledNegation",`!${this.compiledCondition}`);a(this,"impliedBasis",null);a(this,"expression",this.serializedPredicate);a(this,"traverseAllows",this.predicate);a(this,"errorContext",{code:"predicate",description:this.description});a(this,"compiledErrorContext",$t(this.errorContext));a(this,"traverseApply",(e,i)=>{!this.predicate(e,i)&&!i.hasError()&&i.error(this.errorContext)})}compile(e){if(e.traversalKind==="Allows"){e.return(this.compiledCondition);return}e.if(`${this.compiledNegation} && !ctx.hasError()`,()=>e.line(`ctx.error(${this.compiledErrorContext})`))}reduceJsonSchema(){return d(q({description:`Predicate ${this.expression}`}))}}const kr={implementation:_a,Node:Ua},Fa=O({kind:"divisor",collapsibleKey:"rule",keys:{rule:{}},normalize:t=>typeof t=="number"?{rule:t}:t,hasAssociatedError:!0,defaults:{description:t=>t.rule===1?"an integer":`a multiple of ${t.rule}`},intersections:{divisor:(t,n,e)=>e.$.node("divisor",{rule:Math.abs(t.rule*n.rule/ja(t.rule,n.rule))})}});class za extends kt{constructor(){super(...arguments);a(this,"traverseAllows",e=>e%this.rule===0);a(this,"compiledCondition",`data % ${this.rule} === 0`);a(this,"compiledNegation",`data % ${this.rule} !== 0`);a(this,"impliedBasis",p.intrinsic.number.internal);a(this,"expression",`% ${this.rule}`)}reduceJsonSchema(e){return e.type="integer",this.rule===1||(e.multipleOf=this.rule),e}}const xr={implementation:Fa,Node:za},ja=(t,n)=>{let e,i=t,r=n;for(;r!==0;)e=r,r=i%r,i=e;return i};class ve extends kt{constructor(){super(...arguments);a(this,"boundOperandKind",Wa[this.kind]);a(this,"compiledActual",this.boundOperandKind==="value"?"data":this.boundOperandKind==="length"?"data.length":"data.valueOf()");a(this,"comparator",Ga(this.kind,this.exclusive));a(this,"numericLimit",this.rule.valueOf());a(this,"expression",`${this.comparator} ${this.rule}`);a(this,"compiledCondition",`${this.compiledActual} ${this.comparator} ${this.numericLimit}`);a(this,"compiledNegation",`${this.compiledActual} ${Va[this.comparator]} ${this.numericLimit}`);a(this,"stringLimit",this.boundOperandKind==="date"?Ya(this.numericLimit):`${this.numericLimit}`);a(this,"limitKind",this.comparator[0]==="<"?"upper":"lower")}isStricterThan(e){return(this.limitKind==="upper"?this.numericLimit<e.numericLimit:this.numericLimit>e.numericLimit)||this.numericLimit===e.numericLimit&&this.exclusive===!0&&!e.exclusive}overlapsRange(e){return!(this.isStricterThan(e)||this.numericLimit===e.numericLimit&&(this.exclusive||e.exclusive))}overlapIsUnit(e){return this.numericLimit===e.numericLimit&&!this.exclusive&&!e.exclusive}}const Va={"<":">=","<=":">",">":"<=",">=":"<"},Ja={min:"max",minLength:"maxLength",after:"before"},Ar={parse:t=>t||void 0},Sr=t=>n=>{if(typeof n=="number")return{rule:n};const{exclusive:e,...i}=n;return e?{...i,rule:t==="minLength"?i.rule+1:i.rule-1}:i},Ir=t=>n=>{if(typeof n=="number"||typeof n=="string"||n instanceof Date)return{rule:n};const{exclusive:e,...i}=n;if(!e)return i;const r=typeof i.rule=="number"?i.rule:typeof i.rule=="string"?new Date(i.rule).valueOf():i.rule.valueOf();return e?{...i,rule:t==="after"?r+1:r-1}:i},Tr=t=>typeof t=="string"||typeof t=="number"?new Date(t):t,Ha=(t,n)=>`${t} bound must be a positive integer (was ${n})`,vn=t=>n=>((!Number.isInteger(n)||n<0)&&d(Ha(t,n)),n),Wa={min:"value",max:"value",minLength:"length",maxLength:"length",after:"date",before:"date"},Ga=(t,n)=>`${X(t,Ja)?">":"<"}${n?"":"="}`,Ya=t=>typeof t=="string"?t:new Date(t).toLocaleString(),Za=t=>`Bounded expression ${t} must be a number, string, Array, or Date`,Xa=O({kind:"after",collapsibleKey:"rule",hasAssociatedError:!0,keys:{rule:{parse:Tr,serialize:t=>t.toISOString()}},normalize:Ir("after"),defaults:{description:t=>`${t.collapsibleLimitString} or later`,actual:Oe},intersections:{after:(t,n)=>t.isStricterThan(n)?t:n}});class Qa extends ve{constructor(){super(...arguments);a(this,"impliedBasis",p.intrinsic.Date.internal);a(this,"collapsibleLimitString",Oe(this.rule));a(this,"traverseAllows",e=>e>=this.rule)}reduceJsonSchema(){return d(q("Date instance"))}}const Er={implementation:Xa,Node:Qa},ec=O({kind:"before",collapsibleKey:"rule",hasAssociatedError:!0,keys:{rule:{parse:Tr,serialize:t=>t.toISOString()}},normalize:Ir("before"),defaults:{description:t=>`${t.collapsibleLimitString} or earlier`,actual:Oe},intersections:{before:(t,n)=>t.isStricterThan(n)?t:n,after:(t,n,e)=>t.overlapsRange(n)?t.overlapIsUnit(n)?e.$.node("unit",{unit:t.rule}):null:m.init("range",t,n)}});class tc extends ve{constructor(){super(...arguments);a(this,"collapsibleLimitString",Oe(this.rule));a(this,"traverseAllows",e=>e<=this.rule);a(this,"impliedBasis",p.intrinsic.Date.internal)}reduceJsonSchema(){return d(q("Date instance"))}}const Nr={implementation:ec,Node:tc},nc=O({kind:"exactLength",collapsibleKey:"rule",keys:{rule:{parse:vn("exactLength")}},normalize:t=>typeof t=="number"?{rule:t}:t,hasAssociatedError:!0,defaults:{description:t=>`exactly length ${t.rule}`,actual:t=>`${t.length}`},intersections:{exactLength:(t,n,e)=>m.init("unit",e.$.node("unit",{unit:t.rule}),e.$.node("unit",{unit:n.rule}),{path:["length"]}),minLength:(t,n)=>t.rule>=n.rule?t:m.init("range",t,n),maxLength:(t,n)=>t.rule<=n.rule?t:m.init("range",t,n)}});class ic extends kt{constructor(){super(...arguments);a(this,"traverseAllows",e=>e.length===this.rule);a(this,"compiledCondition",`data.length === ${this.rule}`);a(this,"compiledNegation",`data.length !== ${this.rule}`);a(this,"impliedBasis",p.intrinsic.lengthBoundable.internal);a(this,"expression",`== ${this.rule}`)}reduceJsonSchema(e){switch(e.type){case"string":return e.minLength=this.rule,e.maxLength=this.rule,e;case"array":return e.minItems=this.rule,e.maxItems=this.rule,e;default:return xt("exactLength",e)}}}const Or={implementation:nc,Node:ic},rc=O({kind:"max",collapsibleKey:"rule",hasAssociatedError:!0,keys:{rule:{},exclusive:Ar},normalize:t=>typeof t=="number"?{rule:t}:t,defaults:{description:t=>`${t.exclusive?"less than":"at most"} ${t.rule}`},intersections:{max:(t,n)=>t.isStricterThan(n)?t:n,min:(t,n,e)=>t.overlapsRange(n)?t.overlapIsUnit(n)?e.$.node("unit",{unit:t.rule}):null:m.init("range",t,n)}});class sc extends ve{constructor(){super(...arguments);a(this,"impliedBasis",p.intrinsic.number.internal);a(this,"traverseAllows",this.exclusive?e=>e<this.rule:e=>e<=this.rule)}reduceJsonSchema(e){return this.exclusive?e.exclusiveMaximum=this.rule:e.maximum=this.rule,e}}const Rr={implementation:rc,Node:sc},oc=O({kind:"maxLength",collapsibleKey:"rule",hasAssociatedError:!0,keys:{rule:{parse:vn("maxLength")}},reduce:(t,n)=>t.rule===0?n.node("exactLength",t):void 0,normalize:Sr("maxLength"),defaults:{description:t=>`at most length ${t.rule}`,actual:t=>`${t.length}`},intersections:{maxLength:(t,n)=>t.isStricterThan(n)?t:n,minLength:(t,n,e)=>t.overlapsRange(n)?t.overlapIsUnit(n)?e.$.node("exactLength",{rule:t.rule}):null:m.init("range",t,n)}});class ac extends ve{constructor(){super(...arguments);a(this,"impliedBasis",p.intrinsic.lengthBoundable.internal);a(this,"traverseAllows",e=>e.length<=this.rule)}reduceJsonSchema(e){switch(e.type){case"string":return e.maxLength=this.rule,e;case"array":return e.maxItems=this.rule,e;default:return xt("maxLength",e)}}}const Dr={implementation:oc,Node:ac},cc=O({kind:"min",collapsibleKey:"rule",hasAssociatedError:!0,keys:{rule:{},exclusive:Ar},normalize:t=>typeof t=="number"?{rule:t}:t,defaults:{description:t=>`${t.exclusive?"more than":"at least"} ${t.rule}`},intersections:{min:(t,n)=>t.isStricterThan(n)?t:n}});class lc extends ve{constructor(){super(...arguments);a(this,"impliedBasis",p.intrinsic.number.internal);a(this,"traverseAllows",this.exclusive?e=>e>this.rule:e=>e>=this.rule)}reduceJsonSchema(e){return this.exclusive?e.exclusiveMinimum=this.rule:e.minimum=this.rule,e}}const Cr={implementation:cc,Node:lc},uc=O({kind:"minLength",collapsibleKey:"rule",hasAssociatedError:!0,keys:{rule:{parse:vn("minLength")}},reduce:t=>t.rule===0?p.intrinsic.unknown:void 0,normalize:Sr("minLength"),defaults:{description:t=>t.rule===1?"non-empty":`at least length ${t.rule}`,actual:t=>t.length===0?"":`${t.length}`},intersections:{minLength:(t,n)=>t.isStricterThan(n)?t:n}});class hc extends ve{constructor(){super(...arguments);a(this,"impliedBasis",p.intrinsic.lengthBoundable.internal);a(this,"traverseAllows",e=>e.length>=this.rule)}reduceJsonSchema(e){switch(e.type){case"string":return e.minLength=this.rule,e;case"array":return e.minItems=this.rule,e;default:return xt("minLength",e)}}}const Mr={implementation:uc,Node:hc},dc={min:Cr.implementation,max:Rr.implementation,minLength:Mr.implementation,maxLength:Dr.implementation,exactLength:Or.implementation,after:Er.implementation,before:Nr.implementation},pc={min:Cr.Node,max:Rr.Node,minLength:Mr.Node,maxLength:Dr.Node,exactLength:Or.Node,after:Er.Node,before:Nr.Node},fc=O({kind:"pattern",collapsibleKey:"rule",keys:{rule:{},flags:{}},normalize:t=>typeof t=="string"?{rule:t}:t instanceof RegExp?t.flags?{rule:t.source,flags:t.flags}:{rule:t.source}:t,hasAssociatedError:!0,intersectionIsOpen:!0,defaults:{description:t=>`matched by ${t.rule}`},intersections:{pattern:()=>null}});class mc extends kt{constructor(){super(...arguments);a(this,"instance",new RegExp(this.rule,this.flags));a(this,"expression",`${this.instance}`);a(this,"traverseAllows",this.instance.test.bind(this.instance));a(this,"compiledCondition",`${this.expression}.test(data)`);a(this,"compiledNegation",`!${this.compiledCondition}`);a(this,"impliedBasis",p.intrinsic.string.internal)}reduceJsonSchema(e){return e.pattern?d(q(`Intersection of patterns ${e.pattern} & ${this.rule}`)):(e.pattern=this.rule,e)}}const Pr={implementation:fc,Node:mc},He=(t,n)=>{const e=gc(t);return n&&!n.includes(e)?d(`Root of kind ${e} should be one of ${n}`):e},gc=t=>{if(g(t,"root"))return t.kind;if(typeof t=="string")return t[0]==="$"?"alias":"domain";if(typeof t=="function")return"proto";if(typeof t!="object"||t===null)return d(Vn(t));if("morphs"in t)return"morph";if("branches"in t||j(t))return"union";if("unit"in t)return"unit";if("reference"in t)return"alias";const n=Object.keys(t);return n.length===0||n.some(e=>e in yr)?"intersection":"proto"in t?"proto":"domain"in t?"domain":d(Vn(t))},Vn=t=>`${E(t)} is not a valid type schema`,qe={},yc=t=>j(t)?t.map(n=>n.collapsibleJson):t.collapsibleJson,_={};p.nodesByRegisteredId=_;const Br=t=>(qe[t]??(qe[t]=0),`${t}${++qe[t]}`),Lr=t=>{const n=At[t.kind],e={},{meta:i,...r}=t.def,s=i===void 0?{}:typeof i=="string"?{description:i}:i,o=nr(r).sort(([l],[u])=>Je(l)?Je(u)?at(l)-at(u):1:Je(u)||l<u?-1:1).filter(([l,u])=>{if(l.startsWith("meta.")){const h=l.slice(5);return s[h]=u,!1}return!0});for(const l of o){const u=l[0],h=n.keys[u];if(!h)return d(`Key ${u} is not valid on ${t.kind} schema`);const f=h.parse?h.parse(l[1],t):l[1];f!==tt&&(f!==void 0||h.preserveUndefined)&&(e[u]=f)}if(n.reduce&&!t.prereduced){const l=n.reduce(e,t.$);if(l)return l instanceof m?l.throw():vc(l,s)}return wn(t.id,t.kind,e,s,t.$)},wn=(t,n,e,i,r,s)=>{const o=At[n],c=nr(e),l=[];let u={};c.forEach(([k,A])=>{const G=o.keys[k],Pe=G.serialize??(G.child?yc:ct);if(u[k]=Pe(A),G.child){const Et=A;j(Et)?l.push(...Et):l.push(Et)}}),o.finalizeInnerJson&&(u=o.finalizeInnerJson(u));let h={...u},f={};Se(i)||(f=T(i,(k,A)=>[k,k==="examples"?A:ct(A)]),h.meta=Ke(f,"description",!0)),u=Ke(u,o.collapsibleKey,!1);const y=JSON.stringify({kind:n,...u});h=Ke(h,o.collapsibleKey,!1);const w=Ke(h,o.collapsibleKey,!0),x=JSON.stringify({kind:n,...h});if(r.nodesByHash[x]&&!s)return r.nodesByHash[x];const M={id:t,kind:n,impl:o,inner:e,innerEntries:c,innerJson:u,innerHash:y,meta:i,metaJson:f,json:h,hash:x,collapsibleJson:w,children:l};for(const k in e)k!=="in"&&k!=="out"&&(M[k]=e[k]);const R=new gl[n](M,r);return r.nodesByHash[x]=R},bc=(t,n)=>t.id===n?t:(J(_[n])&&L(`Unexpected attempt to overwrite node id ${n}`),wn(n,t.kind,t.inner,t.meta,t.$,!0)),vc=(t,n,e)=>wn(Br(n.alias??t.kind),t.kind,t.inner,n,t.$),Ke=(t,n,e)=>{const i=Object.keys(t);if(i.length===1&&i[0]===n){const r=t[n];if(e||Ee(r,"object")&&(Object.keys(r).length===1||Array.isArray(r)))return r}return t};var Ui,Fi;class Re extends(Fi=vr,Ui=re,Fi){constructor(){super(...arguments);a(this,Ui,"root");a(this,"branches",this.hasKind("union")?this.inner.branches:[this]);a(this,"_keyof");a(this,"pipe",Object.assign(this._pipe.bind(this),{try:this.tryPipe.bind(this)}))}get internal(){return this}as(){return this}readonly(){return this}distribute(e,i){const r=this.branches.map(e);return(i==null?void 0:i(r))??r}toJsonSchema(){const e=this.innerToJsonSchema();return Object.assign(e,this.metaJson)}intersect(e){const i=this.$.parseDefinition(e),r=this.rawIntersect(i);return r instanceof m?r:this.$.finalize(r)}rawIntersect(e){return se(this,e,this.$)}toNeverIfDisjoint(){return this}and(e){const i=this.intersect(e);return i instanceof m?i.throw():i}rawAnd(e){const i=this.rawIntersect(e);return i instanceof m?i.throw():i}or(e){const i=this.$.parseDefinition(e);return this.$.finalize(this.rawOr(i))}rawOr(e){const i=[...this.branches,...e.branches];return this.$.node("union",i)}assert(e){const i=this.traverse(e);return i instanceof ye?i.throw():i}map(e){return this.$.schema(this.applyStructuralOperation("map",[e]))}pick(...e){return this.$.schema(this.applyStructuralOperation("pick",e))}omit(...e){return this.$.schema(this.applyStructuralOperation("omit",e))}required(){return this.$.schema(this.applyStructuralOperation("required",[]))}partial(){return this.$.schema(this.applyStructuralOperation("partial",[]))}keyof(){if(this._keyof)return this._keyof;const e=this.applyStructuralOperation("keyof",[]).reduce((i,r)=>i.intersect(r).toNeverIfDisjoint(),p.intrinsic.unknown.internal);return e.branches.length===0&&d(wr(`keyof ${this.expression}`)),this._keyof=this.$.finalize(e)}merge(e){const i=this.$.parseDefinition(e);return this.$.schema(i.distribute(r=>this.applyStructuralOperation("merge",[Jn(r)??d(Hn("merge",r.expression))])))}applyStructuralOperation(e,i){return this.distribute(r=>{if(r.equals(p.intrinsic.object)&&e!=="merge")return r;const s=Jn(r);if(s||d(Hn(e,r.expression)),e==="keyof")return s.keyof();if(e==="get")return s.get(...i);const o=e==="required"?"require":e==="partial"?"optionalize":e;return this.$.node("intersection",{...r.inner,structure:s[o](...i)})})}get(...e){return e[0]===void 0?this:this.$.schema(this.applyStructuralOperation("get",e))}extract(e){const i=this.$.parseDefinition(e);return this.$.schema(this.branches.filter(r=>r.extends(i)))}exclude(e){const i=this.$.parseDefinition(e);return this.$.schema(this.branches.filter(r=>!r.extends(i)))}array(){return this.$.schema({proto:Array,sequence:this},{prereduced:!0})}overlaps(e){return!(this.intersect(e)instanceof m)}extends(e){const i=this.intersect(e);return!(i instanceof m)&&this.equals(i)}subsumes(e){return e.extends(this)}configure(e){return this.configureShallowDescendants(e)}describe(e){return this.configure({description:e})}optional(){return this.withMeta({optional:!0})}default(e){return this.withMeta({default:e})}from(e){return this.assert(e)}_pipe(...e){return e.reduce((i,r)=>i.pipeOnce(r),this)}tryPipe(...e){return e.reduce((i,r)=>i.pipeOnce(g(r,"root")?r:(s,o)=>{try{return r(s,o)}catch(c){return o.error({code:"predicate",predicate:r,actual:`aborted due to error:
    ${c}
`})}}),this)}to(e){return this.$.finalize(this.toNode(this.$.parseDefinition(e)))}toNode(e){const i=jn(this,e,this.$);return i instanceof m?i.throw():i}pipeOnce(e){return g(e,"root")?this.toNode(e):this.distribute(i=>i.hasKind("morph")?this.$.node("morph",{in:i.in,morphs:[...i.morphs,e]}):this.$.node("morph",{in:i,morphs:[e]}),this.$.parseSchema)}get flatMorphs(){return this.cacheGetter("flatMorphs",this.flatRefs.reduce((e,i)=>ut(e,i.node.hasKind("union")?i.node.branches.filter(r=>r.hasKind("morph")).map(r=>({path:i.path,propString:i.propString,node:r})):i.node.hasKind("morph")?i:[]),[]))}narrow(e){return this.constrainOut("predicate",e)}constrain(e,i){return this._constrain("root",e,i)}constrainIn(e,i){return this._constrain("in",e,i)}constrainOut(e,i){return this._constrain("out",e,i)}_constrain(e,i,r){const s=this.$.node(i,r);if(s.isRoot())return s.isUnknown()?this:L(`Unexpected constraint node ${s}`);const o=e==="root"?this:this[e];if(o.hasKind("morph")||s.impliedBasis&&!o.extends(s.impliedBasis))return Ma(i,s.impliedBasis,this);const c=this.$.node("intersection",{[i]:s}),l=e==="out"?jn(this,c,this.$):se(this,c,this.$);return l instanceof m&&l.throw(),this.$.finalize(l)}onUndeclaredKey(e){const i=typeof e=="string"?e:e.rule,r=typeof e=="string"?!1:e.deep;return this.$.finalize(this.transform((s,o)=>s==="structure"?i==="ignore"?Uo(o,{undeclared:1}):{...o,undeclared:i}:o,r?void 0:{shouldTransform:s=>!oe(wt,s.kind)}))}onDeepUndeclaredKey(e){return this.onUndeclaredKey({rule:e,deep:!0})}satisfying(e){return this.constrain("predicate",e)}divisibleBy(e){return this.constrain("divisor",e)}matching(e){return this.constrain("pattern",e)}atLeast(e){return this.constrain("min",e)}atMost(e){return this.constrain("max",e)}moreThan(e){return this.constrain("min",ce(e))}lessThan(e){return this.constrain("max",ce(e))}atLeastLength(e){return this.constrain("minLength",e)}atMostLength(e){return this.constrain("maxLength",e)}moreThanLength(e){return this.constrain("minLength",ce(e))}lessThanLength(e){return this.constrain("maxLength",ce(e))}exactlyLength(e){return this.constrain("exactLength",e)}atOrAfter(e){return this.constrain("after",e)}atOrBefore(e){return this.constrain("before",e)}laterThan(e){return this.constrain("after",ce(e))}earlierThan(e){return this.constrain("before",ce(e))}}const ce=t=>typeof t=="object"&&!(t instanceof Date)?{...t,exclusive:!0}:{rule:t,exclusive:!0},_e=(t,n)=>g(n,"root")?g(t,"root")?t.extends(n):n.allows(t):g(t,"root")?t.hasUnit(n):n===t,Jn=t=>{var n;return t.hasKind("morph")?null:t.hasKind("intersection")?t.inner.structure??(((n=t.basis)==null?void 0:n.domain)==="object"?t.$.bindReference(p.intrinsic.emptyStructure):null):t.isBasis()&&t.domain==="object"?t.$.bindReference(p.intrinsic.emptyStructure):null},Hn=(t,n)=>`${t} operand must be an object (was ${n})`,De=(t,n)=>T(yn(t),(e,i)=>[i,n]),wc=t=>typeof t=="string"?{reference:t}:t,Wn=t=>t instanceof m?p.intrinsic.never.internal:t,$c=O({kind:"alias",hasAssociatedError:!1,collapsibleKey:"reference",keys:{reference:{serialize:t=>t.startsWith("$")?t:`$ark.${t}`},resolve:{}},normalize:wc,defaults:{description:t=>t.reference},intersections:{alias:(t,n,e)=>e.$.lazilyResolve(()=>Wn(P(t.resolution,n.resolution,e)),`${t.reference}${e.pipe?"=>":"&"}${n.reference}`),...De("alias",(t,n,e)=>n.isUnknown()?t:n.isNever()?n:e.$.lazilyResolve(()=>Wn(P(t.resolution,n,e)),`${t.reference}${e.pipe?"=>":"&"}${n.id}`))}});class kc extends Re{constructor(){super(...arguments);a(this,"expression",this.reference);a(this,"structure");a(this,"traverseAllows",(e,i)=>{const r=i.seen[this.reference];return r!=null&&r.includes(e)?!0:(i.seen[this.reference]=B(r,e),this.resolution.traverseAllows(e,i))});a(this,"traverseApply",(e,i)=>{const r=i.seen[this.reference];r!=null&&r.includes(e)||(i.seen[this.reference]=B(r,e),this.resolution.traverseApply(e,i))})}get resolution(){const e=this._resolve();return _[this.id]=e}_resolve(){if(this.resolve)return this.resolve();if(this.reference[0]==="$")return this.$.resolveRoot(this.reference.slice(1));const e=this.reference;let i=_[e];const r=[];for(;g(i,"context");){if(r.includes(i.id))return d(xc(i.id,r));r.push(i.id),i=_[i.id]}return g(i,"root")?i:L(`Unexpected resolution for reference ${this.reference}
Seen: [${r.join("->")}] 
Resolution: ${E(i)}`)}get resolutionId(){if(this.reference.includes("&")||this.reference.includes("=>"))return this.resolution.id;if(this.reference[0]!=="$")return this.reference;const e=this.reference.slice(1),i=this.$.resolutions[e];return typeof i=="string"?i:g(i,"root")?i.id:L(`Unexpected resolution for reference ${this.reference}: ${E(i)}`)}get shortDescription(){return ie.object}innerToJsonSchema(){return d(Ka(this.expression))}compile(e){const i=this.resolutionId;e.if(`ctx.seen.${i} && ctx.seen.${i}.includes(data)`,()=>e.return(!0)),e.if(`!ctx.seen.${i}`,()=>e.line(`ctx.seen.${i} = []`)),e.line(`ctx.seen.${i}.push(data)`),e.return(e.invoke(i))}}const xc=(t,n)=>`Alias '${t}' has a shallow resolution cycle: ${[...n,t].join("->")}`,$n={implementation:$c,Node:kc};class kn extends Re{constructor(){super(...arguments);a(this,"traverseApply",(e,i)=>{this.traverseAllows(e,i)||i.error(this.errorContext)})}get errorContext(){return{code:this.kind,description:this.description,...this.inner}}get compiledErrorContext(){return $t(this.errorContext)}compile(e){e.traversalKind==="Allows"?e.return(this.compiledCondition):e.if(this.compiledNegation,()=>e.line(`${e.ctx}.error(${this.compiledErrorContext})`))}}const Ac=O({kind:"domain",hasAssociatedError:!0,collapsibleKey:"domain",keys:{domain:{}},normalize:t=>typeof t=="string"?{domain:t}:t,defaults:{description:t=>ie[t.domain],actual:t=>ie[Z(t)]},intersections:{domain:(t,n)=>m.init("domain",t,n)}});class Sc extends kn{constructor(){super(...arguments);a(this,"traverseAllows",e=>Z(e)===this.domain);a(this,"compiledCondition",this.domain==="object"?'((typeof data === "object" && data !== null) || typeof data === "function")':`typeof data === "${this.domain}"`);a(this,"compiledNegation",this.domain==="object"?'((typeof data !== "object" || data === null) && typeof data !== "function")':`typeof data !== "${this.domain}"`);a(this,"expression",this.domain)}get shortDescription(){return ie[this.domain]}innerToJsonSchema(){return this.domain==="bigint"||this.domain==="symbol"?d(q(this.domain)):{type:this.domain}}}const qr={implementation:Ac,Node:Sc},Ic=O({kind:"intersection",hasAssociatedError:!0,normalize:t=>{if(J(t))return t;const{structure:n,...e}=t,i=!!n,r=n??{},s=T(e,(o,c)=>X(o,Sa)?(i&&d(`Flattened structure key ${o} cannot be specified alongside a root 'structure' key.`),r[o]=c,[]):[o,c]);return(g(r,"constraint")||!Se(r))&&(s.structure=r),s},finalizeInnerJson:({structure:t,...n})=>Ee(t,"object")?{...t,...n}:n,keys:{domain:{child:!0,parse:(t,n)=>n.$.node("domain",t)},proto:{child:!0,parse:(t,n)=>n.$.node("proto",t)},structure:{child:!0,parse:(t,n)=>n.$.node("structure",t),serialize:t=>{var o;if(!((o=t.sequence)!=null&&o.minLength))return t.collapsibleJson;const{sequence:n,...e}=t.collapsibleJson,{minVariadicLength:i,...r}=n,s=r.variadic&&Object.keys(r).length===1?r.variadic:r;return{...e,sequence:s}}},divisor:{child:!0,parse:K("divisor")},max:{child:!0,parse:K("max")},min:{child:!0,parse:K("min")},maxLength:{child:!0,parse:K("maxLength")},minLength:{child:!0,parse:K("minLength")},exactLength:{child:!0,parse:K("exactLength")},before:{child:!0,parse:K("before")},after:{child:!0,parse:K("after")},pattern:{child:!0,parse:K("pattern")},predicate:{child:!0,parse:K("predicate")}},reduce:(t,n)=>ft({},t,{$:n,invert:!1,pipe:!1}),defaults:{description:t=>{var n;return t.children.length===0?"unknown":((n=t.structure)==null?void 0:n.description)??t.children.map(e=>e.description).join(" and ")},expected:t=>`  • ${t.errors.map(n=>n.expected).join(`
  • `)}`,problem:t=>`(${t.actual}) must be...
${t.expected}`},intersections:{intersection:(t,n,e)=>ft(t,n,e),...De("intersection",(t,n,e)=>{var r;if(t.children.length===0)return n;const i=t.basis?P(t.basis,n,e):n;return i instanceof m?i:(r=t==null?void 0:t.basis)!=null&&r.equals(i)?t:t.$.node("intersection",{...t.inner,[i.kind]:i},{prereduced:!0})})}});class Tc extends Re{constructor(){super(...arguments);a(this,"basis",this.domain??this.proto??null);a(this,"refinements",this.children.filter(e=>e.isRefinement()));a(this,"traverseAllows",(e,i)=>this.children.every(r=>r.traverseAllows(e,i)));a(this,"traverseApply",(e,i)=>{const r=i.currentErrorCount;if(!(this.basis&&(this.basis.traverseApply(e,i),i.currentErrorCount>r))){if(this.refinements.length){for(let s=0;s<this.refinements.length-1;s++)if(this.refinements[s].traverseApply(e,i),i.failFast&&i.currentErrorCount>r)return;if(this.refinements.at(-1).traverseApply(e,i),i.currentErrorCount>r)return}if(!(this.structure&&(this.structure.traverseApply(e,i),i.currentErrorCount>r))&&this.predicate){for(let s=0;s<this.predicate.length-1;s++)if(this.predicate[s].traverseApply(e,i),i.failFast&&i.currentErrorCount>r)return;this.predicate.at(-1).traverseApply(e,i)}}})}get expression(){var i;let e=((i=this.structure)==null?void 0:i.expression)||`${this.basis?this.basis.nestableExpression+" ":""}${this.refinements.join(" & ")}`||"unknown";return e==="Array == 0"&&(e="[]"),this.cacheGetter("expression",e)}get shortDescription(){var e;return((e=this.basis)==null?void 0:e.shortDescription)??"present"}innerToJsonSchema(){return this.children.reduce((e,i)=>i.isBasis()?i.toJsonSchema():i.reduceJsonSchema(e),{})}compile(e){if(e.traversalKind==="Allows"){this.children.forEach(i=>e.check(i)),e.return(!0);return}if(e.initializeErrorCount(),this.basis&&(e.check(this.basis),this.children.length>1&&e.returnIfFail()),this.refinements.length){for(let i=0;i<this.refinements.length-1;i++)e.check(this.refinements[i]),e.returnIfFailFast();e.check(this.refinements.at(-1)),(this.structure||this.predicate)&&e.returnIfFail()}if(this.structure&&(e.check(this.structure),this.predicate&&e.returnIfFail()),this.predicate){for(let i=0;i<this.predicate.length-1;i++)e.check(this.predicate[i]),e.returnIfFail();e.check(this.predicate.at(-1))}}}const Kr={implementation:Ic,Node:Tc},ft=(t,n,e)=>{if(g(t,"root")&&t.hasKind("intersection"))return ft(t.inner,n,e);if(g(n,"root")&&n.hasKind("intersection"))return ft(t,n.inner,e);const i={},r=t.proto??t.domain,s=n.proto??n.domain,o=r?s?P(r,s,e):r:s;return o instanceof m?o:(o&&(i[o.kind]=o),ht({kind:"intersection",baseInner:i,l:dt(t),r:dt(n),roots:[],ctx:e}))},Ec=O({kind:"morph",hasAssociatedError:!1,keys:{in:{child:!0,parse:(t,n)=>n.$.parseSchema(t)},morphs:{parse:yt,serialize:t=>t.map(n=>g(n,"root")?n.json:V(n))},declaredIn:{child:!1,serialize:t=>t.json},declaredOut:{child:!1,serialize:t=>t.json}},normalize:t=>t,defaults:{description:t=>{var n;return`a morph from ${t.in.description} to ${((n=t.out)==null?void 0:n.description)??"unknown"}`}},intersections:{morph:(t,n,e)=>{if(!t.hasEqualMorphs(n))return d(Oc(t.expression,n.expression));const i=P(t.in,n.in,e);if(i instanceof m)return i;const r={morphs:t.morphs};if(t.declaredIn||n.declaredIn){const s=P(t.in,n.in,e);if(s instanceof m)return s.throw();r.declaredIn=s}if(t.declaredOut||n.declaredOut){const s=P(t.out,n.out,e);if(s instanceof m)return s.throw();r.declaredOut=s}return i.distribute(s=>e.$.node("morph",{...r,in:s}),e.$.parseSchema)},...De("morph",(t,n,e)=>{const i=P(t.in,n,e);return i instanceof m?i:i.distribute(r=>({...t.inner,in:r}),e.$.parseSchema)})}});class Nc extends Re{constructor(){super(...arguments);a(this,"serializedMorphs",this.morphs.map(V));a(this,"compiledMorphs",`[${this.serializedMorphs}]`);a(this,"lastMorph",this.inner.morphs.at(-1));a(this,"validatedIn",this.inner.in);a(this,"validatedOut",g(this.lastMorph,"root")?Object.assign(this.referencesById,this.lastMorph.out.referencesById)&&this.lastMorph.out:void 0);a(this,"expression",`(In: ${this.in.expression}) => Out<${this.out.expression}>`);a(this,"traverseAllows",(e,i)=>!this.validatedIn||this.validatedIn.traverseAllows(e,i));a(this,"traverseApply",(e,i)=>{this.validatedIn&&this.validatedIn.traverseApply(e,i),i.queueMorphs(this.morphs)})}get in(){return this.declaredIn??this.inner.in??p.intrinsic.unknown.internal}get out(){return this.declaredOut??this.validatedOut??p.intrinsic.unknown.internal}declareIn(e){return this.$.node("morph",{...this.inner,declaredIn:e})}declareOut(e){return this.$.node("morph",{...this.inner,declaredOut:e})}get shortDescription(){return this.in.shortDescription}innerToJsonSchema(){return d(qa(this.expression))}compile(e){if(e.traversalKind==="Allows"){if(!this.validatedIn)return;e.return(e.invoke(this.validatedIn));return}this.validatedIn&&e.line(e.invoke(this.validatedIn)),e.line(`ctx.queueMorphs(${this.compiledMorphs})`)}hasEqualMorphs(e){return et(this.morphs,e.morphs,{isEqual:(i,r)=>i===r||g(i,"root")&&g(r,"root")&&i.equals(r)})}}const _r={implementation:Ec,Node:Nc},Oc=(t,n)=>`The intersection of distinct morphs at a single path is indeterminate:
Left: ${t}
Right: ${n}`,Rc=O({kind:"proto",hasAssociatedError:!0,collapsibleKey:"proto",keys:{proto:{serialize:t=>dn(t)??ct(t)}},normalize:t=>typeof t=="string"?{proto:ge[t]}:typeof t=="function"?{proto:t}:typeof t.proto=="string"?{...t,proto:ge[t.proto]}:t,defaults:{description:t=>t.builtinName?Ho[t.builtinName]:`an instance of ${t.proto.name}`,actual:t=>Kt(t)},intersections:{proto:(t,n)=>qn(t.proto,n.proto)?t:qn(n.proto,t.proto)?n:m.init("proto",t,n),domain:(t,n)=>n.domain==="object"?t:m.init("domain",p.intrinsic.object.internal,n)}});class Dc extends kn{constructor(){super(...arguments);a(this,"builtinName",dn(this.proto));a(this,"serializedConstructor",this.json.proto);a(this,"compiledCondition",`data instanceof ${this.serializedConstructor}`);a(this,"compiledNegation",`!(${this.compiledCondition})`);a(this,"traverseAllows",e=>e instanceof this.proto);a(this,"expression",this.proto.name);a(this,"domain","object")}innerToJsonSchema(){switch(this.builtinName){case"Array":return{type:"array"};default:return d(q(this.description))}}get shortDescription(){return this.description}}const Ur={implementation:Rc,Node:Dc},Cc=O({kind:"union",hasAssociatedError:!0,collapsibleKey:"branches",keys:{ordered:{},branches:{child:!0,parse:(t,n)=>{const e=[];return t.forEach(i=>{(g(i,"root")?i.branches:n.$.parseSchema(i).branches).forEach(s=>{if(s.hasKind("morph")){const o=e.findIndex(c=>c.hasKind("morph")&&c.hasEqualMorphs(s));if(o===-1)e.push(s);else{const c=e[o];e[o]=n.$.node("morph",{...c.inner,in:c.in.rawOr(s.in)})}}else e.push(s)})}),n.def.ordered||e.sort((i,r)=>i.hash<r.hash?-1:1),e}}},normalize:t=>j(t)?{branches:t}:t,reduce:(t,n)=>{const e=_c(t);if(e.length===1)return e[0];if(e.length!==t.branches.length)return n.node("union",{...t,branches:e},{prereduced:!0})},defaults:{description:t=>t.distribute(n=>n.description,pe),expected:t=>{const n=tr(t.errors,"propString"),e=Object.entries(n).map(([i,r])=>{const s=[];r.forEach(l=>me(s,l.expected));const o=pe(s),c=r.every(l=>l.actual===r[0].actual)?r[0].actual:E(r[0].data);return`${i&&`${i} `}must be ${o}${c&&` (was ${c})`}`});return pe(e)},problem:t=>t.expected,message:t=>t.problem},intersections:{union:(t,n,e)=>{if(t.isNever!==n.isNever)return m.init("presence",t,n);let i;return t.ordered?(n.ordered&&d(jc(t.expression,n.expression)),i=Rt(n.branches,t.branches,e),i instanceof m&&i.invert()):i=Rt(t.branches,n.branches,e),i instanceof m?i:e.$.parseSchema(t.ordered||n.ordered?{branches:i,ordered:!0}:{branches:i})},...De("union",(t,n,e)=>{const i=Rt(t.branches,[n],e);return i instanceof m?i:i.length===1?i[0]:e.$.parseSchema(t.ordered?{branches:i,ordered:!0}:{branches:i})})}});class Mc extends Re{constructor(){super(...arguments);a(this,"isBoolean",this.branches.length===2&&this.branches[0].hasUnit(!1)&&this.branches[1].hasUnit(!0));a(this,"unitBranches",this.branches.filter(e=>e.in.hasKind("unit")));a(this,"discriminant",this.discriminate());a(this,"discriminantJson",this.discriminant?Lc(this.discriminant):null);a(this,"expression",this.distribute(e=>e.nestableExpression,Kc));a(this,"traverseAllows",(e,i)=>this.branches.some(r=>r.traverseAllows(e,i)));a(this,"traverseApply",(e,i)=>{const r=[];for(let s=0;s<this.branches.length;s++){if(i.pushBranch(),this.branches[s].traverseApply(e,i),!i.hasError())return this.branches[s].includesMorph?i.queuedMorphs.push(...i.popBranch().queuedMorphs):i.popBranch();r.push(i.popBranch().error)}i.error({code:"union",errors:r})})}get branchGroups(){const e=[];let i=-1;return this.branches.forEach(r=>{if(r.hasKind("unit")&&r.domain==="boolean"){i===-1?(i=e.length,e.push(r)):e[i]=p.intrinsic.boolean;return}e.push(r)}),e}get shortDescription(){return this.distribute(e=>e.shortDescription,pe)}innerToJsonSchema(){return{anyOf:this.branchGroups.map(e=>e.equals(p.intrinsic.boolean)?{type:"boolean"}:e.toJsonSchema())}}compile(e){if(!this.discriminant||this.unitBranches.length===this.branches.length&&this.branches.length===2)return this.compileIndiscriminable(e);let i=this.discriminant.optionallyChainedPropString;this.discriminant.kind==="domain"&&(i=`typeof ${i} === "object" ? ${i} === null ? "null" : "object" : typeof ${i} === "function" ? "object" : typeof ${i}`);const r=this.discriminant.cases,s=Object.keys(r);if(e.block(`switch(${i})`,()=>{for(const h in r){const f=r[h],y=h==="default"?h:`case ${h}`;e.line(`${y}: return ${f===!0?f:e.invoke(f)}`)}return e}),e.traversalKind==="Allows"){e.return(!1);return}const o=pe(this.discriminant.kind==="domain"?s.map(h=>{const f=h.slice(1,-1);return f==="function"?ie.object:ie[f]}):s),c=this.discriminant.path.map(h=>typeof h=="string"?JSON.stringify(h):V(h)),l=JSON.stringify(o),u=this.discriminant.kind==="domain"?`${Pc}[${i}]`:`${Bc}(${i})`;e.line(`ctx.error({
	expected: ${l},
	actual: ${u},
	relativePath: [${c}]
})`)}compileIndiscriminable(e){e.traversalKind==="Apply"?(e.const("errors","[]"),this.branches.forEach(i=>e.line("ctx.pushBranch()").line(e.invoke(i)).if("!ctx.hasError()",()=>e.return(i.includesMorph?"ctx.queuedMorphs.push(...ctx.popBranch().queuedMorphs)":"ctx.popBranch()")).line("errors.push(ctx.popBranch().error)")),e.line('ctx.error({ code: "union", errors })')):(this.branches.forEach(i=>e.if(`${e.invoke(i)}`,()=>e.return(!0))),e.return(!1))}get nestableExpression(){return this.isBoolean?"boolean":super.nestableExpression}discriminate(){if(this.branches.length<2)return null;if(this.unitBranches.length===this.branches.length){const c=T(this.unitBranches,(l,u)=>[`${u.in.serializedValue}`,u.hasKind("morph")?u:!0]);return{kind:"unit",path:[],optionallyChainedPropString:"data",cases:c}}const e=[];for(let c=0;c<this.branches.length-1;c++){const l=this.branches[c];for(let u=c+1;u<this.branches.length;u++){const h=this.branches[u],f=se(l.in,h.in,l.$);if(f instanceof m)for(const y of f){if(!y.kind||y.optional)continue;let w,x;if(y.kind==="domain"){const R=y.l,k=y.r;w=`"${typeof R=="string"?R:R.domain}"`,x=`"${typeof k=="string"?k:k.domain}"`}else if(y.kind==="unit")w=y.l.serializedValue,x=y.r.serializedValue;else continue;const M=e.find(R=>et(R.path,y.path)&&R.kind===y.kind);M?(M.cases[w]=me(M.cases[w],l),M.cases[x]=me(M.cases[x],h)):e.push({kind:y.kind,cases:{[w]:[l],[x]:[h]},path:y.path})}}}const i=e.sort((c,l)=>Object.keys(c.cases).length-Object.keys(l.cases).length).at(-1);if(!i)return null;let r=[...this.branches];const s={kind:i.kind,path:i.path,optionallyChainedPropString:Fr(i.path)},o=T(i.cases,(c,l)=>{const u=[];r=r.filter(f=>!l.includes(f));for(const f of l){const y=Fc(f,s);if(y===null)return[c,!0];u.push(y)}const h=u.length===1?u[0]:this.$.node("union",u);return Object.assign(this.referencesById,h.referencesById),[c,h]});return r.length&&(o.default=this.$.node("union",r,{prereduced:!0}),Object.assign(this.referencesById,o.default.referencesById)),Object.assign(s,{cases:o})}}const Fr=t=>t.reduce((n,e)=>n+pr(e,!0),"data"),Pc=V(Lo),Bc=V(E),zr={implementation:Cc,Node:Mc},Lc=t=>({kind:t.kind,path:t.path.map(n=>typeof n=="string"?n:vt(n)),cases:T(t.cases,(n,e)=>[n,e===!0?e:e.hasKind("union")&&e.discriminantJson?e.discriminantJson:e.json])}),qc={delimiter:" | ",finalDelimiter:" | "},Kc=t=>pe(t,qc),pe=(t,n)=>{const e=(n==null?void 0:n.delimiter)??", ",i=(n==null?void 0:n.finalDelimiter)??" or ";if(t.length===0)return"never";if(t.length===1)return t[0];if(t.length===2&&t[0]==="false"&&t[1]==="true"||t[0]==="true"&&t[1]==="false")return"boolean";const r={},s=t.filter(c=>r[c]?!1:r[c]=!0),o=s.pop();return`${s.join(e)}${s.length?i:""}${o}`},Rt=(t,n,e)=>{const i=n.map(()=>[]);for(let s=0;s<t.length;s++){let o={};for(let c=0;c<n.length;c++){if(i[c]===null)continue;if(t[s].equals(n[c])){i[c]=null,o={};break}const l=P(t[s],n[c],e);if(!(l instanceof m)){if(l.equals(t[s])){i[c].push(t[s]),o={};break}l.equals(n[c])?i[c]=null:o[c]=l}}for(const c in o)i[c][s]=o[c]}const r=i.flatMap((s,o)=>(s==null?void 0:s.flatMap(c=>c.branches))??n[o]);return r.length===0?m.init("union",t,n):r},_c=({branches:t,ordered:n})=>{if(t.length<2)return t;const e=t.map(()=>!0);for(let i=0;i<t.length;i++)for(let r=i+1;r<t.length&&e[i]&&e[r];r++){if(t[i].equals(t[r])){e[r]=!1;continue}const s=se(t[i].in,t[r].in,t[0].$);s instanceof m||(n||Uc(t[i],t[r]),s.equals(t[i].in)?e[i]=!!n:s.equals(t[r].in)&&(e[r]=!1))}return t.filter((i,r)=>e[r])},Uc=(t,n)=>{(t.includesMorph||n.includesMorph)&&(!et(t.shallowMorphs,n.shallowMorphs,{isEqual:(e,i)=>e.hasEqualMorphs(i)})||!et(t.flatMorphs,n.flatMorphs,{isEqual:(e,i)=>e.propString===i.propString&&e.node.hasEqualMorphs(i.node)}))&&d(zc(t.expression,n.expression))},Fc=(t,n)=>t.transform((e,i)=>e==="domain"||e==="unit"?null:i,{shouldTransform:(e,i)=>{const r=Fr(i.path);return n.optionallyChainedPropString.startsWith(r)?e.hasKind("domain")&&e.domain==="object"||(e.hasKind("domain")||n.kind==="unit")&&r===n.optionallyChainedPropString?!0:e.children.length!==0&&e.kind!=="index":!1}}),zc=(t,n)=>`An unordered union of a type including a morph and a type with overlapping input is indeterminate:
Left: ${t}
Right: ${n}`,jc=(t,n)=>`The intersection of two ordered unions is indeterminate:
Left: ${t}
Right: ${n}`,Vc=O({kind:"unit",hasAssociatedError:!0,keys:{unit:{preserveUndefined:!0,serialize:t=>t instanceof Date?t.toISOString():ct(t)}},normalize:t=>t,defaults:{description:t=>E(t.unit),problem:({expected:t,actual:n})=>`${t===n?`must be reference equal to ${t} (serialized to the same value)`:`must be ${t} (was ${n})`}`},intersections:{unit:(t,n)=>m.init("unit",t,n),...De("unit",(t,n)=>{if(n.allows(t.unit))return t;const e=n.hasKind("intersection")?n.basis:n;if(e){const i=e.hasKind("domain")?e:p.intrinsic.object;if(t.domain!==i.domain){const r=t.domain==="undefined"||t.domain==="null"||t.domain==="boolean"?t.domain:p.intrinsic[t.domain];return m.init("domain",r,i)}}return m.init("assignability",t,n.hasKind("intersection")?n.children.find(i=>!i.allows(t.unit)):n)})}});class Jc extends kn{constructor(){super(...arguments);a(this,"compiledValue",this.json.unit);a(this,"serializedValue",typeof this.unit=="string"||this.unit instanceof Date?JSON.stringify(this.compiledValue):`${this.compiledValue}`);a(this,"compiledCondition",Gn(this.unit,this.serializedValue));a(this,"compiledNegation",Gn(this.unit,this.serializedValue,"negated"));a(this,"expression",E(this.unit));a(this,"domain",Z(this.unit));a(this,"traverseAllows",this.unit instanceof Date?e=>e instanceof Date&&e.toISOString()===this.compiledValue:Number.isNaN(this.unit)?e=>Number.isNaN(e):e=>e===this.unit)}get shortDescription(){return this.domain==="object"?ie.object:this.description}innerToJsonSchema(){return p.intrinsic.jsonPrimitive.allows(this.unit)?{const:this.unit}:d(q(this.shortDescription))}}const jr={implementation:Vc,Node:Jc},Gn=(t,n,e)=>{if(t instanceof Date){const i=`data instanceof Date && data.toISOString() === ${n}`;return e?`!(${i})`:i}return Number.isNaN(t)?`${e?"!":""}Number.isNaN(data)`:`data ${e?"!":"="}== ${n}`},Hc=O({kind:"index",hasAssociatedError:!1,intersectionIsOpen:!0,keys:{signature:{child:!0,parse:(t,n)=>{const e=n.$.parseSchema(t);if(!e.extends(p.intrinsic.key))return d(Yc(e.expression));const i=e.branches.filter(r=>r.hasKind("unit"));return i.length?d(Gc(i.map(r=>E(r.unit)))):e}},value:{child:!0,parse:(t,n)=>n.$.parseSchema(t)}},normalize:t=>t,defaults:{description:t=>`[${t.signature.expression}]: ${t.value.description}`},intersections:{index:(t,n,e)=>{if(t.signature.equals(n.signature)){const i=P(t.value,n.value,e),r=i instanceof m?p.intrinsic.never.internal:i;return e.$.node("index",{signature:t.signature,value:r})}return t.signature.extends(n.signature)&&t.value.subsumes(n.value)?n:n.signature.extends(t.signature)&&n.value.subsumes(t.value)?t:null}}});class Wc extends be{constructor(){super(...arguments);a(this,"impliedBasis",p.intrinsic.object.internal);a(this,"expression",`[${this.signature.expression}]: ${this.value.expression}`);a(this,"traverseAllows",(e,i)=>qt(e).every(r=>{if(this.signature.traverseAllows(r[0],i)){i==null||i.path.push(r[0]);const s=this.value.traverseAllows(r[1],i);return i==null||i.path.pop(),s}return!0}));a(this,"traverseApply",(e,i)=>qt(e).forEach(r=>{this.signature.traverseAllows(r[0],i)&&(i.path.push(r[0]),this.value.traverseApply(r[1],i),i.path.pop())}))}_transform(e,i){i.path.push(this.signature);const r=super._transform(e,i);return i.path.pop(),r}get flatRefs(){return B(this.value.flatRefs.map(e=>te([this.signature,...e.path],e.node)),te([this.signature],this.value))}compile(){}}const Vr={implementation:Hc,Node:Wc},Gc=t=>`Index keys ${t.join(", ")} should be specified as named props.`,Yc=t=>`Indexed key definition '${t}' must be a string or symbol`,Ht=(t,n,e)=>{if(t.key!==n.key)return null;const i=t.key;let r=P(t.value,n.value,e);const s=t.required||n.required?"required":"optional";if(r instanceof m)if(s==="optional")r=p.intrinsic.never.internal;else return r.withPrefixKey(t.key,t.required&&n.required?"required":"optional");if(s==="required")return e.$.node("required",{key:i,value:r});const o=t.hasDefault()?n.hasDefault()?t.default===n.default?t.default:d(`Invalid intersection of default values ${E(t.default)} & ${E(n.default)}`):t.default:n.hasDefault()?n.default:tt;return e.$.node("optional",{key:i,value:r,default:o})};class Jr extends be{constructor(){super(...arguments);a(this,"required",this.kind==="required");a(this,"optional",this.kind==="optional");a(this,"impliedBasis",p.intrinsic.object.internal);a(this,"serializedKey",vt(this.key));a(this,"compiledKey",typeof this.key=="string"?this.key:this.serializedKey);a(this,"defaultValueMorphs",[e=>(e[this.key]=this.default,e)]);a(this,"defaultValueMorphsReference",V(this.defaultValueMorphs));a(this,"traverseAllows",(e,i)=>{if(this.key in e){i==null||i.path.push(this.key);const r=this.value.traverseAllows(e[this.key],i);return i==null||i.path.pop(),r}return this.optional});a(this,"traverseApply",(e,i)=>{this.key in e?(i.path.push(this.key),this.value.traverseApply(e[this.key],i),i.path.pop()):this.hasKind("required")?i.error(this.errorContext):this.hasKind("optional")&&this.hasDefault()&&i.queueMorphs(this.defaultValueMorphs)})}get flatRefs(){return B(this.value.flatRefs.map(e=>te([this.key,...e.path],e.node)),te([this.key],this.value))}_transform(e,i){i.path.push(this.key);const r=super._transform(e,i);return i.path.pop(),r}hasDefault(){return"default"in this}compile(e){e.if(`${this.serializedKey} in data`,()=>e.traverseKey(this.serializedKey,`data${e.prop(this.key)}`,this.value)),this.hasKind("required")?e.else(()=>e.traversalKind==="Apply"?e.line(`ctx.error(${this.compiledErrorContext})`):e.return(!1)):e.traversalKind==="Apply"&&"default"in this&&e.else(()=>e.line(`ctx.queueMorphs(${this.defaultValueMorphsReference})`)),e.traversalKind==="Allows"&&e.return(!0)}}const Zc=O({kind:"optional",hasAssociatedError:!1,intersectionIsOpen:!0,keys:{key:{},value:{child:!0,parse:(t,n)=>n.$.parseSchema(t)},default:{preserveUndefined:!0}},normalize:t=>t,defaults:{description:t=>`${t.compiledKey}?: ${t.value.description}`},intersections:{optional:Ht}});class Xc extends Jr{constructor(...e){super(...e);a(this,"expression",`${this.compiledKey}?: ${this.value.expression}`);if("default"in this.inner){const i=this.value.in(this.inner.default);i instanceof ye&&d(Qc(this.serializedKey,i.message))}}}const Hr={implementation:Zc,Node:Xc},Qc=(t,n)=>`Default value for key ${t} ${n}`,el=O({kind:"required",hasAssociatedError:!0,intersectionIsOpen:!0,keys:{key:{},value:{child:!0,parse:(t,n)=>n.$.parseSchema(t)}},normalize:t=>t,defaults:{description:t=>`${t.compiledKey}: ${t.value.description}`,expected:t=>t.missingValueDescription,actual:()=>"missing"},intersections:{required:Ht,optional:Ht}});class tl extends Jr{constructor(){super(...arguments);a(this,"expression",`${this.compiledKey}: ${this.value.expression}`);a(this,"errorContext",Object.freeze({code:"required",missingValueDescription:this.value.shortDescription,relativePath:[this.key]}));a(this,"compiledErrorContext",$t(this.errorContext))}}const Wr={implementation:el,Node:tl},Dt={child:!0,parse:(t,n)=>t.length===0?void 0:t.map(e=>n.$.parseSchema(e))},nl=O({kind:"sequence",hasAssociatedError:!1,collapsibleKey:"variadic",keys:{prefix:Dt,optionals:Dt,variadic:{child:!0,parse:(t,n)=>n.$.parseSchema(t,n)},minVariadicLength:{parse:t=>t===0?void 0:t},postfix:Dt},normalize:t=>{var n,e;if(typeof t=="string")return{variadic:t};if("variadic"in t||"prefix"in t||"optionals"in t||"postfix"in t||"minVariadicLength"in t){if((n=t.postfix)!=null&&n.length){if(!t.variadic)return d(ol);if((e=t.optionals)!=null&&e.length)return d(sl)}return t.minVariadicLength&&!t.variadic?d("minVariadicLength may not be specified without a variadic element"):t}return{variadic:t}},reduce:(t,n)=>{var o,c,l,u,h,f;let e=t.minVariadicLength??0;const i=((o=t.prefix)==null?void 0:o.slice())??[],r=((c=t.optionals)==null?void 0:c.slice())??[],s=((l=t.postfix)==null?void 0:l.slice())??[];if(t.variadic){for(;(u=r.at(-1))!=null&&u.equals(t.variadic);)r.pop();if(r.length===0)for(;(h=i.at(-1))!=null&&h.equals(t.variadic);)i.pop(),e++;for(;(f=s[0])!=null&&f.equals(t.variadic);)s.shift(),e++}else r.length===0&&i.push(...s.splice(0));if(e!==t.minVariadicLength||t.prefix&&t.prefix.length!==i.length)return n.node("sequence",{...t,prefix:i,postfix:s,optionals:r,minVariadicLength:e},{prereduced:!0})},defaults:{description:t=>t.isVariadicOnly?`${t.variadic.nestableExpression}[]`:`[${t.tuple.map(e=>e.kind==="optionals"?`${e.node.nestableExpression}?`:e.kind==="variadic"?`...${e.node.nestableExpression}[]`:e.node.expression).join(", ")}]`},intersections:{sequence:(t,n,e)=>{const i=xe({l:t.tuple,r:n.tuple,disjoint:new m,result:[],fixedVariants:[],ctx:e}),r=i.disjoint.length===0?[i,...i.fixedVariants]:i.fixedVariants;return r.length===0?i.disjoint:r.length===1?e.$.node("sequence",Yn(r[0].result)):e.$.node("union",r.map(s=>({proto:Array,sequence:Yn(s.result)})))}}});var zi,ji,Vi;class il extends be{constructor(){super(...arguments);a(this,"impliedBasis",p.intrinsic.Array.internal);a(this,"prefixLength",((zi=this.prefix)==null?void 0:zi.length)??0);a(this,"optionalsLength",((ji=this.optionals)==null?void 0:ji.length)??0);a(this,"postfixLength",((Vi=this.postfix)==null?void 0:Vi.length)??0);a(this,"prevariadic",Lt(this.prefix,this.optionals));a(this,"variadicOrPostfix",Lt(this.variadic&&[this.variadic],this.postfix));a(this,"isVariadicOnly",this.prevariadic.length+this.postfixLength===0);a(this,"minVariadicLength",this.inner.minVariadicLength??0);a(this,"minLength",this.prefixLength+this.minVariadicLength+this.postfixLength);a(this,"minLengthNode",this.minLength===0?null:this.$.node("minLength",this.minLength));a(this,"maxLength",this.variadic?null:this.minLength+this.optionalsLength);a(this,"maxLengthNode",this.maxLength===null?null:this.$.node("maxLength",this.maxLength));a(this,"impliedSiblings",this.minLengthNode?this.maxLengthNode?[this.minLengthNode,this.maxLengthNode]:[this.minLengthNode]:this.maxLengthNode?[this.maxLengthNode]:[]);a(this,"traverseAllows",(e,i)=>{for(let r=0;r<e.length;r++)if(!this.childAtIndex(e,r).traverseAllows(e[r],i))return!1;return!0});a(this,"traverseApply",(e,i)=>{for(let r=0;r<e.length;r++)i.path.push(r),this.childAtIndex(e,r).traverseApply(e[r],i),i.path.pop()});a(this,"tuple",rl(this.inner));a(this,"expression",this.description)}childAtIndex(e,i){if(i<this.prevariadic.length)return this.prevariadic[i];const r=e.length-this.postfixLength;return i>=r?this.postfix[i-r]:this.variadic??L(`Unexpected attempt to access index ${i} on ${this}`)}get flatRefs(){const e=[];return ut(e,this.prevariadic.flatMap((i,r)=>B(i.flatRefs.map(s=>te([`${r}`,...s.path],s.node)),te([`${r}`],i)))),ut(e,this.variadicOrPostfix.flatMap(i=>B(i.flatRefs.map(r=>te([p.intrinsic.nonNegativeIntegerString.internal,...r.path],r.node)),te([p.intrinsic.nonNegativeIntegerString.internal],i)))),e}get element(){return this.cacheGetter("element",this.$.node("union",this.children))}compile(e){var i,r,s;(i=this.prefix)==null||i.forEach((o,c)=>e.traverseKey(`${c}`,`data[${c}]`,o)),(r=this.optionals)==null||r.forEach((o,c)=>{const l=`${c+this.prefixLength}`;e.if(`${l} >= ${e.data}.length`,()=>e.traversalKind==="Allows"?e.return(!0):e.return()),e.traverseKey(l,`data[${l}]`,o)}),this.variadic&&(this.postfix&&e.const("firstPostfixIndex",`${e.data}.length${this.postfix?`- ${this.postfix.length}`:""}`),e.for(`i < ${this.postfix?"firstPostfixIndex":"data.length"}`,()=>e.traverseKey("i","data[i]",this.variadic),this.prevariadic.length),(s=this.postfix)==null||s.forEach((o,c)=>{const l=`firstPostfixIndex + ${c}`;e.traverseKey(l,`data[${l}]`,o)})),e.traversalKind==="Allows"&&e.return(!0)}_transform(e,i){i.path.push(p.intrinsic.nonNegativeIntegerString.internal);const r=super._transform(e,i);return i.path.pop(),r}reduceJsonSchema(e){var i;return this.prefix&&(e.prefixItems=this.prefix.map(r=>r.toJsonSchema())),this.optionals&&d(q(`Optional tuple element${this.optionalsLength>1?"s":""} ${this.optionals.join(", ")}`)),this.variadic?(e.items=(i=this.variadic)==null?void 0:i.toJsonSchema(),this.minLength&&(e.minItems=this.minLength),this.maxLength&&(e.maxItems=this.maxLength)):(e.items=!1,delete e.minItems,delete e.maxItems),this.postfix&&d(q(`Postfix tuple element${this.postfixLength>1?"s":""} ${this.postfix.join(", ")}`)),e}}const Gr={implementation:nl,Node:il},rl=t=>{var e,i,r;const n=[];return(e=t.prefix)==null||e.forEach(s=>n.push({kind:"prefix",node:s})),(i=t.optionals)==null||i.forEach(s=>n.push({kind:"optionals",node:s})),t.variadic&&n.push({kind:"variadic",node:t.variadic}),(r=t.postfix)==null||r.forEach(s=>n.push({kind:"postfix",node:s})),n},Yn=t=>t.reduce((n,e)=>(e.kind==="variadic"?n.variadic=e.node:n[e.kind]=B(n[e.kind],e.node),n),{}),sl="A postfix required element cannot follow an optional element",ol="A postfix element requires a variadic element",xe=t=>{var f,y;const[n,...e]=t.l,[i,...r]=t.r;if(!n||!i)return t;const s=((f=e.at(-1))==null?void 0:f.kind)==="postfix",o=((y=r.at(-1))==null?void 0:y.kind)==="postfix",c=n.kind==="prefix"||i.kind==="prefix"?"prefix":n.kind==="optionals"||i.kind==="optionals"?s||o?"prefix":"optionals":n.kind==="postfix"||i.kind==="postfix"?"postfix":"variadic";if(n.kind==="prefix"&&i.kind==="variadic"&&o){const w=xe({...t,fixedVariants:[],r:r.map(x=>({...x,kind:"prefix"}))});w.disjoint.length===0&&t.fixedVariants.push(w)}else if(i.kind==="prefix"&&n.kind==="variadic"&&s){const w=xe({...t,fixedVariants:[],l:e.map(x=>({...x,kind:"prefix"}))});w.disjoint.length===0&&t.fixedVariants.push(w)}const l=P(n.node,i.node,t.ctx);if(l instanceof m)if(c==="prefix"||c==="postfix")t.disjoint.push(...l.withPrefixKey(c==="prefix"?`${t.result.length}`:`-${e.length+1}`,"required")),t.result=[...t.result,{kind:c,node:p.intrinsic.never.internal}];else return c==="optionals"?t:xe({...t,fixedVariants:[],l:e.map(w=>({...w,kind:"prefix"})),r:e.map(w=>({...w,kind:"prefix"}))});else t.result=[...t.result,{kind:c,node:l}];const u=t.l.length,h=t.r.length;return(n.kind!=="variadic"||u>=h&&(i.kind==="variadic"||h===1))&&(t.l=e),(i.kind!=="variadic"||h>=u&&(n.kind==="variadic"||u===1))&&(t.r=r),xe(t)},Yr="^(?:0|[1-9]\\d*)$",al=new RegExp(Yr),cl=V(al),Zr=t=>n=>{var e,i;if(n.props.length||n.index){const r=((e=n.index)==null?void 0:e.map(String))??[];n.props.forEach(o=>r.push(o[t])),n.undeclared&&r.push(`+ (undeclared): ${n.undeclared}`);const s=`{ ${r.join(", ")} }`;return n.sequence?`${s} & ${n.sequence.description}`:s}return((i=n.sequence)==null?void 0:i.description)??"{}"},ll=Zr("description"),ul=Zr("expression"),hl=O({kind:"structure",hasAssociatedError:!1,normalize:(t,n)=>!t.undeclared&&n.resolvedConfig.onUndeclaredKey!=="ignore"?{...t,undeclared:n.resolvedConfig.onUndeclaredKey}:t,keys:{required:{child:!0,parse:K("required")},optional:{child:!0,parse:K("optional")},index:{child:!0,parse:K("index")},sequence:{child:!0,parse:K("sequence")},undeclared:{parse:t=>t==="ignore"?void 0:t}},defaults:{description:ll},intersections:{structure:(t,n,e)=>{const i={...t.inner},r={...n.inner};if(t.undeclared){const o=t.keyof(),c=n.requiredLiteralKeys.filter(l=>!o.allows(l));if(c.length)return new m(...c.map(l=>({kind:"presence",discriminantKind:void 0,l:p.intrinsic.never.internal,r:n.propsByKey[l].value,path:[l],optional:!1})));r.optional&&(r.optional=r.optional.filter(l=>o.allows(l.key))),r.index&&(r.index=r.index.flatMap(l=>{if(l.signature.extends(o))return l;const u=se(o,l.signature,e.$);if(u instanceof m)return[];const h=Wt(u,l.value,e.$);return h.required&&(r.required=r.required?[...r.required,...h.required]:h.required),h.index??[]}))}if(n.undeclared){const o=n.keyof(),c=t.requiredLiteralKeys.filter(l=>!o.allows(l));if(c.length)return new m(...c.map(l=>({kind:"presence",discriminantKind:void 0,l:t.propsByKey[l].value,r:p.intrinsic.never.internal,path:[l],optional:!1})));i.optional&&(i.optional=i.optional.filter(l=>o.allows(l.key))),i.index&&(i.index=i.index.flatMap(l=>{if(l.signature.extends(o))return l;const u=se(o,l.signature,e.$);if(u instanceof m)return[];const h=Wt(u,l.value,e.$);return h.required&&(i.required=i.required?[...i.required,...h.required]:h.required),h.index??[]}))}const s={};return(t.undeclared||n.undeclared)&&(s.undeclared=t.undeclared==="reject"||n.undeclared==="reject"?"reject":"delete"),ht({kind:"structure",baseInner:s,l:dt(i),r:dt(r),roots:[],ctx:e})}}});var Ji,Hi;class dl extends be{constructor(){super(...arguments);a(this,"impliedBasis",p.intrinsic.object.internal);a(this,"impliedSiblings",this.children.flatMap(e=>e.impliedSiblings??[]));a(this,"props",Lt(this.required,this.optional));a(this,"propsByKey",T(this.props,(e,i)=>[i.key,i]));a(this,"propsByKeyReference",V(this.propsByKey));a(this,"expression",ul(this));a(this,"requiredLiteralKeys",((Ji=this.required)==null?void 0:Ji.map(e=>e.key))??[]);a(this,"optionalLiteralKeys",((Hi=this.optional)==null?void 0:Hi.map(e=>e.key))??[]);a(this,"literalKeys",[...this.requiredLiteralKeys,...this.optionalLiteralKeys]);a(this,"entries",this.props.map(e=>[e.key,e.value,e.kind]));a(this,"_keyof");a(this,"exhaustive",this.undeclared!==void 0||this.index!==void 0);a(this,"traverseAllows",(e,i)=>this._traverse("Allows",e,i));a(this,"traverseApply",(e,i)=>this._traverse("Apply",e,i));a(this,"_traverse",(e,i,r)=>{const s=(r==null?void 0:r.currentErrorCount)??0;for(let c=0;c<this.props.length;c++)if(e==="Allows"){if(!this.props[c].traverseAllows(i,r))return!1}else if(this.props[c].traverseApply(i,r),r.failFast&&r.currentErrorCount>s)return!1;if(this.sequence){if(e==="Allows"){if(!this.sequence.traverseAllows(i,r))return!1}else if(this.sequence.traverseApply(i,r),r.failFast&&r.currentErrorCount>s)return!1}if(!this.exhaustive)return!0;const o=Object.keys(i);o.push(...Object.getOwnPropertySymbols(i));for(let c=0;c<o.length;c++){const l=o[c];let u=!1;if(this.index){for(const h of this.index)if(h.signature.traverseAllows(l,r)){if(e==="Allows"){r==null||r.path.push(l);const f=h.value.traverseAllows(i[l],r);if(r==null||r.path.pop(),!f)return!1}else if(r.path.push(l),h.value.traverseApply(i[l],r),r.path.pop(),r.failFast&&r.currentErrorCount>s)return!1;u=!0}}if(this.undeclared&&(u||(u=l in this.propsByKey),u||(u=this.sequence!==void 0&&typeof l=="string"&&p.intrinsic.nonNegativeIntegerString.allows(l)),!u&&(e==="Allows"||(this.undeclared==="reject"?r.error({expected:"removed",actual:"",relativePath:[l]}):r.queueMorphs([h=>(delete h[l],h)]),r.failFast))))return!1;r==null||r.path.pop()}return!0})}keyof(){var i;if(this._keyof)return this._keyof;let e=this.$.units(this.literalKeys).branches;return(i=this.index)==null||i.forEach(({signature:r})=>{e=e.concat(r.branches)}),this._keyof=this.$.node("union",e)}map(e){const i={};return this.entries.forEach(r=>{const s=e(r);if(Array.isArray(s[0])||s.length===0)return s.forEach(o=>Zn(this,i,o));Zn(this,i,s)}),this.$.node("structure",i)}assertHasKeys(e){const i=e.filter(r=>!_e(r,this.keyof()));if(i.length)return d(Xn(this.expression,i))}get(e,...i){var l,u;let r,s=!1;const o=pl(e);if((typeof o=="string"||typeof o=="symbol")&&this.propsByKey[o]&&(r=this.propsByKey[o].value,s=this.propsByKey[o].required),(l=this.index)==null||l.forEach(h=>{_e(o,h.signature)&&(r=(r==null?void 0:r.and(h.value))??h.value)}),this.sequence&&_e(o,p.intrinsic.nonNegativeIntegerString))if(g(o,"root"))this.sequence.variadic&&(r=(r==null?void 0:r.and(this.sequence.element))??this.sequence.element);else{const h=Number.parseInt(o);if(h<this.sequence.prevariadic.length){const f=this.sequence.prevariadic[h];r=(r==null?void 0:r.and(f))??f,s||(s=h<this.sequence.prefixLength)}else if(this.sequence.variadic){const f=this.$.node("union",this.sequence.variadicOrPostfix);r=(r==null?void 0:r.and(f))??f}}if(!r)return(u=this.sequence)!=null&&u.variadic&&g(o,"root")&&o.extends(p.intrinsic.number)?d(fl(o.expression,this.sequence.expression)):d(Xn(this.expression,[o]));const c=r.get(...i);return s?c:c.or(p.intrinsic.undefined)}pick(...e){return this.assertHasKeys(e),this.$.node("structure",this.filterKeys("pick",e))}omit(...e){return this.assertHasKeys(e),this.$.node("structure",this.filterKeys("omit",e))}optionalize(){const{required:e,...i}=this.inner;return this.$.node("structure",{...i,optional:this.props.map(r=>r.hasKind("required")?this.$.node("optional",r.inner):r)})}require(){const{optional:e,...i}=this.inner;return this.$.node("structure",{...i,required:this.props.map(r=>r.hasKind("optional")?this.$.node("required",{key:r.key,value:r.value}):r)})}merge(e){const i=this.filterKeys("omit",[e.keyof()]);return e.required&&(i.required=B(i.required,e.required)),e.optional&&(i.optional=B(i.optional,e.optional)),e.index&&(i.index=B(i.index,e.index)),e.sequence&&(i.sequence=e.sequence),e.undeclared?i.undeclared=e.undeclared:delete i.undeclared,this.$.node("structure",i)}filterKeys(e,i){const r=mr(this.inner),s=o=>{const c=i.some(l=>_e(o,l));return e==="pick"?c:!c};return r.required&&(r.required=r.required.filter(o=>s(o.key))),r.optional&&(r.optional=r.optional.filter(o=>s(o.key))),r.index&&(r.index=r.index.filter(o=>s(o.signature))),r}compile(e){e.traversalKind==="Apply"&&e.initializeErrorCount(),this.props.forEach(i=>{e.check(i),e.traversalKind==="Apply"&&e.returnIfFailFast()}),this.sequence&&(e.check(this.sequence),e.traversalKind==="Apply"&&e.returnIfFailFast()),this.exhaustive&&(e.const("keys","Object.keys(data)"),e.line("keys.push(...Object.getOwnPropertySymbols(data))"),e.for("i < keys.length",()=>this.compileExhaustiveEntry(e))),e.traversalKind==="Allows"&&e.return(!0)}compileExhaustiveEntry(e){var i,r;return e.const("k","keys[i]"),this.undeclared&&e.let("matched",!1),(i=this.index)==null||i.forEach(s=>{e.if(`${e.invoke(s.signature,{arg:"k",kind:"Allows"})}`,()=>(e.traverseKey("k","data[k]",s.value),this.undeclared&&e.set("matched",!0),e))}),this.undeclared&&(((r=this.props)==null?void 0:r.length)!==0&&e.line(`matched ||= k in ${this.propsByKeyReference}`),this.sequence&&e.line(`matched ||= typeof k === "string" && ${cl}.test(k)`),e.if("!matched",()=>e.traversalKind==="Allows"?e.return(!1):this.undeclared==="reject"?e.line('ctx.error({ expected: "removed", actual: "", relativePath: [k] })').if("ctx.failFast",()=>e.return()):e.line("ctx.queueMorphs([data => { delete data[k]; return data }])"))),e}reduceJsonSchema(e){var i;switch(e.type){case"object":return this.reduceObjectJsonSchema(e);case"array":return(this.props.length||this.index)&&d(q(`Additional properties on array ${this.expression}`)),((i=this.sequence)==null?void 0:i.reduceJsonSchema(e))??e;default:return xt("structure",e)}}reduceObjectJsonSchema(e){var i;return this.props.length&&(e.properties={},this.props.forEach(r=>{if(typeof r.key=="symbol")return d(q(`Sybolic key ${r.serializedKey}`));e.properties[r.key]=r.value.toJsonSchema()}),this.requiredLiteralKeys.length&&(e.required=this.requiredLiteralKeys)),(i=this.index)==null||i.forEach(r=>{if(r.signature.equals(p.intrinsic.string))return e.additionalProperties=r.value.toJsonSchema();if(!r.signature.extends(p.intrinsic.string))return d(q(`Symbolic index signature ${r.signature.exclude(p.intrinsic.string)}`));r.signature.branches.forEach(s=>{var o;if(!s.hasKind("intersection")||((o=s.pattern)==null?void 0:o.length)!==1)return d(q(`Index signature ${s}`));e.patternProperties??(e.patternProperties={}),e.patternProperties[s.pattern[0].rule]=r.value.toJsonSchema()})}),this.undeclared&&!e.additionalProperties&&(e.additionalProperties=!1),e}}const Zn=(t,n,[e,i,r])=>{const s=t.propsByKey[e],o=r??(s==null?void 0:s.kind)??"required";return n[o]=B(n[o],s&&o===s.kind&&i===s.value?s:t.$.node(o,{key:e,value:i}))},Xr={implementation:hl,Node:dl},pl=t=>(g(t,"root")&&t.hasKind("unit")&&(t=t.unit),typeof t=="number"&&(t=`${t}`),t),fl=(t,n)=>`${t} is not allowed as an array index on ${n}. Use the 'nonNegativeIntegerString' keyword instead.`,Wt=(t,n,e)=>{const[i,r]=Po(t.branches,o=>o.hasKind("unit"));if(!i.length)return{index:e.node("index",{signature:t,value:n})};const s={};return s.required=i.map(o=>e.node("required",{key:o.unit,value:n})),r.length&&(s.index=e.node("index",{signature:r,value:n})),s},ml=t=>g(t,"root")?t.expression:E(t),Xn=(t,n)=>`Key${n.length===1?"":"s"} ${n.map(ml).join(", ")} ${n.length===1?"does":"do"} not exist on ${t}`,At={...dc,alias:$n.implementation,domain:qr.implementation,unit:jr.implementation,proto:Ur.implementation,union:zr.implementation,morph:_r.implementation,intersection:Kr.implementation,divisor:xr.implementation,pattern:Pr.implementation,predicate:kr.implementation,required:Wr.implementation,optional:Hr.implementation,index:Vr.implementation,sequence:Gr.implementation,structure:Xr.implementation};p.defaultConfig=Object.assign(T(At,(t,n)=>[t,n.defaults]),{jitless:ea(),clone:Wo,onUndeclaredKey:"ignore"});const gl={...pc,alias:$n.Node,domain:qr.Node,unit:jr.Node,proto:Ur.Node,union:zr.Node,morph:_r.Node,intersection:Kr.Node,divisor:xr.Node,pattern:Pr.Node,predicate:kr.Node,required:Wr.Node,optional:Hr.Node,index:Vr.Node,sequence:Gr.Node,structure:Xr.Node};class We extends qo{get[re](){return"module"}}const Qr=(t,n)=>new We(T(t,(e,i)=>[e,g(i,"module")?Qr(i,n):n.bindReference(i)])),yl=t=>j(t)?t:"branches"in t&&j(t.branches)?t.branches:void 0,bl=(t,n)=>d(`Node of kind ${n} is not valid as a ${t} definition`),Qn=t=>`#${t} duplicates public alias ${t}`,ei={};p.ambient??(p.ambient={});let ti;class es{constructor(n,e){a(this,"config");a(this,"resolvedConfig");a(this,"id",`${Object.keys(ei).length}$`);a(this,"referencesById",{});a(this,"references",[]);a(this,"resolutions",{});a(this,"json",{});a(this,"exportedNames",[]);a(this,"aliases",{});a(this,"resolved",!1);a(this,"nodesByHash",{});a(this,"generic",(...n)=>{const e=this;return(i,r)=>new pt(n,r?new $r(i):i,e,e)});a(this,"units",(n,e)=>{const i=[];for(const s of n)i.includes(s)||i.push(s);const r=i.map(s=>this.node("unit",{unit:s},e));return this.node("union",r,{...e,prereduced:!0})});a(this,"lazyResolutions",[]);a(this,"schema",(n,e)=>this.finalize(this.parseSchema(n,e)));a(this,"parseSchema",(n,e)=>this.node(He(n),n,e));a(this,"precompilation");a(this,"_exportedResolutions");a(this,"_exports");a(this,"node",(n,e,i={})=>{const r=this.preparseNode(n,e,i);if(J(r))return this.bindReference(r);const s=this.createParseContext(r);return _[s.id]=this.bindReference(Lr(s))});a(this,"parse",(n,e={})=>this.finalize(this.parseDefinition(n,e)));this.config=e??{},this.resolvedConfig=Ta(e),Object.entries(n).map(r=>this.preparseOwnAliasEntry(...r)).forEach(([r,s])=>{let o=r;if(r[0]==="#"?(o=r.slice(1),o in this.aliases&&d(Qn(o)),this.aliases[o]=s):(o in this.aliases&&d(Qn(r)),this.aliases[o]=s,this.exportedNames.push(o)),!g(s,"module")&&!g(s,"generic")&&!pn(s)){const c=this.preparseOwnDefinitionFormat(s,{alias:o});g(c,"root")?this.resolutions[o]=this.bindReference(c):this.resolutions[o]=this.createParseContext(c).id}}),ti??(ti=this.node("union",{branches:["string","number","object","bigint","symbol",{unit:!0},{unit:!1},{unit:void 0},{unit:null}]},{prereduced:!0})),this.nodesByHash[ti.hash]=this.node("intersection",{},{prereduced:!0}),ei[this.id]=this}get[re](){return"scope"}get internal(){return this}defineSchema(n){return n}lazilyResolve(n,e){const i=this.node("alias",{reference:e??"synthetic",resolve:n},{prereduced:!0});return this.resolved||this.lazyResolutions.push(i),i}preparseNode(n,e,i){var c;let r=typeof n=="string"?n:He(e,n);if(J(e)&&e.kind===r)return e;if(r==="alias"&&!(i!=null&&i.prereduced)){const{reference:l}=$n.implementation.normalize(e,this);if(l.startsWith("$")){const u=this.resolveRoot(l.slice(1));e=u,r=u.kind}}else if(r==="union"&&Ee(e,"object")){const l=yl(e);(l==null?void 0:l.length)===1&&(e=l[0],r=He(e))}const s=At[r],o=((c=s.normalize)==null?void 0:c.call(s,e,this))??e;return J(o)?o.kind===r?o:bl(r,o.kind):{...i,$:this,kind:r,def:o,prefix:i.alias??r}}bindReference(n){const e=n.$===this?n:J(n)?new n.constructor(n.attachments,this):new pt(n.params,n.bodyDef,n.$,this);return this.resolved||Object.assign(this.referencesById,e.referencesById),e}resolveRoot(n){return this.maybeResolveRoot(n)??d(rs(n))}maybeResolveRoot(n){const e=this.maybeResolve(n);if(!g(e,"generic"))return e}maybeResolveSubalias(n){return Gt(this.aliases,n)??Gt(this.ambient,n)}get ambient(){return p.ambient}maybeResolve(n){var r;const e=this.resolutions[n];if(e){if(typeof e!="string")return e;const s=_[e];if(g(s,"root"))return this.resolutions[n]=s;if(g(s,"context")){if(s.phase==="resolving")return this.node("alias",{reference:`$${n}`},{prereduced:!0});if(s.phase==="resolved")return L(`Unexpected resolved context for was uncached by its scope: ${E(s)}`);s.phase="resolving";const o=this.bindReference(this.parseOwnDefinitionFormat(s.def,s));return s.phase="resolved",_[o.id]=o,_[s.id]=o,this.resolutions[n]=o}return L(`Unexpected nodesById entry for ${e}: ${E(s)}`)}let i=this.aliases[n]??((r=this.ambient)==null?void 0:r[n]);return i?(i=this.normalizeRootScopeValue(i),g(i,"generic")?this.resolutions[n]=this.bindReference(i):g(i,"module")?i.root?this.resolutions[n]=this.bindReference(i.root):d(ss(n)):this.resolutions[n]=this.parse(i,{alias:n})):this.maybeResolveSubalias(n)}createParseContext(n){const e=n.id??Br(n.prefix);return _[e]=Object.assign(n,{[re]:"context",$:this,id:e,phase:"unresolved"})}import(...n){return new We(T(this.export(...n),(e,i)=>[`#${e}`,i]))}export(...n){if(!this._exports){this._exports={};for(const i of this.exportedNames){const r=this.aliases[i];this._exports[i]=g(r,"module")?Qr(r,this):ni(this.maybeResolve(i))}this.lazyResolutions.forEach(i=>i.resolution),this.resolvedConfig.ambient===!0?Object.assign(p.ambient,this._exports):typeof this.resolvedConfig.ambient=="string"&&Object.assign(p.ambient,{[this.resolvedConfig.ambient]:new We({...this._exports})}),this._exportedResolutions=is(this,this._exports),Object.assign(this.json,ns(this._exportedResolutions)),Object.assign(this.resolutions,this._exportedResolutions),this.references=Object.values(this.referencesById),this.resolvedConfig.jitless||(this.precompilation=as(this.references),os(this.references,this.precompilation)),this.resolved=!0}const e=n.length?n:this.exportedNames;return new We(T(e,(i,r)=>[r,this._exports[r]]))}resolve(n){return this.export()[n]}parseDefinition(n,e={}){if(g(n,"root"))return this.bindReference(n);const i=this.preparseOwnDefinitionFormat(n,e);if(g(i,"root"))return this.bindReference(i);const r=this.createParseContext(i);_[r.id]=r;let s=this.bindReference(this.parseOwnDefinitionFormat(n,r));return s.isCyclic&&(s=bc(s,r.id)),_[r.id]=s,s}finalize(n){return ni(n),!n.precompilation&&!this.resolvedConfig.jitless&&wl(n.references),n}}class ts extends es{parseOwnDefinitionFormat(n,e){return Lr(e)}preparseOwnDefinitionFormat(n,e){return this.preparseNode(He(n),n,e)}preparseOwnAliasEntry(n,e){return[n,e]}normalizeRootScopeValue(n){return n}}const ni=t=>(t.references.filter(n=>n.hasKind("alias")).forEach(n=>{Object.assign(n.referencesById,n.resolution.referencesById),t.references.forEach(e=>{n.id in e.referencesById&&Object.assign(e.referencesById,n.referencesById)})}),t),ns=t=>T(t,(n,e)=>[n,g(e,"root")||g(e,"generic")?e.json:g(e,"module")?ns(e):L(`Unexpected resolution ${E(e)}`)]),Gt=(t,n)=>{const e=n.indexOf(".");if(e===-1)return;const i=n.slice(0,e),r=t[i];if(r===void 0)return;if(!g(r,"module"))return d(vl(i));const s=n.slice(e+1),o=r[s];if(o===void 0)return Gt(r,s);if(g(o,"root")||g(o,"generic"))return o;if(g(o,"module"))return o.root??d(ss(n));L(`Unexpected resolution for alias '${n}': ${E(o)}`)},xn=(t,n)=>new ts(t,n),Ce=new ts({}),is=(t,n)=>{const e={};for(const i in n){const r=n[i];if(g(r,"module")){const s=is(t,r),o=T(s,(c,l)=>[`${i}.${c}`,l]);Object.assign(e,o)}else g(r,"root")||g(r,"generic")?e[i]=r:L(`Unexpected scope resolution ${E(r)}`)}return e},rs=t=>`'${t}' is unresolvable`,vl=t=>`'${t}' must reference a module to be accessed using dot syntax`,ss=t=>`Reference to submodule '${t}' must specify an alias`,wl=t=>os(t,as(t)),os=(t,n)=>{const e=$l(n);for(const i of t)i.precompilation||(i.traverseAllows=e[`${i.id}Allows`].bind(e),i.isRoot()&&!i.allowsRequiresContext&&(i.allows=i.traverseAllows),i.traverseApply=e[`${i.id}Apply`].bind(e),i.precompilation=n)},$l=t=>new dr().return(t).compile()(),as=t=>t.reduce((n,e)=>{const i=new _n("Allows").indent();e.compile(i);const r=i.write(`${e.id}Allows`),s=new _n("Apply").indent();e.compile(s);const o=s.write(`${e.id}Apply`);return`${n}${r},
${o},
`},`{
`)+"}";Ce.export();const S=Ce.schema,cs=Ce.node;Ce.defineSchema;const Q=Ce.generic,ls=xn({bigint:"bigint",boolean:[{unit:!1},{unit:!0}],false:{unit:!1},never:[],null:{unit:null},number:"number",object:"object",string:"string",symbol:"symbol",true:{unit:!0},unknown:{},undefined:{unit:void 0},Array,Date},{prereducedAliases:!0}).export();p.intrinsic={...ls};const us=xn({integer:{domain:"number",divisor:1},lengthBoundable:["string",Array],key:["string","symbol"],nonNegativeIntegerString:{domain:"string",pattern:Yr}},{prereducedAliases:!0}).export();Object.assign(p.intrinsic,us);const kl=xn({jsonPrimitive:["string","number",{unit:!0},{unit:!1},{unit:null}],jsonObject:{domain:"object",index:{signature:"string",value:"$jsonData"}},jsonArray:{proto:Array,sequence:"$jsonData"},jsonData:["$jsonPrimitive","$jsonObject","$jsonArray"],json:["$jsonObject","$jsonArray"]},{prereducedAliases:!0}).export(),b={...ls,...us,...kl,emptyStructure:cs("structure",{},{prereduced:!0})};p.intrinsic={...b};const xl=t=>typeof t=="string"&&t[0]==="d"&&(t[1]==="'"||t[1]==='"')&&t.at(-1)===t[1],ii=t=>t.toString()!=="Invalid Date",Al=t=>t.slice(2,-1),hs=t=>`'${t}' could not be parsed by the Date constructor`,Sl=(t,n)=>Il(t,n),Il=(t,n)=>{const e=new Date(t);if(ii(e))return e;const i=la(t);if(i!==void 0){const r=new Date(i);if(ii(r))return r}return n?d(n===!0?hs(t):n):void 0},ri=(t,n)=>{const e=t.scanner.shiftUntil(El[ps[n]]);if(t.scanner.lookahead==="")return t.error(Ol(e,n));if(t.scanner.shift(),n==="/"){try{new RegExp(e)}catch(i){d(String(i))}t.root=t.ctx.$.node("intersection",{domain:"string",pattern:e},{prereduced:!0})}else if(X(n,ds))t.root=t.ctx.$.node("unit",{unit:e});else{const i=Sl(e,hs(e));t.root=t.ctx.$.node("unit",{meta:e,unit:i})}},ds={"'":1,'"':1},Tl={"/":1,"'":1,'"':1},ps={"d'":"'",'d"':'"',"'":"'",'"':'"',"/":"/"},El={"'":t=>t.lookahead==="'",'"':t=>t.lookahead==='"',"/":t=>t.lookahead==="/"},Nl={'"':"double-quote","'":"single-quote","/":"forward slash"},Ol=(t,n)=>`${n}${t} requires a closing ${Nl[ps[n]]}`,Rl=t=>`Private type references should not include '#'. Use '${t.slice(1)}' instead.`,Dl={">":!0,">=":!0},Cl={"<":!0,"<=":!0},mt={"<":">",">":"<","<=":">=",">=":"<=","==":"=="},Ml=t=>`Unmatched )${t===""?"":` before ${t}`}`,fs=t=>`Missing ${t}`,Pl=(t,n)=>`Left bounds are only valid when paired with right bounds (try ...${n}${t})`,ms=t=>`Left-bounded expressions must specify their limits using < or <= (was ${t})`,Bl=(t,n,e,i)=>`An expression may have at most one left bound (parsed ${t}${mt[n]}, ${e}${mt[i]})`,Ll=(t,n,e)=>gs(t,n,e,[]),gs=(t,n,e,i)=>{const r=e.parseUntilFinalizer();return i.push(r.root),r.finalizer===">"?i.length!==n.params.length?e.error(ys(t,n.names,i.map(s=>s.expression))):i:r.finalizer===","?gs(t,n,e,i):r.error(fs(">"))},ys=(t,n,e)=>`${t}<${n.join(", ")}> requires exactly ${n.length} args (got ${e.length}${e.length===0?"":`: ${e.join(", ")}`})`,si=t=>{const n=t.scanner.shiftUntilNextTerminator();n==="keyof"?t.addPrefix("keyof"):t.root=Kl(t,n)},ql=(t,n,e)=>{if(e.scanner.shiftUntilNonWhitespace(),e.scanner.shift()!=="<")return e.error(ys(t,n.names,[]));const r=Ll(t,n,e);return n(...r)},Kl=(t,n)=>_l(t,n)??Ul(t,n)??t.error(n===""?bs(t):n[0]==="#"?Rl(n):rs(n)),_l=(t,n)=>{var i;if((i=t.ctx.args)!=null&&i[n]){const r=t.ctx.args[n];return typeof r!="string"?r:t.ctx.$.node("alias",{reference:r},{prereduced:!0})}const e=t.ctx.$.maybeResolve(n);if(g(e,"root"))return e;if(e!==void 0)return g(e,"generic")?ql(n,e,t):d(`Unexpected resolution ${E(e)}`)},Ul=(t,n)=>{const e=ua(n);if(e!==void 0)return t.ctx.$.node("unit",{unit:e});const i=da(n);if(i!==void 0)return t.ctx.$.node("unit",{unit:i})},bs=t=>{const n=t.previousOperator();return n?vs(n,t.scanner.unscanned):Fl(t.scanner.unscanned)},vs=(t,n="")=>`Token '${t}' requires a right operand${n?` before '${n}'`:""}`,Fl=t=>`Expected an expression${t?` before '${t}'`:""}`,ws=t=>t.scanner.lookahead===""?t.error(bs(t)):t.scanner.lookahead==="("?t.shiftedByOne().reduceGroupOpen():t.scanner.lookaheadIsIn(Tl)?ri(t,t.scanner.shift()):t.scanner.lookaheadIsIn(ot)?ws(t.shiftedByOne()):t.scanner.lookahead==="d"&&t.scanner.nextLookahead in ds?ri(t,`${t.scanner.shift()}${t.scanner.shift()}`):si(t),F=class F{constructor(n){a(this,"chars");a(this,"i");this.chars=[...n],this.i=0}shift(){return this.chars[this.i++]??""}get lookahead(){return this.chars[this.i]??""}get nextLookahead(){return this.chars[this.i+1]??""}get length(){return this.chars.length}shiftUntil(n){let e="";for(;this.lookahead;){if(n(this,e))if(e[e.length-1]===zt)e=e.slice(0,-1);else break;e+=this.shift()}return e}shiftUntilNextTerminator(){return this.shiftUntilNonWhitespace(),this.shiftUntil(F.lookaheadIsTerminator)}shiftUntilNonWhitespace(){return this.shiftUntil(F.lookaheadIsNotWhitespace)}jumpToIndex(n){this.i=n<0?this.length+n:n}jumpForward(n){this.i+=n}get location(){return this.i}get unscanned(){return this.chars.slice(this.i,this.length).join("")}get scanned(){return this.chars.slice(0,this.i).join("")}sliceChars(n,e){return this.chars.slice(n,e).join("")}lookaheadIs(n){return this.lookahead===n}lookaheadIsIn(n){return this.lookahead in n}};a(F,"terminatingChars",{"<":!0,">":!0,"=":!0,"|":!0,"&":!0,")":!0,"[":!0,"%":!0,",":!0,":":!0,...ot}),a(F,"finalizingLookaheads",{">":!0,",":!0,"":!0,"=":!0}),a(F,"lookaheadIsTerminator",n=>n.lookahead in F.terminatingChars),a(F,"lookaheadIsNotWhitespace",n=>!(n.lookahead in ot)),a(F,"lookaheadIsFinalizing",(n,e)=>n===">"?e[0]==="="?e[1]==="=":e.trimStart()===""||X(e.trimStart()[0],F.terminatingChars):n==="="?e[0]!=="=":n===",");let Te=F;const zl=(t,n)=>{const e=Vl(t,n);if(t.root.hasKind("unit")){if(typeof t.root.unit=="number"){t.reduceLeftBound(t.root.unit,e),t.unsetRoot();return}if(t.root.unit instanceof Date){const i=`d'${t.root.description??t.root.unit.toISOString()}'`;t.unsetRoot(),t.reduceLeftBound(i,e);return}}return Hl(t,e)},jl={"<":1,">":1,"=":1},Vl=(t,n)=>t.scanner.lookaheadIs("=")?`${n}${t.scanner.shift()}`:n,oi=(t,n,e,i)=>e.extends(p.intrinsic.number)?typeof n!="number"?d(Yt(t,n,i)):t==="=="?["min","max"]:t[0]===">"?["min"]:["max"]:e.extends(p.intrinsic.lengthBoundable)?typeof n!="number"?d(Yt(t,n,i)):t==="=="?["minLength","maxLength"]:t[0]===">"?["minLength"]:["maxLength"]:e.extends(p.intrinsic.Date)?t==="=="?["after","before"]:t[0]===">"?["after"]:["before"]:d(Za(e.expression)),Jl=t=>({rule:xl(t.limit)?Al(t.limit):t.limit,exclusive:t.comparator.length===1}),Hl=(t,n)=>{const e=t.unsetRoot(),i=t.scanner.location;t.parseOperand();const r=t.unsetRoot(),s=t.scanner.sliceChars(i,t.scanner.location);if(t.root=e,!r.hasKind("unit")||typeof r.unit!="number"&&!(r.unit instanceof Date))return t.error(Yt(n,s,"right"));const o=r.unit,c=n.length===1;for(const u of oi(n,typeof o=="number"?o:s,e,"right"))t.constrainRoot(u,{rule:o,exclusive:c});if(!t.branches.leftBound)return;if(!X(n,Cl))return t.error(ms(n));const l=oi(t.branches.leftBound.comparator,t.branches.leftBound.limit,e,"left");t.constrainRoot(l[0],Jl(t.branches.leftBound)),t.branches.leftBound=null},Yt=(t,n,e)=>`Comparator ${e==="left"?mt[t]:t} must be ${e==="left"?"preceded":"followed"} by a corresponding literal (was ${n})`,Wl=t=>{const n=t.scanner.shiftUntilNextTerminator(),e=ha(n,{errorOnFail:ai(n)});e===0&&t.error(ai(0)),t.root=t.root.constrain("divisor",e)},ai=t=>`% operator must be followed by a non-zero integer literal (was ${t})`,$s=t=>{const n=t.scanner.shift();return n===""?t.finalize(""):n==="["?t.scanner.shift()==="]"?t.setRoot(t.root.array()):t.error(Gl):n==="|"||n==="&"?t.pushRootToBranch(n):n===")"?t.finalizeGroup():Te.lookaheadIsFinalizing(n,t.scanner.unscanned)?t.finalize(n):X(n,jl)?zl(t,n):n==="%"?Wl(t):n in ot?$s(t):t.error(An(n))},An=(t,n="")=>`'${t}' is not allowed here${n&&` (should be ${n})`}`,Gl="Missing expected ']'",Yl=t=>{const n=t.unsetRoot();t.parseOperand();const e=t.unsetRoot();return e.hasKind("unit")?n.default(e.unit):t.error(Zl(e.expression))},Zl=t=>`Default value '${t}' must a literal value`,Xl=t=>{t.parseOperand();let n=Sn(t).root;return n?(t.finalizer==="="&&(n=Yl(t)),t.scanner.shiftUntilNonWhitespace(),t.scanner.lookahead&&d(An(t.scanner.lookahead)),n):L(`Root was unexpectedly unset after parsing string '${t.scanner.scanned}'`)},Sn=t=>{for(;t.finalizer===void 0;)Ql(t);return t},Ql=t=>t.hasRoot()?t.parseOperator():t.parseOperand();class St{constructor(n,e){a(this,"root");a(this,"branches",{prefixes:[],leftBound:null,intersection:null,union:null});a(this,"finalizer");a(this,"groups",[]);a(this,"scanner");a(this,"ctx");this.scanner=n,this.ctx=e}error(n){return d(n)}hasRoot(){return this.root!==void 0}setRoot(n){this.root=n}unsetRoot(){const n=this.root;return this.root=void 0,n}constrainRoot(...n){this.root=this.root.constrain(n[0],n[1])}finalize(n){if(this.groups.length)return this.error(fs(")"));this.finalizeBranches(),this.finalizer=n}reduceLeftBound(n,e){const i=mt[e];if(!X(i,Dl))return this.error(ms(e));if(this.branches.leftBound)return this.error(Bl(this.branches.leftBound.limit,this.branches.leftBound.comparator,n,i));this.branches.leftBound={comparator:i,limit:n}}finalizeBranches(){this.assertRangeUnset(),this.branches.union?(this.pushRootToBranch("|"),this.root=this.branches.union):this.branches.intersection?(this.pushRootToBranch("&"),this.root=this.branches.intersection):this.applyPrefixes()}finalizeGroup(){this.finalizeBranches();const n=this.groups.pop();if(!n)return this.error(Ml(this.scanner.unscanned));this.branches=n}addPrefix(n){this.branches.prefixes.push(n)}applyPrefixes(){for(;this.branches.prefixes.length;){const n=this.branches.prefixes.pop();this.root=n==="keyof"?this.root.keyof():L(`Unexpected prefix '${n}'`)}}pushRootToBranch(n){var i,r;this.assertRangeUnset(),this.applyPrefixes();const e=this.root;this.branches.intersection=((i=this.branches.intersection)==null?void 0:i.rawAnd(e))??e,n==="|"&&(this.branches.union=((r=this.branches.union)==null?void 0:r.rawOr(this.branches.intersection))??this.branches.intersection,this.branches.intersection=null),this.root=void 0}parseUntilFinalizer(){return Sn(new St(this.scanner,this.ctx))}parseOperator(){return $s(this)}parseOperand(){return ws(this)}assertRangeUnset(){if(this.branches.leftBound)return this.error(Pl(this.branches.leftBound.limit,this.branches.leftBound.comparator))}reduceGroupOpen(){this.groups.push(this.branches),this.branches={prefixes:[],leftBound:null,union:null,intersection:null}}previousOperator(){var n;return((n=this.branches.leftBound)==null?void 0:n.comparator)??this.branches.prefixes.at(-1)??(this.branches.intersection?"&":this.branches.union?"|":void 0)}shiftedByOne(){return this.scanner.shift(),this}}const eu="An empty string is not a valid generic parameter name",Zt=(t,n,e)=>{t.shiftUntilNonWhitespace();const i=t.shiftUntilNextTerminator();return i===""?t.lookahead===""&&n.length?n:d(eu):(t.shiftUntilNonWhitespace(),tu(t,i,n,e))},ci="extends ",tu=(t,n,e,i)=>{if(t.shiftUntilNonWhitespace(),t.unscanned.startsWith(ci))t.jumpForward(ci.length);else return t.lookahead===","&&t.shift(),e.push(n),Zt(t,e,i);const r=Sn(new St(t,i));return e.push([n,r.root]),Zt(t,e,i)},nu=(t,n)=>{var o;let e;const i={},r=qt(t).flatMap(c=>su(c[0],c[1],n));if(((o=r[0])==null?void 0:o.kind)==="spread"){const c=r.shift();if(!c.node.hasKind("intersection")||!c.node.structure)return d(au(typeof c.node.expression));e=c.node.structure}for(const c of r){if(c.kind==="spread")return d(ru);if(c.kind==="undeclared"){i.undeclared=c.behavior;continue}i[c.kind]=B(i[c.kind],c)}const s=n.$.node("structure",i);return n.$.parseSchema({domain:"object",structure:(e==null?void 0:e.merge(s))??s})},iu=t=>`Value of '+' key must be 'reject', 'delete', or 'ignore' (was ${E(t)})`,ru="Spread operator may only be used as the first key in an object",su=(t,n,e)=>{const i=ou(t);if(i.kind==="+")return n!=="reject"&&n!=="delete"&&n!=="ignore"&&d(iu(n)),{kind:"undeclared",behavior:n};if(i.kind==="...")return{kind:"spread",node:e.$.parseOwnDefinitionFormat(n,e)};const r=e.$.parseOwnDefinitionFormat(n,e);if(i.kind==="index"){const s=e.$.parseOwnDefinitionFormat(i.key,e),o=Wt(s,r,e.$);return o.index?o.required?[o.index,...o.required]:o.index:o.required??[]}if(r.meta){if("default"in r.meta)return e.$.node("optional",{key:i.key,value:r,default:r.meta.default});if(r.meta.optional)return e.$.node("optional",{key:i.key,value:r})}return e.$.node(i.kind,{key:i.key,value:r})},ou=t=>typeof t=="symbol"?{kind:"required",key:t}:t.at(-1)==="?"?t.at(-2)===zt?{kind:"required",key:`${t.slice(0,-2)}?`}:{kind:"optional",key:t.slice(0,-1)}:t[0]==="["&&t.at(-1)==="]"?{kind:"index",key:t.slice(1,-1)}:t[0]===zt&&t[1]==="["&&t.at(-1)==="]"?{kind:"required",key:t.slice(1)}:t==="..."?{kind:t,key:t}:t==="+"?{kind:t,key:t}:{kind:"required",key:t==="\\..."?"...":t==="\\+"?"+":t},au=t=>`Spread operand must resolve to an object literal type (was ${t})`,cu=(t,n)=>hu(t,n)??lu(t,n),lu=(t,n)=>{let e=[{}],i=0;for(;i<t.length;){let r=!1,s=!1;t[i]==="..."&&i<t.length-1&&(r=!0,i++);const o=n.$.parseOwnDefinitionFormat(t[i],n);if(i++,t[i]==="?"){if(r)return d(mu);s=!0,i++}if(r){if(!o.extends(p.intrinsic.Array))return d(du(o.expression));e=e.flatMap(c=>o.distribute(l=>uu(mr(c),l)))}else e=e.map(c=>le(c,s?"optional":"required",o))}return n.$.parseSchema(e.map(r=>Se(r)?{proto:Array,exactLength:0}:{proto:Array,sequence:r}))},le=(t,n,e)=>{switch(n){case"required":return t.optionals?d(pu):(t.variadic?t.postfix=B(t.postfix,e):t.prefix=B(t.prefix,e),t);case"optional":return t.variadic?d(fu):(t.optionals=B(t.optionals,e),t);case"variadic":return t.postfix&&d(li),t.variadic?t.variadic.equals(e)||d(li):t.variadic=e.internal,t}},uu=(t,n)=>{var i,r,s;const e=n.firstReferenceOfKind("sequence");return e?((i=e.prefix)==null||i.forEach(o=>le(t,"required",o)),(r=e.optionals)==null||r.forEach(o=>le(t,"optional",o)),e.variadic&&le(t,"variadic",e.variadic),(s=e.postfix)==null||s.forEach(o=>le(t,"required",o)),t):le(t,"variadic",p.intrinsic.unknown)},hu=(t,n)=>xu(t)?As[t[0]](t,n):bu(t)?xs[t[1]](t,n):void 0,du=t=>`Spread element must be an array (was ${t})`,li="A tuple may have at most one variadic element",pu="A required element may not follow an optional element",fu="An optional element may not follow a variadic element",mu="A spread element cannot be optional",gu=(t,n)=>n.$.parseOwnDefinitionFormat(t[1],n).keyof(),ui=(t,n)=>{if(t[2]===void 0)return d(vs(t[1],""));const e=n.$.parseOwnDefinitionFormat(t[0],n),i=n.$.parseOwnDefinitionFormat(t[2],n);if(t[1]==="|")return n.$.node("union",{branches:[e,i]});const r=se(e,i,n.$);return r instanceof m?r.throw():r},yu=(t,n)=>n.$.parseOwnDefinitionFormat(t[0],n).array(),bu=t=>xs[t[1]]!==void 0,vu=(t,n)=>typeof t[2]!="function"?d(ks("=>",t[2])):n.$.parseOwnDefinitionFormat(t[0],n).pipe(t[2]),ks=(t,n)=>`${t===":"?"Narrow":"Morph"} expression requires a function following '${t}' (was ${typeof n})`,wu=(t,n)=>typeof t[2]!="function"?d(ks(":",t[2])):n.$.parseOwnDefinitionFormat(t[0],n).constrain("predicate",t[2]),$u=(t,n)=>n.$.parseOwnDefinitionFormat(t[0],n).configureShallowDescendants(t[2]),ku=(t,n)=>n.$.parseOwnDefinitionFormat(t[0],n).default(t[2]),xs={"|":ui,"&":ui,"[]":yu,":":wu,"=>":vu,"@":$u,"=":ku},As={keyof:gu,instanceof:(t,n)=>{if(typeof t[1]!="function")return d(hi(Kt(t[1])));const e=t.slice(1).map(i=>typeof i=="function"?n.$.node("proto",{proto:i}):d(hi(Kt(i))));return e.length===1?e[0]:n.$.node("union",{branches:e})},"===":(t,n)=>n.$.units(t.slice(1))},xu=t=>As[t[0]]!==void 0,hi=t=>`Expected a constructor following 'instanceof' operator (was ${t})`,Au=(t,n)=>{const e=hn(t);switch(e){case void 0:return g(t,"root")?t:nu(t,n);case"Array":return cu(t,n);case"RegExp":return n.$.node("intersection",{domain:"string",pattern:t},{prereduced:!0});case"Function":{const i=pn(t)?t():t;return g(i,"root")?i:d(Xt("Function"))}default:return d(Xt(e??E(t)))}},Xt=t=>`Type definitions must be strings or objects (was ${t})`;class Su extends bt{constructor(n){const e=Object.assign({errors:ye,hkt:W,$:n,raw:n.parse,module:n.constructor.module,scope:n.constructor.scope,generic:n.generic,schema:n.schema,ark:n.ambient,unit:n.unit,enumerated:n.enumerated},n.ambientAttachments);super((...i)=>{if(i.length===1)return n.parse(i[0]);if(i.length===2&&typeof i[0]=="string"&&i[0][0]==="<"&&i[0].at(-1)===">"){const r=i[0].slice(1,-1),s=n.parseGenericParams(r,{});return new pt(s,i[1],n,n)}return n.parse(i)},{bind:n,attach:e})}}const Qt=p,de=class de extends es{constructor(){super(...arguments);a(this,"parseCache",{});a(this,"unit",e=>this.units([e]));a(this,"enumerated",(...e)=>this.units(e));a(this,"type",new Su(this));a(this,"declare",()=>({type:this.type}));a(this,"define",(e=>e).bind(this))}cacheGetter(e,i){return Object.defineProperty(this,e,{value:i}),i}get ambientAttachments(){if(Qt.typeAttachments)return this.cacheGetter("ambientAttachments",T(Qt.typeAttachments,(e,i)=>[e,this.bindReference(i)]))}preparseOwnAliasEntry(e,i){const r=e.indexOf("<");if(r===-1)return[e,i];e.at(-1)!==">"&&d("'>' must be the last character of a generic declaration in a scope");const s=e.slice(0,r),o=e.slice(r+1,-1);return[s,()=>{const c=this.parseGenericParams(o,{alias:s});return Ba(c,i,this)}]}parseGenericParams(e,i){return Zt(new Te(e),[],this.createParseContext({...i,def:e,prefix:"generic"}))}normalizeRootScopeValue(e){return pn(e)&&!g(e,"generic")?e():e}preparseOwnDefinitionFormat(e,i){return{...i,def:e,prefix:i.alias??"type"}}parseOwnDefinitionFormat(e,i){var s;return!(i.alias&&i.alias in this.aliases)&&!i.args&&(i.args={this:i.id}),typeof e=="string"?i.args&&Object.keys(i.args).some(o=>e.includes(o))?this.parseString(e,i):(s=this.parseCache)[e]??(s[e]=this.parseString(e,i)):Ee(e,"object")?Au(e,i):d(Xt(Z(e)))}parseString(e,i){var l;const r=this.maybeResolveRoot(e);if(r)return r;const s=e.endsWith("[]")?(l=this.maybeResolveRoot(e.slice(0,-2)))==null?void 0:l.array():void 0;if(s)return s;const o=new St(new Te(e),i),c=Xl(o);return o.finalizer===">"&&d(An(">")),c}};a(de,"scope",(e,i={})=>new de(e,i)),a(de,"module",(e,i={})=>de.scope(e,i).export());let gt=de;const Iu=gt.scope,Tu=gt.module,$=Tu;class Eu extends W{}const Nu=Q(["base",b.object],["props",b.object])(t=>t.base.merge(t.props),Eu),Ss=$({Key:b.key,Merge:Nu});class Ou extends W{}const Ru=Q("element")(t=>{const n=t.element.exclude(b.Array),e=n.array();return n.rawOr(e).pipe(yt).distribute(i=>i.assertHasKind("morph").declareOut(e),S)},Ou),Du=$({root:b.Array,readonly:"root",index:b.nonNegativeIntegerString,liftFrom:Ru}),en=S(["string",Ne.FileConstructor]),Cu=en.rawOr(en.array()),di=S({meta:"an object representing parsed form data",domain:"object",index:{signature:"string",value:Cu}}),Mu=$({root:["instanceof",FormData],value:en,parsed:di,parse:S({in:FormData,morphs:t=>{const n={};for(const[e,i]of t)if(e in n){const r=n[e];typeof r=="string"||r instanceof Ne.FileConstructor?n[e]=[r,i]:r.push(i)}else n[e]=i;return n},declaredOut:di})}),Pu=$({Int8:["instanceof",Int8Array],Uint8:["instanceof",Uint8Array],Uint8Clamped:["instanceof",Uint8ClampedArray],Int16:["instanceof",Int16Array],Uint16:["instanceof",Uint16Array],Int32:["instanceof",Int32Array],Uint32:["instanceof",Uint32Array],Float32:["instanceof",Float32Array],Float64:["instanceof",Float64Array],BigInt64:["instanceof",BigInt64Array],BigUint64:["instanceof",BigUint64Array]}),Bu={Boolean:1,Number:1,String:1},Lu=$({...T({...rr,...or},(t,n)=>t in Bu?[]:[t,["instanceof",n]]),Array:Du,TypedArray:Pu,FormData:Mu}),qu=S({domain:{domain:"number",meta:"a number representing a Unix timestamp"},divisor:{rule:1,meta:"an integer representing a Unix timestamp"},min:{rule:-864e13,meta:"a Unix timestamp after -8640000000000000"},max:{rule:864e13,meta:"a Unix timestamp before 8640000000000000"},meta:"an integer representing a safe Unix timestamp"}),Ku=S({domain:"number",divisor:1}),Is=$({root:b.number,integer:Ku,epoch:qu,safe:S({domain:"number",min:Number.MIN_SAFE_INTEGER,max:Number.MAX_SAFE_INTEGER,predicate:{predicate:t=>!Number.isNaN(t),meta:"a safe number"}}),NaN:["===",Number.NaN],Infinity:["===",Number.POSITIVE_INFINITY],NegativeInfinity:["===",Number.NEGATIVE_INFINITY]}),N=(t,n)=>cs("intersection",{domain:"string",pattern:{rule:t.source,flags:t.flags,meta:n}}),_u=N(/^[A-Za-z]*$/,"only letters"),Uu=N(/^[A-Za-z\d]*$/,"only letters and digits 0-9"),pi=N(/^[A-Z].*$/,"capitalized"),Fu=$({root:S({in:"string",morphs:t=>t.charAt(0).toUpperCase()+t.slice(1),declaredOut:pi}),preformatted:pi}),zu=t=>{const n=t.replace(/[- ]+/g,"");let e=0,i,r,s=!1;for(let o=n.length-1;o>=0;o--)i=n.substring(o,o+1),r=Number.parseInt(i,10),s?(r*=2,r>=10?e+=r%10+1:e+=r):e+=r,s=!s;return!!(e%10===0&&n)},ju=/^(?:4[0-9]{12}(?:[0-9]{3,6})?|5[1-5][0-9]{14}|(222[1-9]|22[3-9][0-9]|2[3-6][0-9]{2}|27[01][0-9]|2720)[0-9]{12}|6(?:011|5[0-9][0-9])[0-9]{12,15}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35\d{3})\d{11}|6[27][0-9]{14}|^(81[0-9]{14,17}))$/,Vu=S({domain:"string",pattern:{meta:"a credit card number",rule:ju.source},predicate:{meta:"a credit card number",predicate:zu}}),fi=N(nt,"a well-formed integer string"),Ts=$({root:fi,parse:S({in:fi,morphs:(t,n)=>{const e=Number.parseInt(t);return Number.isSafeInteger(e)?e:n.error("an integer in the range Number.MIN_SAFE_INTEGER to Number.MAX_SAFE_INTEGER")},declaredOut:b.integer})}),Ju=/^([+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-3])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T]((([01]\d|2[0-3])((:?)[0-5]\d)?|24:?00)([.,]\d+(?!:))?)?(\17[0-5]\d([.,]\d+)?)?([zZ]|([+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/,Hu=t=>!Number.isNaN(new Date(t).valueOf()),mi=S({domain:"string",predicate:{meta:"a parsable date",predicate:Hu}}).assertHasKind("intersection"),gi=Ts.root.internal.narrow((t,n)=>{const e=Number.parseInt(t),i=Is.epoch(e);return i instanceof ye?(n.errors.merge(i),!1):!0}).withMeta({description:"an integer string representing a safe Unix timestamp"}).assertHasKind("intersection"),Wu=$({root:gi,parse:S({in:gi,morphs:t=>new Date(t),declaredOut:b.Date})}),yi=N(Ju,"an ISO 8601 (YYYY-MM-DDTHH:mm:ss.sssZ) date").internal.assertHasKind("intersection"),Gu=$({root:yi,parse:S({in:yi,morphs:t=>new Date(t),declaredOut:b.Date})}),Yu=$({root:mi,parse:S({declaredIn:mi,in:"string",morphs:(t,n)=>{const e=new Date(t);return Number.isNaN(e.valueOf())?n.error("a parsable date"):e},declaredOut:b.Date}),iso:Gu,epoch:Wu}),Zu=N(/^\d*$/,"only digits 0-9"),Xu=N(/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/,"an email address"),bi="(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])",ee=`(${bi}[.]){3}${bi}`,Qu=new RegExp(`^${ee}$`),D="(?:[0-9a-fA-F]{1,4})",eh=new RegExp(`^((?:${D}:){7}(?:${D}|:)|(?:${D}:){6}(?:${ee}|:${D}|:)|(?:${D}:){5}(?::${ee}|(:${D}){1,2}|:)|(?:${D}:){4}(?:(:${D}){0,1}:${ee}|(:${D}){1,3}|:)|(?:${D}:){3}(?:(:${D}){0,2}:${ee}|(:${D}){1,4}|:)|(?:${D}:){2}(?:(:${D}){0,3}:${ee}|(:${D}){1,5}|:)|(?:${D}:){1}(?:(:${D}){0,4}:${ee}|(:${D}){1,6}|:)|(?::((?::${D}){0,5}:${ee}|(?::${D}){1,7}|:)))(%[0-9a-zA-Z.]{1,})?$`),th=$({root:["v4 | v6","@","an IP address"],v4:N(Qu,"an IPv4 address"),v6:N(eh,"an IPv6 address")}),Ge="a JSON string",nh=t=>{try{return JSON.parse(t),!0}catch{return!1}},ih=S({domain:"string",predicate:{meta:Ge,predicate:nh}}),rh=$({root:ih,parse:S({in:"string",morphs:(t,n)=>{if(t.length===0)return n.error({code:"predicate",expected:Ge,actual:"empty"});try{return JSON.parse(t)}catch(e){return n.error({code:"predicate",expected:Ge,problem:`must be ${Ge} (${e})`})}},declaredOut:b.json})}),vi=N(/^[a-z]*$/,"only lowercase letters"),sh=$({root:S({in:"string",morphs:t=>t.toLowerCase(),declaredOut:vi}),preformatted:vi}),Es=["NFC","NFD","NFKC","NFKD"],Me=T(Es,(t,n)=>[n,S({domain:"string",predicate:e=>e.normalize(n)===e,meta:`${n}-normalized unicode`})]),It=T(Es,(t,n)=>[n,S({in:"string",morphs:e=>e.normalize(n),declaredOut:Me[n]})]),oh=$({root:It.NFC,preformatted:Me.NFC}),ah=$({root:It.NFD,preformatted:Me.NFD}),ch=$({root:It.NFKC,preformatted:Me.NFKC}),lh=$({root:It.NFKD,preformatted:Me.NFKD}),uh=$({root:"NFC",NFC:oh,NFD:ah,NFKC:ch,NFKD:lh}),wi=N(_t,"a well-formed numeric string"),hh=$({root:wi,parse:S({in:wi,morphs:t=>Number.parseFloat(t),declaredOut:b.number})}),dh=/^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$/,ph=N(dh,"a semantic version (see https://semver.org/)"),$i=N(/^\S.*\S$|^\S?$/,"trimmed"),fh=$({root:S({in:"string",morphs:t=>t.trim(),declaredOut:$i}),preformatted:$i}),ki=N(/^[A-Z]*$/,"only uppercase letters"),mh=$({root:S({in:"string",morphs:t=>t.toUpperCase(),declaredOut:ki}),preformatted:ki}),gh=t=>{if(URL.canParse)return URL.canParse(t);try{return new URL(t),!0}catch{return!1}},xi=S({domain:"string",predicate:{meta:"a URL string",predicate:gh}}),yh=$({root:xi,parse:S({declaredIn:xi,in:"string",morphs:(t,n)=>{try{return new URL(t)}catch{return n.error("a URL string")}},declaredOut:S(URL)})}),bh=$({root:["versioned | nil | max","@","a UUID"],"#nil":"'00000000-0000-0000-0000-000000000000'","#max":"'ffffffff-ffff-ffff-ffff-ffffffffffff'","#versioned":/[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}/i,v1:N(/^[0-9a-f]{8}-[0-9a-f]{4}-1[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,"a UUIDv1"),v2:N(/^[0-9a-f]{8}-[0-9a-f]{4}-2[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,"a UUIDv2"),v3:N(/^[0-9a-f]{8}-[0-9a-f]{4}-3[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,"a UUIDv3"),v4:N(/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,"a UUIDv4"),v5:N(/^[0-9a-f]{8}-[0-9a-f]{4}-5[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,"a UUIDv5"),v6:N(/^[0-9a-f]{8}-[0-9a-f]{4}-6[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,"a UUIDv6"),v7:N(/^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,"a UUIDv7"),v8:N(/^[0-9a-f]{8}-[0-9a-f]{4}-8[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,"a UUIDv8")}),vh=$({root:b.string,numeric:hh,integer:Ts,alpha:_u,alphanumeric:Uu,digits:Zu,semver:ph,ip:th,creditCard:Vu,email:Xu,uuid:bh,url:yh,json:rh,trim:fh,upper:mh,lower:sh,normalize:uh,capitalize:Fu,date:Yu}),Ns=$({bigint:b.bigint,boolean:b.boolean,false:b.false,never:b.never,null:b.null,number:b.number,object:b.object,string:b.string,symbol:b.symbol,true:b.true,unknown:b.unknown,undefined:b.undefined}),wh=$({root:b.unknown,any:b.unknown});class $h extends W{}const kh=Q(["K",b.key],"V")(t=>({domain:"object",index:{signature:t.K,value:t.V}}),$h);class xh extends W{}const Ah=Q(["T",b.object],["K",b.key])(t=>t.T.pick(t.K),xh);class Sh extends W{}const Ih=Q(["T",b.object],["K",b.key])(t=>t.T.omit(t.K),Sh);class Th extends W{}const Eh=Q(["T",b.object])(t=>t.T.partial(),Th);class Nh extends W{}const Oh=Q(["T",b.object])(t=>t.T.required(),Nh);class Rh extends W{}const Dh=Q("T","U")(t=>t.T.exclude(t.U),Rh);class Ch extends W{}const Mh=Q("T","U")(t=>t.T.extract(t.U),Ch),Os=$({Record:kh,Pick:Ah,Omit:Ih,Exclude:Dh,Extract:Mh,Partial:Eh,Required:Oh});Qt.typeAttachments={...Ns,Key:Ss.Key,Record:Os.Record};const we=Iu({...Ns,...Os,...Lu,...Ss,string:vh,number:Is,unknown:wh},{prereducedAliases:!0,ambient:!0});we.export();const Ct=we.type;we.generic;we.schema;we.define;we.declare;class Ph{constructor(n,e,i,r){a(this,"log",Y.extend("ActivityManager"));a(this,"logSetActivity",this.log.extend("setActivity"));a(this,"currentPresence");a(this,"name");a(this,"version_name");a(this,"schema",Ct({"+":"delete","name?":"2<=string<=128","type?":"0|1|2|3|5","details?":"2<=string<=128","state?":"2<=string<=128","largeImageKey?":"2<=string<=256","largeImageText?":"2<=string<=128","smallImageKey?":"2<=string<=256","smallImageText?":"2<=string<=128","startTimestamp?":"number","endTimestamp?":"number","buttons?":Ct({label:"2<=string<=32",url:"string.url<=512"}).array().atLeastLength(1).atMostLength(2)}));a(this,"isSettingActivity",!1);a(this,"pendingUpdate");this.oAuthManager=n,this.socketManager=e,this.websocketManager=i,this.sessionKeepAlive=r;const{name:s,version_name:o,version:c}=I.runtime.getManifest();this.name=s,this.version_name=o??c}async clearActivity(){var n,e,i;this.currentPresence=void 0,this.isSettingActivity=!1,this.pendingUpdate=void 0,(n=this.socketManager)==null||n.send("clearActivity"),await this.oAuthManager.deleteHeadlessSession(),(e=this.websocketManager)==null||e.close(),(i=this.sessionKeepAlive)==null||i.close(),this.log("Cleared activity %o",this.currentPresence)}truncate(n,e){return n=n.normalize("NFKC").trim(),n.length>e.length?`${n.slice(0,e.length-3)}...`:n}async setActivity(n){var e,i,r,s,o,c,l,u,h;if(this.isSettingActivity){this.pendingUpdate=n;return}this.isSettingActivity=!0;try{if(!await Xs.getValue())return;this.currentPresence&&this.currentPresence.clientId!==n.clientId&&await this.clearActivity();const y=Qs(n.presenceData,eo);let w=!1;if(Be(n.presenceData,y)||(w=!0,n.presenceData=y),typeof n.presenceData.smallImageText=="string"&&(n.presenceData.smallImageText=this.truncate(n.presenceData.smallImageText,{length:128}),n.presenceData.smallImageText?n.presenceData.smallImageText.length<2&&(n.presenceData.smallImageText+=" "):delete n.presenceData.smallImageText),n.presenceData.smallImageKey&&(n.presenceData.smallImageKey=await Nt(n.presenceData.smallImageKey)),n.presenceData.largeImageKey&&(n.presenceData.largeImageKey=await Nt(n.presenceData.largeImageKey)),typeof n.presenceData.details=="string"&&(n.presenceData.details=this.truncate(n.presenceData.details,{length:128}),n.presenceData.details?n.presenceData.details.length<2&&(n.presenceData.details+=" "):delete n.presenceData.details),typeof n.presenceData.state=="string"&&(n.presenceData.state=this.truncate(n.presenceData.state,{length:128}),n.presenceData.state?n.presenceData.state.length<2&&(n.presenceData.state+=" "):delete n.presenceData.state),n.presenceData.buttons)for(const A of n.presenceData.buttons)A&&(A.label=this.truncate(A.label,{length:32}),A.label.length<2&&(A.label+=" "),A.url=await Nt(A.url)??A.url);if(typeof n.presenceData.name=="string"&&(n.presenceData.name=this.truncate(n.presenceData.name,{length:128}),n.presenceData.name?n.presenceData.name.length<2&&(n.presenceData.name+=" "):delete n.presenceData.name),n.presenceData.startTimestamp&&(n.presenceData.startTimestamp=(n.presenceData.startTimestamp instanceof Date?Math.floor(n.presenceData.startTimestamp.getTime()/1e3):Math.floor(n.presenceData.startTimestamp))*1e3),n.presenceData.endTimestamp&&(n.presenceData.endTimestamp=(n.presenceData.endTimestamp instanceof Date?Math.floor(n.presenceData.endTimestamp.getTime()/1e3):Math.floor(n.presenceData.endTimestamp))*1e3),n.presenceData.largeImageKey&&(n.presenceData.type??0)===0&&(n.presenceData.largeImageText=`${this.name} • v${this.version_name}`),Be(this.currentPresence,n))return;w&&this.logSetActivity("Some nullable values were present in the presence data, they were removed.");const x=Dn((e=this.currentPresence)==null?void 0:e.presenceData,["startTimestamp","endTimestamp"]),M=Dn(n.presenceData,["startTimestamp","endTimestamp"]);if(Be(x,M)&&((r=(i=this.currentPresence)==null?void 0:i.presenceData)!=null&&r.startTimestamp)&&n.presenceData.startTimestamp&&Math.abs((this.currentPresence.presenceData.startTimestamp||0)-n.presenceData.startTimestamp)<=1||Be(x,M)&&((o=(s=this.currentPresence)==null?void 0:s.presenceData)!=null&&o.endTimestamp)&&n.presenceData.endTimestamp&&Math.abs((this.currentPresence.presenceData.endTimestamp||0)-n.presenceData.endTimestamp)<=1)return;const R=this.schema(n.presenceData);if(R instanceof Ct.errors)return this.logSetActivity(R.summary);n.presenceData=R,this.currentPresence=n;const k=await ne.getValue();if(k!=null&&k.preferApp&&((c=this.socketManager)!=null&&c.connected)?(l=this.socketManager)==null||l.send("setActivity",{clientId:n.clientId,presenceData:{buttons:n.presenceData.buttons,details:n.presenceData.details,endTimestamp:n.presenceData.endTimestamp,largeImageKey:n.presenceData.largeImageKey,largeImageText:n.presenceData.largeImageText,smallImageKey:n.presenceData.smallImageKey,smallImageText:n.presenceData.smallImageText,startTimestamp:n.presenceData.startTimestamp,state:n.presenceData.state}}):(await((u=this.websocketManager)==null?void 0:u.init()),await((h=this.sessionKeepAlive)==null?void 0:h.init()),await this.oAuthManager.createHeadlessSession()),this.log("setActivity %o",n),this.pendingUpdate){const{pendingUpdate:A}=this;this.pendingUpdate=void 0,await this.setActivity(A)}}catch(f){if(this.log("Error setting activity: %o",f),this.pendingUpdate){const{pendingUpdate:y}=this;this.pendingUpdate=void 0,await this.setActivity(y)}}finally{this.isSettingActivity=!1}}}class Bh{constructor(n){a(this,"initialized");a(this,"log",Y.extend("AnalyticsManager"));a(this,"logHeartbeat",this.log.extend("Heartbeat"));a(this,"logScience",this.log.extend("Science"));a(this,"heartbeatInterval");a(this,"analyticsId","");this.pmd=n,this.initialized=this.init(),ne.watch((e,i)=>{(i==null?void 0:i.heartbeat)!==(e==null?void 0:e.heartbeat)&&e&&(e.heartbeat?this.startHeartbeat():this.stopHeartbeat())})}async init(){this.analyticsId=await Wi(),this.log("Loaded analytics ID %s",this.analyticsId),I.runtime.setUninstallURL(`https://${ln}/v2/science/${this.analyticsId}`),setInterval(this.updateScience.bind(this),30*60*1e3),this.updateScience(),this.startHeartbeat()}async startHeartbeat(){if(this.heartbeatInterval)return;const n=await ne.getValue();n!=null&&n.heartbeat&&(this.heartbeatInterval=setInterval(()=>{this.sendHeartbeat()},5*60*1e3),this.logHeartbeat("Started heartbeat interval"),this.sendHeartbeat())}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=void 0,this.logHeartbeat("Stopped heartbeat interval"))}async getHeartbeatData(){var i,r;if(!this.analyticsId)throw new Error("Analytics ID not set");let n;(i=this.pmd.tabPriority)!=null&&i.currentTabPresence&&((r=this.pmd.tabPriority)!=null&&r.currentTabPresenceTimestamp)&&(n={language:await this.pmd.languageManager.getPresenceLanguage(this.pmd.tabPriority.currentTabPresence.service),service:this.pmd.tabPriority.currentTabPresence.service,since:this.pmd.tabPriority.currentTabPresenceTimestamp,version:this.pmd.tabPriority.currentTabPresence.version});const e=await Zi.getValue();return{extension:{connected:await Bt.getValue()&&e?{app:e,discord:!!await to.getValue()}:void 0,language:this.pmd.languageManager.language,version:I.runtime.getManifest().version},identifier:this.analyticsId,presence:n}}async sendHeartbeat(){const n=await ne.getValue();if(n!=null&&n.heartbeat)try{const e=await this.getHeartbeatData();await Cn.heartbeat(e),this.logHeartbeat("Sent heartbeat... %O",e)}catch{this.logHeartbeat("Failed to send heartbeat")}}async getScienceData(){const n=await this.pmd.presenceManager.get(),e=await I.runtime.getPlatformInfo();return{identifier:this.analyticsId,presences:n.map(i=>i.service),...e}}async updateScience(){try{const n=await this.getScienceData();this.logScience("Updating science... %O",n),await Cn.addScience(n)}catch{this.logScience("Failed to update science")}}}async function Lh(){return(()=>{// ! PREMID_DEPENDENCIES -- @preserve
window.addEventListener("pmdGetPageVariable",t=>{let n=!1;const e=JSON.parse(t.detail);if(!e.nonce||!(e.variable||e.variables))return;const i={nonce:e.nonce};e.variables?(i.variables=e.variables.reduce((r,s)=>(r[s]=hasProperty(window,s)?getProperty(window,s):void 0,typeof r[s]=="object"&&(n=!0),r),{}),n&&(i.variables=JSON.parse(safeStringify(i.variables)))):i.variable=JSON.parse(JSON.stringify(window[e.variable])),window.dispatchEvent(new CustomEvent("pmdPageVariable",{detail:i}))})})()}async function qh(t){let n=!1;try{const[{result:e}]=await I.scripting.executeScript({func:()=>!!window.Presence,injectImmediately:!0,target:{tabId:t}});e&&(n=!0)}catch{throw n=!1,new ro("Tab doesn't exist")}if(!n)throw new Error("Tab doesn't have Presence class")}class Kh{constructor(){a(this,"log",Y.extend("InjectionManager"));a(this,"injectLimitter",no(1))}async injectPresence(n,e,i){return await this.injectLimitter(async()=>{if(e.id&&!await this.tabHasPresence(n,e))try{await I.scripting.executeScript({args:[i.service],func:o=>{window.PreMiD_PresenceName=o},injectImmediately:!0,target:{tabId:e.id},world:"ISOLATED"}),i.readLogs&&(await I.scripting.executeScript({args:[100],func:c=>{console.stdlog=console.log.bind(console),console.logs=[];const l=["log","info","warn","error"];for(const u of l)console[u]=function(...h){for(const f of h)console.logs.push({content:f,id:crypto.randomUUID(),timestamp:Date.now(),type:u});for(;console.logs.length>c*l.length;)console.logs.shift();console.stdlog.apply(console,h)}},injectImmediately:!0,target:{tabId:e.id},world:"MAIN"}),this.log("Injected console log reader into %s",e.url));const r=await fetch(I.runtime.getURL("/variableGetterDependencies.js")),s=Lh.toString().replace("// ! PREMID_DEPENDENCIES -- @preserve",await r.text());await I.scripting.executeScript({args:[s],func:async o=>{if(document.querySelector("#PreMiD_VariableGetter"))return;const c=document.createElement("script");c.id="PreMiD_VariableGetter",c.type="text/javascript",c.text=`window.pmdVariableGetter = ${o};pmdVariableGetter();`,document.head.append(c)},target:{tabId:e.id},world:"MAIN"}),await I.scripting.executeScript({files:[`/presences/${i.service}/presence.js`],injectImmediately:!0,target:{tabId:e.id},world:"ISOLATED"}),this.log("Injected %s into %s",i.service,e.url)}catch(r){this.log("Cannot inject %s into %s",i.service,e.url,r)}})}injectiFrame(n,e,i,r){n.id&&(I.scripting.executeScript({files:[`/presences/${i.service}/iframe.js`],injectImmediately:!0,target:{frameIds:[e],tabId:n.id}}),this.log("Injected iframe.js for Presence %s into iFrame %s for tab %s",i.service,r,n.url))}async getPresenceForiFrame(n,e,i){if(!n.id)return;const[{result:r}]=await I.scripting.executeScript({func:()=>window.location.href,injectImmediately:!0,target:{frameIds:[e],tabId:n.id}});if(!r)return;const s=await this.getPresenceForTab(n,i);if(!s)return;const{iframe:o,iFrameRegExp:c}=s;if(!(!o||!c||!new RegExp(c).test(r)))return{iframeUrl:r,presence:s}}async getPresenceForTab(n,e){const i=n.url;if(!i)return;const{hostname:r}=new URL(i);return(await e.get()).filter(c=>c.enabled).find(c=>{const{url:l,regExp:u}=c;return!!(u&&new RegExp(u).test(i)||Array.isArray(l)&&l.includes(r)||!Array.isArray(l)&&r===l)})||void 0}async tabHasPresence(n,e){try{await io(()=>qh(e.id),{forever:!0,maxTimeout:50,minTimeout:50})}catch{return this.log("Tab %d cannot have Presence class",e==null?void 0:e.id),!1}if(e??(e=await n.activeTab()),!(e!=null&&e.id))return!1;try{const[{result:i}]=await I.scripting.executeScript({func:()=>window.PreMiD_PresenceName,injectImmediately:!0,target:{tabId:e.id}});return I.runtime.lastError||!i?!1:i[0]?i[0]:!1}catch{return!1}}}const H=Object.create(null);H.open="0";H.close="1";H.ping="2";H.pong="3";H.message="4";H.upgrade="5";H.noop="6";const Ye=Object.create(null);Object.keys(H).forEach(t=>{Ye[H[t]]=t});const tn={type:"error",data:"parser error"},Rs=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",Ds=typeof ArrayBuffer=="function",Cs=t=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(t):t&&t.buffer instanceof ArrayBuffer,In=({type:t,data:n},e,i)=>Rs&&n instanceof Blob?e?i(n):Ai(n,i):Ds&&(n instanceof ArrayBuffer||Cs(n))?e?i(n):Ai(new Blob([n]),i):i(H[t]+(n||"")),Ai=(t,n)=>{const e=new FileReader;return e.onload=function(){const i=e.result.split(",")[1];n("b"+(i||""))},e.readAsDataURL(t)};function Si(t){return t instanceof Uint8Array?t:t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}let Mt;function _h(t,n){if(Rs&&t.data instanceof Blob)return t.data.arrayBuffer().then(Si).then(n);if(Ds&&(t.data instanceof ArrayBuffer||Cs(t.data)))return n(Si(t.data));In(t,!1,e=>{Mt||(Mt=new TextEncoder),n(Mt.encode(e))})}const Ii="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Ae=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let t=0;t<Ii.length;t++)Ae[Ii.charCodeAt(t)]=t;const Uh=t=>{let n=t.length*.75,e=t.length,i,r=0,s,o,c,l;t[t.length-1]==="="&&(n--,t[t.length-2]==="="&&n--);const u=new ArrayBuffer(n),h=new Uint8Array(u);for(i=0;i<e;i+=4)s=Ae[t.charCodeAt(i)],o=Ae[t.charCodeAt(i+1)],c=Ae[t.charCodeAt(i+2)],l=Ae[t.charCodeAt(i+3)],h[r++]=s<<2|o>>4,h[r++]=(o&15)<<4|c>>2,h[r++]=(c&3)<<6|l&63;return u},Fh=typeof ArrayBuffer=="function",Tn=(t,n)=>{if(typeof t!="string")return{type:"message",data:Ms(t,n)};const e=t.charAt(0);return e==="b"?{type:"message",data:zh(t.substring(1),n)}:Ye[e]?t.length>1?{type:Ye[e],data:t.substring(1)}:{type:Ye[e]}:tn},zh=(t,n)=>{if(Fh){const e=Uh(t);return Ms(e,n)}else return{base64:!0,data:t}},Ms=(t,n)=>{switch(n){case"blob":return t instanceof Blob?t:new Blob([t]);case"arraybuffer":default:return t instanceof ArrayBuffer?t:t.buffer}},Ps="",jh=(t,n)=>{const e=t.length,i=new Array(e);let r=0;t.forEach((s,o)=>{In(s,!1,c=>{i[o]=c,++r===e&&n(i.join(Ps))})})},Vh=(t,n)=>{const e=t.split(Ps),i=[];for(let r=0;r<e.length;r++){const s=Tn(e[r],n);if(i.push(s),s.type==="error")break}return i};function Jh(){return new TransformStream({transform(t,n){_h(t,e=>{const i=e.length;let r;if(i<126)r=new Uint8Array(1),new DataView(r.buffer).setUint8(0,i);else if(i<65536){r=new Uint8Array(3);const s=new DataView(r.buffer);s.setUint8(0,126),s.setUint16(1,i)}else{r=new Uint8Array(9);const s=new DataView(r.buffer);s.setUint8(0,127),s.setBigUint64(1,BigInt(i))}t.data&&typeof t.data!="string"&&(r[0]|=128),n.enqueue(r),n.enqueue(e)})}})}let Pt;function Ue(t){return t.reduce((n,e)=>n+e.length,0)}function Fe(t,n){if(t[0].length===n)return t.shift();const e=new Uint8Array(n);let i=0;for(let r=0;r<n;r++)e[r]=t[0][i++],i===t[0].length&&(t.shift(),i=0);return t.length&&i<t[0].length&&(t[0]=t[0].slice(i)),e}function Hh(t,n){Pt||(Pt=new TextDecoder);const e=[];let i=0,r=-1,s=!1;return new TransformStream({transform(o,c){for(e.push(o);;){if(i===0){if(Ue(e)<1)break;const l=Fe(e,1);s=(l[0]&128)===128,r=l[0]&127,r<126?i=3:r===126?i=1:i=2}else if(i===1){if(Ue(e)<2)break;const l=Fe(e,2);r=new DataView(l.buffer,l.byteOffset,l.length).getUint16(0),i=3}else if(i===2){if(Ue(e)<8)break;const l=Fe(e,8),u=new DataView(l.buffer,l.byteOffset,l.length),h=u.getUint32(0);if(h>Math.pow(2,21)-1){c.enqueue(tn);break}r=h*Math.pow(2,32)+u.getUint32(4),i=3}else{if(Ue(e)<r)break;const l=Fe(e,r);c.enqueue(Tn(s?l:Pt.decode(l),n)),i=0}if(r===0||r>t){c.enqueue(tn);break}}}})}const Bs=4;function C(t){if(t)return Wh(t)}function Wh(t){for(var n in C.prototype)t[n]=C.prototype[n];return t}C.prototype.on=C.prototype.addEventListener=function(t,n){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(n),this};C.prototype.once=function(t,n){function e(){this.off(t,e),n.apply(this,arguments)}return e.fn=n,this.on(t,e),this};C.prototype.off=C.prototype.removeListener=C.prototype.removeAllListeners=C.prototype.removeEventListener=function(t,n){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var e=this._callbacks["$"+t];if(!e)return this;if(arguments.length==1)return delete this._callbacks["$"+t],this;for(var i,r=0;r<e.length;r++)if(i=e[r],i===n||i.fn===n){e.splice(r,1);break}return e.length===0&&delete this._callbacks["$"+t],this};C.prototype.emit=function(t){this._callbacks=this._callbacks||{};for(var n=new Array(arguments.length-1),e=this._callbacks["$"+t],i=1;i<arguments.length;i++)n[i-1]=arguments[i];if(e){e=e.slice(0);for(var i=0,r=e.length;i<r;++i)e[i].apply(this,n)}return this};C.prototype.emitReserved=C.prototype.emit;C.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]};C.prototype.hasListeners=function(t){return!!this.listeners(t).length};const U=typeof self<"u"?self:typeof window<"u"?window:Function("return this")();function Ls(t,...n){return n.reduce((e,i)=>(t.hasOwnProperty(i)&&(e[i]=t[i]),e),{})}const Gh=U.setTimeout,Yh=U.clearTimeout;function Tt(t,n){n.useNativeTimers?(t.setTimeoutFn=Gh.bind(U),t.clearTimeoutFn=Yh.bind(U)):(t.setTimeoutFn=U.setTimeout.bind(U),t.clearTimeoutFn=U.clearTimeout.bind(U))}const Zh=1.33;function Xh(t){return typeof t=="string"?Qh(t):Math.ceil((t.byteLength||t.size)*Zh)}function Qh(t){let n=0,e=0;for(let i=0,r=t.length;i<r;i++)n=t.charCodeAt(i),n<128?e+=1:n<2048?e+=2:n<55296||n>=57344?e+=3:(i++,e+=4);return e}function ed(t){let n="";for(let e in t)t.hasOwnProperty(e)&&(n.length&&(n+="&"),n+=encodeURIComponent(e)+"="+encodeURIComponent(t[e]));return n}function td(t){let n={},e=t.split("&");for(let i=0,r=e.length;i<r;i++){let s=e[i].split("=");n[decodeURIComponent(s[0])]=decodeURIComponent(s[1])}return n}class nd extends Error{constructor(n,e,i){super(n),this.description=e,this.context=i,this.type="TransportError"}}class En extends C{constructor(n){super(),this.writable=!1,Tt(this,n),this.opts=n,this.query=n.query,this.socket=n.socket}onError(n,e,i){return super.emitReserved("error",new nd(n,e,i)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(n){this.readyState==="open"&&this.write(n)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(n){const e=Tn(n,this.socket.binaryType);this.onPacket(e)}onPacket(n){super.emitReserved("packet",n)}onClose(n){this.readyState="closed",super.emitReserved("close",n)}pause(n){}createUri(n,e={}){return n+"://"+this._hostname()+this._port()+this.opts.path+this._query(e)}_hostname(){const n=this.opts.hostname;return n.indexOf(":")===-1?n:"["+n+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(n){const e=ed(n);return e.length?"?"+e:""}}const qs="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),nn=64,id={};let Ti=0,ze=0,Ei;function Ni(t){let n="";do n=qs[t%nn]+n,t=Math.floor(t/nn);while(t>0);return n}function Ks(){const t=Ni(+new Date);return t!==Ei?(Ti=0,Ei=t):t+"."+Ni(Ti++)}for(;ze<nn;ze++)id[qs[ze]]=ze;let _s=!1;try{_s=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const rd=_s;function Us(t){const n=t.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!n||rd))return new XMLHttpRequest}catch{}if(!n)try{return new U[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}function sd(){}const od=function(){return new Us({xdomain:!1}).responseType!=null}();class ad extends En{constructor(n){if(super(n),this.polling=!1,typeof location<"u"){const i=location.protocol==="https:";let r=location.port;r||(r=i?"443":"80"),this.xd=typeof location<"u"&&n.hostname!==location.hostname||r!==n.port}const e=n&&n.forceBase64;this.supportsBinary=od&&!e,this.opts.withCredentials&&(this.cookieJar=void 0)}get name(){return"polling"}doOpen(){this.poll()}pause(n){this.readyState="pausing";const e=()=>{this.readyState="paused",n()};if(this.polling||!this.writable){let i=0;this.polling&&(i++,this.once("pollComplete",function(){--i||e()})),this.writable||(i++,this.once("drain",function(){--i||e()}))}else e()}poll(){this.polling=!0,this.doPoll(),this.emitReserved("poll")}onData(n){const e=i=>{if(this.readyState==="opening"&&i.type==="open"&&this.onOpen(),i.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(i)};Vh(n,this.socket.binaryType).forEach(e),this.readyState!=="closed"&&(this.polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this.poll())}doClose(){const n=()=>{this.write([{type:"close"}])};this.readyState==="open"?n():this.once("open",n)}write(n){this.writable=!1,jh(n,e=>{this.doWrite(e,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const n=this.opts.secure?"https":"http",e=this.query||{};return this.opts.timestampRequests!==!1&&(e[this.opts.timestampParam]=Ks()),!this.supportsBinary&&!e.sid&&(e.b64=1),this.createUri(n,e)}request(n={}){return Object.assign(n,{xd:this.xd,cookieJar:this.cookieJar},this.opts),new fe(this.uri(),n)}doWrite(n,e){const i=this.request({method:"POST",data:n});i.on("success",e),i.on("error",(r,s)=>{this.onError("xhr post error",r,s)})}doPoll(){const n=this.request();n.on("data",this.onData.bind(this)),n.on("error",(e,i)=>{this.onError("xhr poll error",e,i)}),this.pollXhr=n}}let fe=class Ze extends C{constructor(n,e){super(),Tt(this,e),this.opts=e,this.method=e.method||"GET",this.uri=n,this.data=e.data!==void 0?e.data:null,this.create()}create(){var n;const e=Ls(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this.opts.xd;const i=this.xhr=new Us(e);try{i.open(this.method,this.uri,!0);try{if(this.opts.extraHeaders){i.setDisableHeaderCheck&&i.setDisableHeaderCheck(!0);for(let r in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(r)&&i.setRequestHeader(r,this.opts.extraHeaders[r])}}catch{}if(this.method==="POST")try{i.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{i.setRequestHeader("Accept","*/*")}catch{}(n=this.opts.cookieJar)===null||n===void 0||n.addCookies(i),"withCredentials"in i&&(i.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(i.timeout=this.opts.requestTimeout),i.onreadystatechange=()=>{var r;i.readyState===3&&((r=this.opts.cookieJar)===null||r===void 0||r.parseCookies(i)),i.readyState===4&&(i.status===200||i.status===1223?this.onLoad():this.setTimeoutFn(()=>{this.onError(typeof i.status=="number"?i.status:0)},0))},i.send(this.data)}catch(r){this.setTimeoutFn(()=>{this.onError(r)},0);return}typeof document<"u"&&(this.index=Ze.requestsCount++,Ze.requests[this.index]=this)}onError(n){this.emitReserved("error",n,this.xhr),this.cleanup(!0)}cleanup(n){if(!(typeof this.xhr>"u"||this.xhr===null)){if(this.xhr.onreadystatechange=sd,n)try{this.xhr.abort()}catch{}typeof document<"u"&&delete Ze.requests[this.index],this.xhr=null}}onLoad(){const n=this.xhr.responseText;n!==null&&(this.emitReserved("data",n),this.emitReserved("success"),this.cleanup())}abort(){this.cleanup()}};fe.requestsCount=0;fe.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",Oi);else if(typeof addEventListener=="function"){const t="onpagehide"in U?"pagehide":"unload";addEventListener(t,Oi,!1)}}function Oi(){for(let t in fe.requests)fe.requests.hasOwnProperty(t)&&fe.requests[t].abort()}const Nn=typeof Promise=="function"&&typeof Promise.resolve=="function"?n=>Promise.resolve().then(n):(n,e)=>e(n,0),je=U.WebSocket||U.MozWebSocket,Ri=!0,cd="arraybuffer",Di=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class ld extends En{constructor(n){super(n),this.supportsBinary=!n.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;const n=this.uri(),e=this.opts.protocols,i=Di?{}:Ls(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(i.headers=this.opts.extraHeaders);try{this.ws=Ri&&!Di?e?new je(n,e):new je(n):new je(n,e,i)}catch(r){return this.emitReserved("error",r)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=n=>this.onClose({description:"websocket connection closed",context:n}),this.ws.onmessage=n=>this.onData(n.data),this.ws.onerror=n=>this.onError("websocket error",n)}write(n){this.writable=!1;for(let e=0;e<n.length;e++){const i=n[e],r=e===n.length-1;In(i,this.supportsBinary,s=>{const o={};try{Ri&&this.ws.send(s)}catch{}r&&Nn(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.close(),this.ws=null)}uri(){const n=this.opts.secure?"wss":"ws",e=this.query||{};return this.opts.timestampRequests&&(e[this.opts.timestampParam]=Ks()),this.supportsBinary||(e.b64=1),this.createUri(n,e)}check(){return!!je}}class ud extends En{get name(){return"webtransport"}doOpen(){typeof WebTransport=="function"&&(this.transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name]),this.transport.closed.then(()=>{this.onClose()}).catch(n=>{this.onError("webtransport error",n)}),this.transport.ready.then(()=>{this.transport.createBidirectionalStream().then(n=>{const e=Hh(Number.MAX_SAFE_INTEGER,this.socket.binaryType),i=n.readable.pipeThrough(e).getReader(),r=Jh();r.readable.pipeTo(n.writable),this.writer=r.writable.getWriter();const s=()=>{i.read().then(({done:c,value:l})=>{c||(this.onPacket(l),s())}).catch(c=>{})};s();const o={type:"open"};this.query.sid&&(o.data=`{"sid":"${this.query.sid}"}`),this.writer.write(o).then(()=>this.onOpen())})}))}write(n){this.writable=!1;for(let e=0;e<n.length;e++){const i=n[e],r=e===n.length-1;this.writer.write(i).then(()=>{r&&Nn(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var n;(n=this.transport)===null||n===void 0||n.close()}}const hd={websocket:ld,webtransport:ud,polling:ad},dd=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,pd=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function rn(t){if(t.length>2e3)throw"URI too long";const n=t,e=t.indexOf("["),i=t.indexOf("]");e!=-1&&i!=-1&&(t=t.substring(0,e)+t.substring(e,i).replace(/:/g,";")+t.substring(i,t.length));let r=dd.exec(t||""),s={},o=14;for(;o--;)s[pd[o]]=r[o]||"";return e!=-1&&i!=-1&&(s.source=n,s.host=s.host.substring(1,s.host.length-1).replace(/;/g,":"),s.authority=s.authority.replace("[","").replace("]","").replace(/;/g,":"),s.ipv6uri=!0),s.pathNames=fd(s,s.path),s.queryKey=md(s,s.query),s}function fd(t,n){const e=/\/{2,9}/g,i=n.replace(e,"/").split("/");return(n.slice(0,1)=="/"||n.length===0)&&i.splice(0,1),n.slice(-1)=="/"&&i.splice(i.length-1,1),i}function md(t,n){const e={};return n.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(i,r,s){r&&(e[r]=s)}),e}let Fs=class ue extends C{constructor(n,e={}){super(),this.binaryType=cd,this.writeBuffer=[],n&&typeof n=="object"&&(e=n,n=null),n?(n=rn(n),e.hostname=n.host,e.secure=n.protocol==="https"||n.protocol==="wss",e.port=n.port,n.query&&(e.query=n.query)):e.host&&(e.hostname=rn(e.host).host),Tt(this,e),this.secure=e.secure!=null?e.secure:typeof location<"u"&&location.protocol==="https:",e.hostname&&!e.port&&(e.port=this.secure?"443":"80"),this.hostname=e.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=e.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=e.transports||["polling","websocket","webtransport"],this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},e),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=td(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,typeof addEventListener=="function"&&(this.opts.closeOnBeforeunload&&(this.beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this.beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this.offlineEventListener=()=>{this.onClose("transport close",{description:"network connection lost"})},addEventListener("offline",this.offlineEventListener,!1))),this.open()}createTransport(n){const e=Object.assign({},this.opts.query);e.EIO=Bs,e.transport=n,this.id&&(e.sid=this.id);const i=Object.assign({},this.opts,{query:e,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[n]);return new hd[n](i)}open(){let n;if(this.opts.rememberUpgrade&&ue.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1)n="websocket";else if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}else n=this.transports[0];this.readyState="opening";try{n=this.createTransport(n)}catch{this.transports.shift(),this.open();return}n.open(),this.setTransport(n)}setTransport(n){this.transport&&this.transport.removeAllListeners(),this.transport=n,n.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",e=>this.onClose("transport close",e))}probe(n){let e=this.createTransport(n),i=!1;ue.priorWebsocketSuccess=!1;const r=()=>{i||(e.send([{type:"ping",data:"probe"}]),e.once("packet",f=>{if(!i)if(f.type==="pong"&&f.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",e),!e)return;ue.priorWebsocketSuccess=e.name==="websocket",this.transport.pause(()=>{i||this.readyState!=="closed"&&(h(),this.setTransport(e),e.send([{type:"upgrade"}]),this.emitReserved("upgrade",e),e=null,this.upgrading=!1,this.flush())})}else{const y=new Error("probe error");y.transport=e.name,this.emitReserved("upgradeError",y)}}))};function s(){i||(i=!0,h(),e.close(),e=null)}const o=f=>{const y=new Error("probe error: "+f);y.transport=e.name,s(),this.emitReserved("upgradeError",y)};function c(){o("transport closed")}function l(){o("socket closed")}function u(f){e&&f.name!==e.name&&s()}const h=()=>{e.removeListener("open",r),e.removeListener("error",o),e.removeListener("close",c),this.off("close",l),this.off("upgrading",u)};e.once("open",r),e.once("error",o),e.once("close",c),this.once("close",l),this.once("upgrading",u),this.upgrades.indexOf("webtransport")!==-1&&n!=="webtransport"?this.setTimeoutFn(()=>{i||e.open()},200):e.open()}onOpen(){if(this.readyState="open",ue.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush(),this.readyState==="open"&&this.opts.upgrade){let n=0;const e=this.upgrades.length;for(;n<e;n++)this.probe(this.upgrades[n])}}onPacket(n){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",n),this.emitReserved("heartbeat"),this.resetPingTimeout(),n.type){case"open":this.onHandshake(JSON.parse(n.data));break;case"ping":this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":const e=new Error("server error");e.code=n.data,this.onError(e);break;case"message":this.emitReserved("data",n.data),this.emitReserved("message",n.data);break}}onHandshake(n){this.emitReserved("handshake",n),this.id=n.sid,this.transport.query.sid=n.sid,this.upgrades=this.filterUpgrades(n.upgrades),this.pingInterval=n.pingInterval,this.pingTimeout=n.pingTimeout,this.maxPayload=n.maxPayload,this.onOpen(),this.readyState!=="closed"&&this.resetPingTimeout()}resetPingTimeout(){this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn(()=>{this.onClose("ping timeout")},this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const n=this.getWritablePackets();this.transport.send(n),this.prevBufferLen=n.length,this.emitReserved("flush")}}getWritablePackets(){if(!(this.maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let e=1;for(let i=0;i<this.writeBuffer.length;i++){const r=this.writeBuffer[i].data;if(r&&(e+=Xh(r)),i>0&&e>this.maxPayload)return this.writeBuffer.slice(0,i);e+=2}return this.writeBuffer}write(n,e,i){return this.sendPacket("message",n,e,i),this}send(n,e,i){return this.sendPacket("message",n,e,i),this}sendPacket(n,e,i,r){if(typeof e=="function"&&(r=e,e=void 0),typeof i=="function"&&(r=i,i=null),this.readyState==="closing"||this.readyState==="closed")return;i=i||{},i.compress=i.compress!==!1;const s={type:n,data:e,options:i};this.emitReserved("packetCreate",s),this.writeBuffer.push(s),r&&this.once("flush",r),this.flush()}close(){const n=()=>{this.onClose("forced close"),this.transport.close()},e=()=>{this.off("upgrade",e),this.off("upgradeError",e),n()},i=()=>{this.once("upgrade",e),this.once("upgradeError",e)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?i():n()}):this.upgrading?i():n()),this}onError(n){ue.priorWebsocketSuccess=!1,this.emitReserved("error",n),this.onClose("transport error",n)}onClose(n,e){(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")&&(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),typeof removeEventListener=="function"&&(removeEventListener("beforeunload",this.beforeunloadEventListener,!1),removeEventListener("offline",this.offlineEventListener,!1)),this.readyState="closed",this.id=null,this.emitReserved("close",n,e),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(n){const e=[];let i=0;const r=n.length;for(;i<r;i++)~this.transports.indexOf(n[i])&&e.push(n[i]);return e}};Fs.protocol=Bs;function gd(t,n="",e){let i=t;e=e||typeof location<"u"&&location,t==null&&(t=e.protocol+"//"+e.host),typeof t=="string"&&(t.charAt(0)==="/"&&(t.charAt(1)==="/"?t=e.protocol+t:t=e.host+t),/^(https?|wss?):\/\//.test(t)||(typeof e<"u"?t=e.protocol+"//"+t:t="https://"+t),i=rn(t)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";const s=i.host.indexOf(":")!==-1?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+s+":"+i.port+n,i.href=i.protocol+"://"+s+(e&&e.port===i.port?"":":"+i.port),i}const yd=typeof ArrayBuffer=="function",bd=t=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer,zs=Object.prototype.toString,vd=typeof Blob=="function"||typeof Blob<"u"&&zs.call(Blob)==="[object BlobConstructor]",wd=typeof File=="function"||typeof File<"u"&&zs.call(File)==="[object FileConstructor]";function On(t){return yd&&(t instanceof ArrayBuffer||bd(t))||vd&&t instanceof Blob||wd&&t instanceof File}function Xe(t,n){if(!t||typeof t!="object")return!1;if(Array.isArray(t)){for(let e=0,i=t.length;e<i;e++)if(Xe(t[e]))return!0;return!1}if(On(t))return!0;if(t.toJSON&&typeof t.toJSON=="function"&&arguments.length===1)return Xe(t.toJSON(),!0);for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)&&Xe(t[e]))return!0;return!1}function $d(t){const n=[],e=t.data,i=t;return i.data=sn(e,n),i.attachments=n.length,{packet:i,buffers:n}}function sn(t,n){if(!t)return t;if(On(t)){const e={_placeholder:!0,num:n.length};return n.push(t),e}else if(Array.isArray(t)){const e=new Array(t.length);for(let i=0;i<t.length;i++)e[i]=sn(t[i],n);return e}else if(typeof t=="object"&&!(t instanceof Date)){const e={};for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=sn(t[i],n));return e}return t}function kd(t,n){return t.data=on(t.data,n),delete t.attachments,t}function on(t,n){if(!t)return t;if(t&&t._placeholder===!0){if(typeof t.num=="number"&&t.num>=0&&t.num<n.length)return n[t.num];throw new Error("illegal attachments")}else if(Array.isArray(t))for(let e=0;e<t.length;e++)t[e]=on(t[e],n);else if(typeof t=="object")for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&(t[e]=on(t[e],n));return t}const xd=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],Ad=5;var v;(function(t){t[t.CONNECT=0]="CONNECT",t[t.DISCONNECT=1]="DISCONNECT",t[t.EVENT=2]="EVENT",t[t.ACK=3]="ACK",t[t.CONNECT_ERROR=4]="CONNECT_ERROR",t[t.BINARY_EVENT=5]="BINARY_EVENT",t[t.BINARY_ACK=6]="BINARY_ACK"})(v||(v={}));class Sd{constructor(n){this.replacer=n}encode(n){return(n.type===v.EVENT||n.type===v.ACK)&&Xe(n)?this.encodeAsBinary({type:n.type===v.EVENT?v.BINARY_EVENT:v.BINARY_ACK,nsp:n.nsp,data:n.data,id:n.id}):[this.encodeAsString(n)]}encodeAsString(n){let e=""+n.type;return(n.type===v.BINARY_EVENT||n.type===v.BINARY_ACK)&&(e+=n.attachments+"-"),n.nsp&&n.nsp!=="/"&&(e+=n.nsp+","),n.id!=null&&(e+=n.id),n.data!=null&&(e+=JSON.stringify(n.data,this.replacer)),e}encodeAsBinary(n){const e=$d(n),i=this.encodeAsString(e.packet),r=e.buffers;return r.unshift(i),r}}function Ci(t){return Object.prototype.toString.call(t)==="[object Object]"}class Rn extends C{constructor(n){super(),this.reviver=n}add(n){let e;if(typeof n=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");e=this.decodeString(n);const i=e.type===v.BINARY_EVENT;i||e.type===v.BINARY_ACK?(e.type=i?v.EVENT:v.ACK,this.reconstructor=new Id(e),e.attachments===0&&super.emitReserved("decoded",e)):super.emitReserved("decoded",e)}else if(On(n)||n.base64)if(this.reconstructor)e=this.reconstructor.takeBinaryData(n),e&&(this.reconstructor=null,super.emitReserved("decoded",e));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+n)}decodeString(n){let e=0;const i={type:Number(n.charAt(0))};if(v[i.type]===void 0)throw new Error("unknown packet type "+i.type);if(i.type===v.BINARY_EVENT||i.type===v.BINARY_ACK){const s=e+1;for(;n.charAt(++e)!=="-"&&e!=n.length;);const o=n.substring(s,e);if(o!=Number(o)||n.charAt(e)!=="-")throw new Error("Illegal attachments");i.attachments=Number(o)}if(n.charAt(e+1)==="/"){const s=e+1;for(;++e&&!(n.charAt(e)===","||e===n.length););i.nsp=n.substring(s,e)}else i.nsp="/";const r=n.charAt(e+1);if(r!==""&&Number(r)==r){const s=e+1;for(;++e;){const o=n.charAt(e);if(o==null||Number(o)!=o){--e;break}if(e===n.length)break}i.id=Number(n.substring(s,e+1))}if(n.charAt(++e)){const s=this.tryParse(n.substr(e));if(Rn.isPayloadValid(i.type,s))i.data=s;else throw new Error("invalid payload")}return i}tryParse(n){try{return JSON.parse(n,this.reviver)}catch{return!1}}static isPayloadValid(n,e){switch(n){case v.CONNECT:return Ci(e);case v.DISCONNECT:return e===void 0;case v.CONNECT_ERROR:return typeof e=="string"||Ci(e);case v.EVENT:case v.BINARY_EVENT:return Array.isArray(e)&&(typeof e[0]=="number"||typeof e[0]=="string"&&xd.indexOf(e[0])===-1);case v.ACK:case v.BINARY_ACK:return Array.isArray(e)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Id{constructor(n){this.packet=n,this.buffers=[],this.reconPack=n}takeBinaryData(n){if(this.buffers.push(n),this.buffers.length===this.reconPack.attachments){const e=kd(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const Td=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Rn,Encoder:Sd,get PacketType(){return v},protocol:Ad},Symbol.toStringTag,{value:"Module"}));function z(t,n,e){return t.on(n,e),function(){t.off(n,e)}}const Ed=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class js extends C{constructor(n,e,i){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=n,this.nsp=e,i&&i.auth&&(this.auth=i.auth),this._opts=Object.assign({},i),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const n=this.io;this.subs=[z(n,"open",this.onopen.bind(this)),z(n,"packet",this.onpacket.bind(this)),z(n,"error",this.onerror.bind(this)),z(n,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...n){return n.unshift("message"),this.emit.apply(this,n),this}emit(n,...e){if(Ed.hasOwnProperty(n))throw new Error('"'+n.toString()+'" is a reserved event name');if(e.unshift(n),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(e),this;const i={type:v.EVENT,data:e};if(i.options={},i.options.compress=this.flags.compress!==!1,typeof e[e.length-1]=="function"){const o=this.ids++,c=e.pop();this._registerAckCallback(o,c),i.id=o}const r=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return this.flags.volatile&&(!r||!this.connected)||(this.connected?(this.notifyOutgoingListeners(i),this.packet(i)):this.sendBuffer.push(i)),this.flags={},this}_registerAckCallback(n,e){var i;const r=(i=this.flags.timeout)!==null&&i!==void 0?i:this._opts.ackTimeout;if(r===void 0){this.acks[n]=e;return}const s=this.io.setTimeoutFn(()=>{delete this.acks[n];for(let c=0;c<this.sendBuffer.length;c++)this.sendBuffer[c].id===n&&this.sendBuffer.splice(c,1);e.call(this,new Error("operation has timed out"))},r),o=(...c)=>{this.io.clearTimeoutFn(s),e.apply(this,c)};o.withError=!0,this.acks[n]=o}emitWithAck(n,...e){return new Promise((i,r)=>{const s=(o,c)=>o?r(o):i(c);s.withError=!0,e.push(s),this.emit(n,...e)})}_addToQueue(n){let e;typeof n[n.length-1]=="function"&&(e=n.pop());const i={id:this._queueSeq++,tryCount:0,pending:!1,args:n,flags:Object.assign({fromQueue:!0},this.flags)};n.push((r,...s)=>i!==this._queue[0]?void 0:(r!==null?i.tryCount>this._opts.retries&&(this._queue.shift(),e&&e(r)):(this._queue.shift(),e&&e(null,...s)),i.pending=!1,this._drainQueue())),this._queue.push(i),this._drainQueue()}_drainQueue(n=!1){if(!this.connected||this._queue.length===0)return;const e=this._queue[0];e.pending&&!n||(e.pending=!0,e.tryCount++,this.flags=e.flags,this.emit.apply(this,e.args))}packet(n){n.nsp=this.nsp,this.io._packet(n)}onopen(){typeof this.auth=="function"?this.auth(n=>{this._sendConnectPacket(n)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(n){this.packet({type:v.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},n):n})}onerror(n){this.connected||this.emitReserved("connect_error",n)}onclose(n,e){this.connected=!1,delete this.id,this.emitReserved("disconnect",n,e),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(n=>{if(!this.sendBuffer.some(i=>String(i.id)===n)){const i=this.acks[n];delete this.acks[n],i.withError&&i.call(this,new Error("socket has been disconnected"))}})}onpacket(n){if(n.nsp===this.nsp)switch(n.type){case v.CONNECT:n.data&&n.data.sid?this.onconnect(n.data.sid,n.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case v.EVENT:case v.BINARY_EVENT:this.onevent(n);break;case v.ACK:case v.BINARY_ACK:this.onack(n);break;case v.DISCONNECT:this.ondisconnect();break;case v.CONNECT_ERROR:this.destroy();const i=new Error(n.data.message);i.data=n.data.data,this.emitReserved("connect_error",i);break}}onevent(n){const e=n.data||[];n.id!=null&&e.push(this.ack(n.id)),this.connected?this.emitEvent(e):this.receiveBuffer.push(Object.freeze(e))}emitEvent(n){if(this._anyListeners&&this._anyListeners.length){const e=this._anyListeners.slice();for(const i of e)i.apply(this,n)}super.emit.apply(this,n),this._pid&&n.length&&typeof n[n.length-1]=="string"&&(this._lastOffset=n[n.length-1])}ack(n){const e=this;let i=!1;return function(...r){i||(i=!0,e.packet({type:v.ACK,id:n,data:r}))}}onack(n){const e=this.acks[n.id];typeof e=="function"&&(delete this.acks[n.id],e.withError&&n.data.unshift(null),e.apply(this,n.data))}onconnect(n,e){this.id=n,this.recovered=e&&this._pid===e,this._pid=e,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(n=>this.emitEvent(n)),this.receiveBuffer=[],this.sendBuffer.forEach(n=>{this.notifyOutgoingListeners(n),this.packet(n)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(n=>n()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:v.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(n){return this.flags.compress=n,this}get volatile(){return this.flags.volatile=!0,this}timeout(n){return this.flags.timeout=n,this}onAny(n){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(n),this}prependAny(n){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(n),this}offAny(n){if(!this._anyListeners)return this;if(n){const e=this._anyListeners;for(let i=0;i<e.length;i++)if(n===e[i])return e.splice(i,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(n){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(n),this}prependAnyOutgoing(n){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(n),this}offAnyOutgoing(n){if(!this._anyOutgoingListeners)return this;if(n){const e=this._anyOutgoingListeners;for(let i=0;i<e.length;i++)if(n===e[i])return e.splice(i,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(n){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const e=this._anyOutgoingListeners.slice();for(const i of e)i.apply(this,n.data)}}}function $e(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}$e.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var n=Math.random(),e=Math.floor(n*this.jitter*t);t=Math.floor(n*10)&1?t+e:t-e}return Math.min(t,this.max)|0};$e.prototype.reset=function(){this.attempts=0};$e.prototype.setMin=function(t){this.ms=t};$e.prototype.setMax=function(t){this.max=t};$e.prototype.setJitter=function(t){this.jitter=t};class an extends C{constructor(n,e){var i;super(),this.nsps={},this.subs=[],n&&typeof n=="object"&&(e=n,n=void 0),e=e||{},e.path=e.path||"/socket.io",this.opts=e,Tt(this,e),this.reconnection(e.reconnection!==!1),this.reconnectionAttempts(e.reconnectionAttempts||1/0),this.reconnectionDelay(e.reconnectionDelay||1e3),this.reconnectionDelayMax(e.reconnectionDelayMax||5e3),this.randomizationFactor((i=e.randomizationFactor)!==null&&i!==void 0?i:.5),this.backoff=new $e({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(e.timeout==null?2e4:e.timeout),this._readyState="closed",this.uri=n;const r=e.parser||Td;this.encoder=new r.Encoder,this.decoder=new r.Decoder,this._autoConnect=e.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(n){return arguments.length?(this._reconnection=!!n,this):this._reconnection}reconnectionAttempts(n){return n===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=n,this)}reconnectionDelay(n){var e;return n===void 0?this._reconnectionDelay:(this._reconnectionDelay=n,(e=this.backoff)===null||e===void 0||e.setMin(n),this)}randomizationFactor(n){var e;return n===void 0?this._randomizationFactor:(this._randomizationFactor=n,(e=this.backoff)===null||e===void 0||e.setJitter(n),this)}reconnectionDelayMax(n){var e;return n===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=n,(e=this.backoff)===null||e===void 0||e.setMax(n),this)}timeout(n){return arguments.length?(this._timeout=n,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(n){if(~this._readyState.indexOf("open"))return this;this.engine=new Fs(this.uri,this.opts);const e=this.engine,i=this;this._readyState="opening",this.skipReconnect=!1;const r=z(e,"open",function(){i.onopen(),n&&n()}),s=c=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",c),n?n(c):this.maybeReconnectOnOpen()},o=z(e,"error",s);if(this._timeout!==!1){const c=this._timeout,l=this.setTimeoutFn(()=>{r(),s(new Error("timeout")),e.close()},c);this.opts.autoUnref&&l.unref(),this.subs.push(()=>{this.clearTimeoutFn(l)})}return this.subs.push(r),this.subs.push(o),this}connect(n){return this.open(n)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const n=this.engine;this.subs.push(z(n,"ping",this.onping.bind(this)),z(n,"data",this.ondata.bind(this)),z(n,"error",this.onerror.bind(this)),z(n,"close",this.onclose.bind(this)),z(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(n){try{this.decoder.add(n)}catch(e){this.onclose("parse error",e)}}ondecoded(n){Nn(()=>{this.emitReserved("packet",n)},this.setTimeoutFn)}onerror(n){this.emitReserved("error",n)}socket(n,e){let i=this.nsps[n];return i?this._autoConnect&&!i.active&&i.connect():(i=new js(this,n,e),this.nsps[n]=i),i}_destroy(n){const e=Object.keys(this.nsps);for(const i of e)if(this.nsps[i].active)return;this._close()}_packet(n){const e=this.encoder.encode(n);for(let i=0;i<e.length;i++)this.engine.write(e[i],n.options)}cleanup(){this.subs.forEach(n=>n()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close"),this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(n,e){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",n,e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const n=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const e=this.backoff.duration();this._reconnecting=!0;const i=this.setTimeoutFn(()=>{n.skipReconnect||(this.emitReserved("reconnect_attempt",n.backoff.attempts),!n.skipReconnect&&n.open(r=>{r?(n._reconnecting=!1,n.reconnect(),this.emitReserved("reconnect_error",r)):n.onreconnect()}))},e);this.opts.autoUnref&&i.unref(),this.subs.push(()=>{this.clearTimeoutFn(i)})}}onreconnect(){const n=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",n)}}const ke={};function Qe(t,n){typeof t=="object"&&(n=t,t=void 0),n=n||{};const e=gd(t,n.path||"/socket.io"),i=e.source,r=e.id,s=e.path,o=ke[r]&&s in ke[r].nsps,c=n.forceNew||n["force new connection"]||n.multiplex===!1||o;let l;return c?l=new an(i,n):(ke[r]||(ke[r]=new an(i,n)),l=ke[r]),e.query&&!n.query&&(n.query=e.queryKey),l.socket(e.path,n)}Object.assign(Qe,{Manager:an,Socket:js,io:Qe,connect:Qe});class Nd extends Xi{constructor(){super();a(this,"socket",Qe("http://localhost:3020",{autoConnect:!1,transports:["websocket"]}));a(this,"log",Y.extend("SocketManager"));a(this,"connected",!1);a(this,"ws");ne.watch(e=>{e.enabled&&e.preferApp?this.socket.open():this.socket.close()})}async init(e){this.log("Initializing"),this.socket.on("connect",()=>{this.connected=!0,this.emit("connected"),Bt.setValue(this.connected),this.send("getVersion"),this.log("Connected to app")}),this.socket.on("disconnect",()=>{this.connected=!1,this.emit("disconnected"),Bt.setValue(this.connected),e.currentPresence=void 0}),this.socket.on("receiveVersion",r=>{Zi.setValue(Number.parseInt(r))});const i=await ne.getValue();i.enabled&&i.preferApp&&(this.socket.open(),this.log("Connecting to app"))}send(e,i){this.socket.emit(e,i)}}class Od extends Xi{constructor(e){super();a(this,"connectedTabs",[]);a(this,"connectedIframes",[]);a(this,"currentTabPresence");a(this,"currentTabPresenceTimestamp");a(this,"currentTab");a(this,"switchTabTimeout");a(this,"injectionManager",new Kh);a(this,"analyticsManager");a(this,"activityManager");a(this,"socketManager",new Nd);a(this,"log",Y.extend("TabPriority"));a(this,"postUpdateDataInterval");a(this,"tabToSwitchTo");this.pmd=e,this.activityManager=new Ph(e.oAuthManager,this.socketManager,e.websocketManager,e.sessionKeepAlive),this.socketManager.init(this.activityManager),this.analyticsManager=new Bh(e),I.tabs.onActivated.addListener(this.onActivated.bind(this)),I.tabs.onRemoved.addListener(this.onRemoved.bind(this)),I.tabs.onUpdated.addListener(this.onUpdated.bind(this)),I.windows.onFocusChanged.addListener(this.onWindowFocusChanged.bind(this)),this.pmd.presenceManager.on("remove",i=>{var r;i.service===((r=this.currentTabPresence)==null?void 0:r.service)&&this.electNewTab()}),ne.watch(async(i,r)=>{(r==null?void 0:r.enabled)===void 0||(i==null?void 0:i.enabled)===void 0||i.enabled!==r.enabled&&(this.log("Enabled changed to %s",i.enabled),i.enabled||await this.activityManager.clearActivity())}),this.pmd.storageManager.on("presenceEnableDisable",async(i,r)=>{var s;if(r&&!this.currentTab||!r&&((s=this.currentTabPresence)==null?void 0:s.service)===i)this.log("Presence %s %s, electing new tab",i,r?"enabled":"disabled"),this.electNewTab();else{const o=await this.activeTab();o&&await this.injectionManager.getPresenceForTab(o,this.pmd.presenceManager)&&(this.log("Presence %s %s, updating tab",i,r?"enabled":"disabled"),this.startTimeout())}}),I.runtime.onConnect.addListener(async i=>{var c,l,u,h,f;if(!((c=i.sender)!=null&&c.tab))return;if(i.name==="iFrame"){if(this.connectedIframes.push(i),i.onMessage.addListener((w,x)=>{var M;(M=this.connectedTabs.find(R=>{var k,A,G,Pe;return((A=(k=R.sender)==null?void 0:k.tab)==null?void 0:A.id)===((Pe=(G=x.sender)==null?void 0:G.tab)==null?void 0:Pe.id)}))==null||M.postMessage({data:w,event:"iFrameData"})}),i.onDisconnect.addListener(()=>{var x;if(!((x=i.sender)!=null&&x.frameId))return;const w=i.sender.frameId;this.connectedIframes=this.connectedIframes.filter(M=>{var R;return((R=M.sender)==null?void 0:R.frameId)!==w})}),!((l=i.sender)!=null&&l.frameId))return;const y=await this.injectionManager.getPresenceForiFrame(i.sender.tab,i.sender.frameId,this.pmd.presenceManager);if(!y)return;this.injectionManager.injectiFrame(i.sender.tab,i.sender.frameId,y.presence,y.iframeUrl)}if(i.name!=="contentScript")return;i.onMessage.addListener((y,w)=>this.onPortMessage(y,w)),this.log("ContentScript connected: %s",i.sender.tab.id);const r=await this.injectionManager.getPresenceForTab(i.sender.tab,this.pmd.presenceManager),s=r==null?void 0:r.service;s&&await this.pmd.languageManager.fetchPresenceStrings(s),this.connectedTabs.push(i);const o=await this.activeTab();!this.currentTab&&o?this.switchTabPriority(o):((h=(u=i.sender)==null?void 0:u.tab)==null?void 0:h.id)===((f=this.currentTab)==null?void 0:f.id)?this.stopTimeout():this.startTimeout(),i.onDisconnect.addListener(async()=>{var w,x,M,R;if(!((x=(w=i.sender)==null?void 0:w.tab)!=null&&x.id))return;const y=i.sender.tab;if(this.log("ContentScript disconnected: %s",y.id),this.connectedTabs=this.connectedTabs.filter(k=>{var A,G;return((G=(A=k.sender)==null?void 0:A.tab)==null?void 0:G.id)!==y.id}),i.sender.tab.id===((M=this.currentTab)==null?void 0:M.id)){const k=await I.tabs.get(y.id).catch(()=>{}),A=k?await this.injectionManager.getPresenceForTab(k,this.pmd.presenceManager):void 0;if(k&&A&&A.service===((R=this.currentTabPresence)==null?void 0:R.service)){this.log("port disconnected, same presence is still on tab, not switching"),this.activityManager.currentPresence=void 0;return}this.log("port disconnected, electing new tab"),this.currentTab=void 0,await this.electNewTab()}})}),this.postUpdateDataInterval=setInterval(this.postUpdateData.bind(this),100),this.on("tabPrioritySwitch",()=>{this.analyticsManager.sendHeartbeat()})}async onPortMessage(e,i){var r,s,o;if(((s=(r=i.sender)==null?void 0:r.tab)==null?void 0:s.id)===((o=this.currentTab)==null?void 0:o.id))switch(e.event){case"setActivity":return this.activityManager.setActivity(e.data);case"clearActivity":return this.activityManager.clearActivity();default:this.log(e,i.sender)}}async onWindowFocusChanged(){const e=await this.activeTab();if(e)return this.onActivated(e)}async onActivated(e){var r;if(e&&((r=this.currentTab)==null?void 0:r.id)===("tabId"in e?e.tabId:e.id))return this.stopTimeout();const i=await this.activeTab();if(i){if(!this.currentTab)return this.switchTabPriority(i);if(await this.injectionManager.getPresenceForTab(i,this.pmd.presenceManager))return this.startTimeout()}}async onRemoved(e){var i;((i=this.tabToSwitchTo)==null?void 0:i.id)===e&&this.stopTimeout()}async onUpdated(e,i,r){if(i.status!=="loading"||!r.url||await this.injectionManager.tabHasPresence(this,r)||!await this.injectionManager.getPresenceForTab(r,this.pmd.presenceManager))return;if(!this.currentTab||this.currentTab.id===e)return this.switchTabPriority(r);const o=await this.activeTab();if(!(!o||o.id!==e))return this.startTimeout()}async stopUpdateData(){this.log("Stopping update data");const e=this.connectedTabs.find(i=>{var r,s,o;return((s=(r=i.sender)==null?void 0:r.tab)==null?void 0:s.id)===((o=this.currentTab)==null?void 0:o.id)});e==null||e.postMessage({event:"StopUpdateData"})}async switchTabPriority(e){var r;if(!e)return;const i=await this.injectionManager.getPresenceForTab(e,this.pmd.presenceManager);i&&(this.injectionManager.injectPresence(this,e,i),await this.stopUpdateData(),((r=this.currentTabPresence)==null?void 0:r.service)!==i.service&&await this.activityManager.clearActivity(),this.currentTabPresence=i,this.currentTabPresenceTimestamp=Date.now(),await Mn.setValue({presence:this.currentTabPresence.service,since:this.currentTabPresenceTimestamp}),this.currentTab=e,this.emit("tabPrioritySwitch",e),this.log("Switching tab priority to tabId: %s",e.id))}async postUpdateData(){const{enabled:e}=await ne.getValue();if(!e||!this.currentTab)return;const i=this.connectedTabs.find(r=>{var s,o,c;return((o=(s=r.sender)==null?void 0:s.tab)==null?void 0:o.id)===((c=this.currentTab)==null?void 0:c.id)});if(i){for(const r of this.connectedIframes.filter(s=>s.sender.tab.id===i.sender.tab.id))r.postMessage({event:"updateData"});i.postMessage({event:"updateData"})}}async startTimeout(){var i;const e=await this.activeTab();e&&((i=this.tabToSwitchTo)==null?void 0:i.id)!==e.id&&(this.stopTimeout(),this.log("Starting timeout"),this.tabToSwitchTo=e,this.switchTabTimeout=setTimeout(()=>{this.switchTabTimeout=void 0,this.switchTabPriority(e)},5e3))}stopTimeout(){this.tabToSwitchTo=void 0,this.switchTabTimeout&&(clearTimeout(this.switchTabTimeout),this.switchTabTimeout=void 0,this.log("Stopped timeout"))}async activeTab(){const e=await I.tabs.query({active:!0,currentWindow:!0});return e==null?void 0:e[0]}async electNewTab(){this.log("Electing new tab");const e=await this.activeTab();if(e&&await this.injectionManager.getPresenceForTab(e,this.pmd.presenceManager))return this.switchTabPriority(e);let i=await I.tabs.query({discarded:!1});i=i.sort((s,o)=>s.index-o.index);const r="LTR";switch(this.log("Electing new tab using setting: %s",r),r){case"RTL":i=i.reverse();break;case"RDM":{const s=await Promise.all(i.map(async o=>await this.injectionManager.getPresenceForTab(o,this.pmd.presenceManager)?o:void 0));i=[Do(s.filter(o=>!!o))];break}}for(const s of i)if(await this.injectionManager.getPresenceForTab(s,this.pmd.presenceManager))return this.switchTabPriority(s);this.log("No tab found"),await this.stopUpdateData(),this.currentTab=void 0,this.currentTabPresence=void 0,this.currentTabPresenceTimestamp=void 0,await Mn.removeValue(),await this.activityManager.clearActivity(),this.emit("tabPrioritySwitch",null)}}class Rd{constructor(){a(this,"log",Y.extend("WebSocketManager"));a(this,"socket",null);a(this,"onOpenCalls",[]);a(this,"featureFlags",new un)}async init(n=!1){var r;if(!await this.featureFlags.get("WebSocketManager")||!n&&this.socket)return;(r=this.socket)==null||r.close(1e3),this.socket=new WebSocket(so),this.socket.onopen=this.onOpen.bind(this),this.socket.onclose=this.onClose.bind(this),this.socket.onerror=this.onError.bind(this);const e=await Gi.getValue();e&&"token"in e&&this.send({type:"token",expires:e.expires,token:e.token});const i=await Yi.getValue();i&&this.send({type:"session",token:i.token})}onOpen(){this.log("WebSocket connection opened"),this.onOpenCalls.forEach(n=>n()),this.onOpenCalls=[]}onClose(n){if(n.code===1e3){this.log("WebSocket connection closed gracefully");return}setTimeout(()=>{this.log("WebSocket connection closed, attempting to reconnect to WebSocket",n),this.init(!0)},2500)}onError(n){this.log("WebSocket error",n)}async send(n){var e;if(!(!this.socket||!await this.featureFlags.get("WebSocketManager"))&&[this.socket.OPEN,this.socket.CONNECTING].includes(this.socket.readyState)){if(this.socket.readyState===this.socket.CONNECTING){this.onOpenCalls.push(()=>{var i;return(i=this.socket)==null?void 0:i.send(JSON.stringify(n))});return}(e=this.socket)==null||e.send(JSON.stringify(n))}}close(){var n;(n=this.socket)==null||n.close(1e3)}}const Dd=ho({main(){new un().startPolling(),uo();try{oo.setValue("510865a");const n=new po,e=new Rd,i=new ao(e,n),r=new Od(i);i.initBackground(r),globalThis.pmd=i}catch(n){globalThis.sentryScope.captureException(n)}},persistent:!0,type:"module"});function Ve(t,...n){}const Cd={debug:(...t)=>Ve(console.debug,...t),log:(...t)=>Ve(console.log,...t),warn:(...t)=>Ve(console.warn,...t),error:(...t)=>Ve(console.error,...t)};let Mi;try{co(),Mi=Dd.main(),Mi instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(t){throw Cd.error("The background crashed on startup!"),t}
//# sourceMappingURL=background.js.map
